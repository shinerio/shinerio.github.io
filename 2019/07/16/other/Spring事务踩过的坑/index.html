<!DOCTYPE html>
<html lang="zh-cn">
  <head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8">
<!-- hexo-inject:begin --><!-- hexo-inject:end --><meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">

<meta name="theme-color" content="#f8f5ec">
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">

<meta name="description" content="Spring事务踩过的坑"><meta name="keywords" content="java, debug, Spring, shinerio's blog"><link rel="alternate" href="/atom.xml" title="shinerio's blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.11.0">
<link rel="canonical" href="https://shinerio.cc/2019/07/16/other/Spring事务踩过的坑/">

<link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css"><script type="text/x-mathjax-config">
    MathJax.Hub.Config({ tex2jax: { inlineMath: [['$','$'], ['\\(','\\)']] } });
  </script>
  <script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.11.0">

<script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":"","latex":true};
</script>

    <title>Spring事务踩过的坑 - shinerio's blog</title><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="mobile-header-logo">
    <a href="/." class="logo">shinerio's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list"><a href="/">
        <li class="mobile-menu-item">首页
          </li>
      </a><a href="/archives/">
        <li class="mobile-menu-item">归档
          </li>
      </a><a href="/tags">
        <li class="mobile-menu-item">标签
          </li>
      </a><a href="/categories">
        <li class="mobile-menu-item">分类
          </li>
      </a></ul>
</nav>
<div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">shinerio's blog</a>
</div>

<nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item">
          <a class="menu-item-link" href="/">
            首页
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            归档
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/tags">
            标签
            </a>
        </li>
      <li class="menu-item">
          <a class="menu-item-link" href="/categories">
            分类
            </a>
        </li>
      </ul></nav>
</header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content"><article class="post">
    <header class="post-header">
      <h1 class="post-title">Spring事务踩过的坑
        </h1>

      <div class="post-meta">
        <span class="post-time">
          2019-07-16
        </span><span class="post-category">
            <a href="/categories/other/">other</a>
            </span>
        </div>
    </header>

    <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#问题描述"><span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#问题解决-一"><span class="toc-text">问题解决(一)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-常见的JDBC事务提交方式"><span class="toc-text">1. 常见的JDBC事务提交方式:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-代理模式"><span class="toc-text">2. 代理模式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Spring-AOP"><span class="toc-text">3. Spring AOP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-修正"><span class="toc-text">4. 修正</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#问题解决-二"><span class="toc-text">问题解决(二)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-问题排查"><span class="toc-text">1. 问题排查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-TransactionManager、SessionFactory、DataSource"><span class="toc-text">2. TransactionManager、SessionFactory、DataSource</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-发现问题"><span class="toc-text">3. 发现问题</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#解决方案"><span class="toc-text">解决方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-text">总结</span></a></li></ol>
    </div>
  </div><div class="post-content"><h1 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h1><p>项目中需要对一批数据进行批量拷贝，拷贝过程出现了异常，但是数据并没有进行回滚。</p>
<p>脱敏代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span></span>&#123;</span><br><span class="line">	<span class="meta">@AutoWired</span></span><br><span class="line">	<span class="keyword">private</span> Myhandler myhandler;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBatch</span><span class="params">()</span></span>&#123;</span><br><span class="line">		MyContext myContext = applicationContext.getBean(MyContext.class);</span><br><span class="line">		myhandler.saveBatch(myContext);	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBathch</span><span class="params">(MyContext myContext)</span></span>&#123;</span><br><span class="line">			init(myContext);</span><br><span class="line">			build(myContext);</span><br><span class="line">			commit(myContext);</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(MyContext myContext)</span></span>&#123;...&#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(MyContext myContext)</span></span>&#123;...&#125;</span><br><span class="line">  <span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">(MyContext myContext)</span></span>&#123;...&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<a id="more"></a>
<h1 id="问题解决-一"><a href="#问题解决-一" class="headerlink" title="问题解决(一)"></a>问题解决(一)</h1><h2 id="1-常见的JDBC事务提交方式"><a href="#1-常见的JDBC事务提交方式" class="headerlink" title="1. 常见的JDBC事务提交方式:"></a>1. 常见的JDBC事务提交方式:</h2><ul>
<li>设置数据库事务为非自动提交</li>
<li>执行sql</li>
<li>成功commit，异常rollback</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">conn.setAutoCommit(<span class="keyword">false</span>); <span class="comment">// 取消自动提交</span></span><br><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">	* 执行sql</span></span><br><span class="line"><span class="comment">	**/</span></span><br><span class="line">  conn.commit(); <span class="comment">// 提交事务</span></span><br><span class="line">&#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">  <span class="comment">//如果发生错误</span></span><br><span class="line">	conn.rollback();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="2-代理模式"><a href="#2-代理模式" class="headerlink" title="2. 代理模式"></a>2. 代理模式</h2><p>事务本身是一些通用且固定化的功能，如何避免在业务代码逻辑中都重复上面的步骤呢？一个很简单直接的解决思路就是使用代理模式，业务代码关注于核心逻辑，事务和业务分离，通过代理模式的方式对业务代码进行二次封装。Java中常见的代理模式有三种，静态代理，基于JDK的动态代理，基于CGLIB的动态代理。对于静态代理来说，我们需要为每个被代理类生成一个代理类，编码工作巨大，故不适用。使用JDK动态代理和CGLIB动态代理，可以在程序运行，生成字节码的时候动态生成代理类，关于这三者的详细区别这里不再赘述。</p>
<h2 id="3-Spring-AOP"><a href="#3-Spring-AOP" class="headerlink" title="3. Spring AOP"></a>3. Spring AOP</h2><p>Spring使用AOP的思想实现方法的切入，本质也是代理模式的一种实践，主要使用了JDK动态代理和CGLIB代理。Spring通过AOP的方式切入方法执行过程，对于使用<code>@Transactional</code> 注解的方法，Spring使用TransactionManager进行管理，在方法执行前开启事务，在方法执行成功后进行Commit，方法执行出现异常时进行回滚。</p>
<h2 id="4-修正"><a href="#4-修正" class="headerlink" title="4. 修正"></a>4. 修正</h2><p>了解了Spring的原理这个问题其实就很好解决了，Spring使用AOP切面的方式管理事务，要想被Spring AOP切面的前提是使用了Spring的另一个特性IOC。一个对象只有通过IOC的方式被Spring管理，Spring才有能力接管对象生命周期，控制对象行为能力。<strong>回顾一开始的代码，service调用来handler的public方法saveBatch，此方法会进行一些数据初始化和构建工作，然后调用事务方法commit进行事务执行，Spring通过了代理的方式来执行saveBatch，而对于被代理方法内部的细节其实是透明执行的，也就是说saveBatch内部的commit方法本身是通过被代理类来调用的，而不是代理类，也就是说Spring对于commit方法的调用不能实现AOP的拦截，无法实现代理，事务也就自然失效了，所以同一类中方法的调用，事务会失效。</strong>实际进行调试过程中，我们可以发现MyHandler的saveBatch中的this指针是MyHandler本身，debug时通过step into commit方法时，实际执行commit方法主体是myHandler实例，而不是MyHandler的增强代理对象实例，所以自然无法被AOP切面，实现事务功能。</p>
<blockquote>
<p>这里附带讲一个小细节，saveBatch方法不光是涉及到数据的存储，在数据存储之前需要进行大量的数据库查询以及数据构建工作，事务本身是一件资源占用比较严重的行为，所以能不用事务就不用事务，通过将一些查询和构建工作放到init和build方法中，将数据缓存在context中，通过commit方法进行集中提交，可以较少事务的力度，提高事务的效率。</p>
</blockquote>
<p>了解了问题发生的原因，我们可以修改代码如下，将commit方法转移到MyContext中，这个saveBatch方法在调用被Spring管理的另一个类MyContext时，Spring可以通过AOP的方式切入到commit方法中执行事务。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span></span>&#123;</span><br><span class="line">	<span class="meta">@AutoWired</span></span><br><span class="line">	<span class="keyword">private</span> Myhandler myhandler;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBatch</span><span class="params">()</span></span>&#123;</span><br><span class="line">		MyContext myContext = applicationContext.getBean(MyContext.class);</span><br><span class="line">		myhandler.saveBatch(myContext);	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBathch</span><span class="params">(MyContext myContext)</span></span>&#123;</span><br><span class="line">			init(myContext);</span><br><span class="line">			build(myContext);</span><br><span class="line">			myContext.commit();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(MyContext myContext)</span></span>&#123;...&#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(MyContext myContext)</span></span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope</span>(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyContext</span></span>&#123;</span><br><span class="line">   <span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commiy</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	<span class="comment">//这里调用dao的方法将数据批量入库</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="问题解决-二"><a href="#问题解决-二" class="headerlink" title="问题解决(二)"></a>问题解决(二)</h1><h2 id="1-问题排查"><a href="#1-问题排查" class="headerlink" title="1. 问题排查"></a>1. 问题排查</h2><p>正常情况下，此时Spring事务到此应该是可以生效的，但是<strong>本项目中还存在另一个大坑</strong>。如果你觉得一个@Transactional注解就可以管理事务了，那么你就too young too simple，我们项目中的坑就是这么来的。</p>
<p>下面我们通过单步调试方式来分析。首先，commit方法正常进入了代理类内部执行逻辑，此时this指向<code>CglibAopProxy$DynamicAdvisedIntereptor</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">intercept</span><span class="params">(Object proxy, Method method, Object[] args, MethodProxy methodProxy)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  Object oldProxy = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">boolean</span> setProxyContext = <span class="keyword">false</span>;</span><br><span class="line">  Class&lt;?&gt; targetClass = <span class="keyword">null</span>;</span><br><span class="line">  Object target = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  Object var15;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.advised.exposeProxy) &#123;</span><br><span class="line">      oldProxy = AopContext.setCurrentProxy(proxy);</span><br><span class="line">      setProxyContext = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 获取被代理类</span></span><br><span class="line">    target = <span class="keyword">this</span>.getTarget();</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">      targetClass = target.getClass();</span><br><span class="line">    &#125;     </span><br><span class="line">    <span class="comment">// 获取代理方法需要代理执行的interceptors，使用@Transaction声明了一个事务拦截器</span></span><br><span class="line">    <span class="comment">// chain = [TransactionInterceptor]</span></span><br><span class="line">    List&lt;Object&gt; chain = <span class="keyword">this</span>.advised.getInterceptorsAndDynamicInterceptionAdvice(method, targetClass);</span><br><span class="line">    Object retVal;</span><br><span class="line">    <span class="comment">// 对于普通方法来说，直接执行被代理方法</span></span><br><span class="line">    <span class="keyword">if</span> (chain.isEmpty() &amp;&amp; Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">      Object[] argsToUse = AopProxyUtils.adaptArgumentsIfNecessary(method, args);</span><br><span class="line">      retVal = methodProxy.invoke(target, argsToUse);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 对于需要进行切面处理的方法，通过代理类使用链式方法来执行，代理类持有chain</span></span><br><span class="line">      retVal = (<span class="keyword">new</span> CglibAopProxy.CglibMethodInvocation(proxy, target, method, args, targetClass, chain, methodProxy)).proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    retVal = CglibAopProxy.processReturnType(proxy, target, method, retVal);</span><br><span class="line">    var15 = retVal;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.releaseTarget(target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setProxyContext) &#123;</span><br><span class="line">      AopContext.setCurrentProxy(oldProxy);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> var15;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理类执行方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.springframework.aop.framework.ReflectiveMethodInvocation.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">proceed</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span></span><br><span class="line"><span class="function">		<span class="comment">// 执行完chain中所有interceptor，调用真正被代理类方法</span></span></span><br><span class="line"><span class="function">    <span class="title">if</span> <span class="params">(<span class="keyword">this</span>.currentInterceptorIndex == <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.size()</span> - 1) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.invokeJoinpoint();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    		<span class="comment">// 获取chain中下一个interceptor</span></span><br><span class="line">        Object interceptorOrInterceptionAdvice = <span class="keyword">this</span>.interceptorsAndDynamicMethodMatchers.get(++<span class="keyword">this</span>.currentInterceptorIndex);</span><br><span class="line">        <span class="keyword">if</span> (interceptorOrInterceptionAdvice <span class="keyword">instanceof</span> InterceptorAndDynamicMethodMatcher) &#123;</span><br><span class="line">            InterceptorAndDynamicMethodMatcher dm = (InterceptorAndDynamicMethodMatcher)interceptorOrInterceptionAdvice;</span><br><span class="line">            <span class="keyword">return</span> dm.methodMatcher.matches(<span class="keyword">this</span>.method, <span class="keyword">this</span>.targetClass, <span class="keyword">this</span>.arguments) ? dm.interceptor.invoke(<span class="keyword">this</span>) : <span class="keyword">this</span>.proceed();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> ((MethodInterceptor)interceptorOrInterceptionAdvice).invoke(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于TransactionInterceptor，<code>((MethodInterceptor)interceptorOrInterceptionAdvice).invoke(this)</code>方法进入TransactioInterceptor内部<code>invoke方法</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(<span class="keyword">final</span> MethodInvocation invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  Class&lt;?&gt; targetClass = invocation.getThis() != <span class="keyword">null</span> ? AopUtils.getTargetClass(invocation.getThis()) : <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// 通过事务的方式来执行方法</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.invokeWithinTransaction(invocation.getMethod(), targetClass, <span class="keyword">new</span> InvocationCallback() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">proceedWithInvocation</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">invokeWithinTransaction</span><span class="params">(Method method, Class&lt;?&gt; targetClass, <span class="keyword">final</span> TransactionAspectSupport.InvocationCallback invocation)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  <span class="comment">// TransactionAttribute的实现中存储了注解中的信息，包括rollback，qualifier，descriptor(方法描述)</span></span><br><span class="line">  <span class="keyword">final</span> TransactionAttribute txAttr = <span class="keyword">this</span>.getTransactionAttributeSource().getTransactionAttribute(method, targetClass);</span><br><span class="line">  <span class="comment">// 获得TransactionManager，实际的事务管理器</span></span><br><span class="line">  <span class="keyword">final</span> PlatformTransactionManager tm = <span class="keyword">this</span>.determineTransactionManager(txAttr);</span><br><span class="line">  <span class="keyword">final</span> String joinpointIdentification = <span class="keyword">this</span>.methodIdentification(method, targetClass, txAttr);</span><br><span class="line">  Object result;</span><br><span class="line">  <span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; tm <span class="keyword">instanceof</span> CallbackPreferringPlatformTransactionManager) &#123;</span><br><span class="line">    <span class="keyword">final</span> TransactionAspectSupport.ThrowableHolder throwableHolder = <span class="keyword">new</span> TransactionAspectSupport.ThrowableHolder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = ((CallbackPreferringPlatformTransactionManager)tm).execute(txAttr, <span class="keyword">new</span> TransactionCallback&lt;Object&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">doInTransaction</span><span class="params">(TransactionStatus status)</span> </span>&#123;</span><br><span class="line">          TransactionAspectSupport.TransactionInfo txInfo = TransactionAspectSupport.<span class="keyword">this</span>.prepareTransactionInfo(tm, txAttr, joinpointIdentification, status);</span><br><span class="line"></span><br><span class="line">          Object var4;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            Object var3 = invocation.proceedWithInvocation();</span><br><span class="line">            <span class="keyword">return</span> var3;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (Throwable var8) &#123;</span><br><span class="line">            <span class="keyword">if</span> (txAttr.rollbackOn(var8)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (var8 <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException)var8;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> TransactionAspectSupport.ThrowableHolderException(var8);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            throwableHolder.throwable = var8;</span><br><span class="line">            var4 = <span class="keyword">null</span>;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            TransactionAspectSupport.<span class="keyword">this</span>.cleanupTransactionInfo(txInfo);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> var4;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> throwableHolder.throwable;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransactionAspectSupport.ThrowableHolderException var18) &#123;</span><br><span class="line">      <span class="keyword">throw</span> var18.getCause();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TransactionSystemException var19) &#123;</span><br><span class="line">      <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.error(<span class="string">"Application exception overridden by commit exception"</span>, throwableHolder.throwable);</span><br><span class="line">        var19.initApplicationException(throwableHolder.throwable);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> var19;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var20) &#123;</span><br><span class="line">      <span class="keyword">if</span> (throwableHolder.throwable != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.logger.error(<span class="string">"Application exception overridden by commit exception"</span>, throwableHolder.throwable);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">throw</span> var20;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 开启事务</span></span><br><span class="line">    TransactionAspectSupport.TransactionInfo txInfo = <span class="keyword">this</span>.createTransactionIfNecessary(tm, txAttr, joinpointIdentification);</span><br><span class="line">    result = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 执行被代理方法</span></span><br><span class="line">      result = invocation.proceedWithInvocation();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable var16) &#123;</span><br><span class="line">      <span class="comment">// 异常回滚</span></span><br><span class="line">      <span class="keyword">this</span>.completeTransactionAfterThrowing(txInfo, var16);</span><br><span class="line">      <span class="keyword">throw</span> var16;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// 清理事务</span></span><br><span class="line">      <span class="keyword">this</span>.cleanupTransactionInfo(txInfo);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 提交事务</span></span><br><span class="line">    <span class="keyword">this</span>.commitTransactionAfterReturning(txInfo);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调试过程中发现，commit发生发生异常时，确实进入了completeTransactionAfterThrowing方法中，并且执行了rollback方法，按理说异常数据应该被回滚了，<strong>但是！！！数据并没有回滚，而是被commit了</strong></p>
<h2 id="2-TransactionManager、SessionFactory、DataSource"><a href="#2-TransactionManager、SessionFactory、DataSource" class="headerlink" title="2. TransactionManager、SessionFactory、DataSource"></a>2. TransactionManager、SessionFactory、DataSource</h2><p>他们三者都是一对一的关系，一个SessionFactory管理一个DataSource的session，一个TransactionManager管理一个DataSource的事务。</p>
<ul>
<li><p>DataSource</p>
<p>DataSource中维护了数据库连接的一些信息，指定了数据源</p>
</li>
<li><p>SessionFactory</p>
<p>SessionFactory用来维护数据库连接中的会话，充当DataSource的代理。</p>
</li>
<li><p>TransactionManager</p>
<p>管理实务，负责事务的begin，commit和rollback</p>
</li>
</ul>
<h2 id="3-发现问题"><a href="#3-发现问题" class="headerlink" title="3. 发现问题"></a>3. 发现问题</h2><p>既然事务的主体是<code>TransactionManager</code>， 那么我们就深入分析它。TransactionManager中持有DataSource数据源，调时过程发现DataSource数据源为<code>DemoADataSource</code>，问题出现了，实际我们我们操作的数据源应该是<code>DemoBDataSource</code>。查询项目配置，项目配置了多数据源，存在两份<code>DataSourceConfig</code> , 也就是项目中存在两组<code>DataSoure-SessionFactory-TransactionManager</code> 。问题出现了，项目有两个TransactionManger，Spring如何知道方法上应该使用哪一个TransactionManger呢。</p>
<p>TransactionInterceptor源码中发现通过<code>final PlatformTransactionManager tm = this.determineTransactionManager(txAttr)</code> 获得TransactionManager。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> PlatformTransactionManager <span class="title">determineTransactionManager</span><span class="params">(TransactionAttribute txAttr)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; <span class="keyword">this</span>.beanFactory != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 获得qualifier</span></span><br><span class="line">    String qualifier = txAttr.getQualifier();</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.hasText(qualifier)) &#123;</span><br><span class="line">      <span class="comment">// 根据qulifier名称决定使用哪一个TransactionManager</span></span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.determineQualifiedTransactionManager(qualifier);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.hasText(<span class="keyword">this</span>.transactionManagerBeanName)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.determineQualifiedTransactionManager(<span class="keyword">this</span>.transactionManagerBeanName);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 如果qulifier为空，使用defaultTransactionManager</span></span><br><span class="line">      PlatformTransactionManager defaultTransactionManager = <span class="keyword">this</span>.getTransactionManager();</span><br><span class="line">      <span class="keyword">if</span> (defaultTransactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">        defaultTransactionManager = (PlatformTransactionManager)<span class="keyword">this</span>.transactionManagerCache.get(DEFAULT_TRANSACTION_MANAGER_KEY);</span><br><span class="line">        <span class="keyword">if</span> (defaultTransactionManager == <span class="keyword">null</span>) &#123;</span><br><span class="line">          defaultTransactionManager = (PlatformTransactionManager)<span class="keyword">this</span>.beanFactory.getBean(PlatformTransactionManager.class);</span><br><span class="line">          <span class="keyword">this</span>.transactionManagerCache.putIfAbsent(DEFAULT_TRANSACTION_MANAGER_KEY, defaultTransactionManager);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> defaultTransactionManager;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getTransactionManager();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>所以问题的关键是如何设置qualifier！！！</strong></p>
<p>qualifier是从TransactionAttribute中获得的，TransactionAttribute通过<code>final TransactionAttribute txAttr = this.getTransactionAttributeSource().getTransactionAttribute(method, targetClass)</code>得到。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//org.springframework.transaction.interceptor.AbstractFallbackTransactionAttributeSource.java</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Object, TransactionAttribute&gt; attributeCache = <span class="keyword">new</span> ConcurrentHashMap(<span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> TransactionAttribute <span class="title">getTransactionAttribute</span><span class="params">(Method method, Class&lt;?&gt; targetClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 使用被代理类的被代理方法生成key，从attributeCache中获得TransactionAttribute，TransactionAttribute中包括rollback，qualifier，descriptor(方法描述)等信息</span></span><br><span class="line">    Object cacheKey = <span class="keyword">this</span>.getCacheKey(method, targetClass);</span><br><span class="line">    Object cached = <span class="keyword">this</span>.attributeCache.get(cacheKey);</span><br><span class="line">    <span class="keyword">if</span> (cached != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> cached == NULL_TRANSACTION_ATTRIBUTE ? <span class="keyword">null</span> : (TransactionAttribute)cached;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      TransactionAttribute txAttr = <span class="keyword">this</span>.computeTransactionAttribute(method, targetClass);</span><br><span class="line">      <span class="keyword">if</span> (txAttr == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.attributeCache.put(cacheKey, NULL_TRANSACTION_ATTRIBUTE);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        String methodIdentification = ClassUtils.getQualifiedMethodName(method, targetClass);</span><br><span class="line">        <span class="keyword">if</span> (txAttr <span class="keyword">instanceof</span> DefaultTransactionAttribute) &#123;</span><br><span class="line">          ((DefaultTransactionAttribute)txAttr).setDescriptor(methodIdentification);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.logger.isDebugEnabled()) &#123;</span><br><span class="line">          <span class="keyword">this</span>.logger.debug(<span class="string">"Adding transactional method '"</span> + methodIdentification + <span class="string">"' with attribute: "</span> + txAttr);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.attributeCache.put(cacheKey, txAttr);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> txAttr;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 计算TransactionAttribute并放入Map中</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> TransactionAttribute <span class="title">computeTransactionAttribute</span><span class="params">(Method method, Class&lt;?&gt; targetClass)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.allowPublicMethodsOnly() &amp;&amp; !Modifier.isPublic(method.getModifiers())) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    Class&lt;?&gt; userClass = ClassUtils.getUserClass(targetClass);</span><br><span class="line">    Method specificMethod = ClassUtils.getMostSpecificMethod(method, userClass);</span><br><span class="line">    specificMethod = BridgeMethodResolver.findBridgedMethod(specificMethod);</span><br><span class="line">    TransactionAttribute txAttr = <span class="keyword">this</span>.findTransactionAttribute(specificMethod);</span><br><span class="line">    <span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> txAttr;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 从方法的注解中获得信息，从@Transcatio注解中的value获得qualifier的值</span></span><br><span class="line">      txAttr = <span class="keyword">this</span>.findTransactionAttribute(specificMethod.getDeclaringClass());</span><br><span class="line">      <span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">        <span class="keyword">return</span> txAttr;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (specificMethod != method) &#123;</span><br><span class="line">          txAttr = <span class="keyword">this</span>.findTransactionAttribute(method);</span><br><span class="line">          <span class="keyword">if</span> (txAttr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> txAttr;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          txAttr = <span class="keyword">this</span>.findTransactionAttribute(method.getDeclaringClass());</span><br><span class="line">          <span class="keyword">if</span> (txAttr != <span class="keyword">null</span> &amp;&amp; ClassUtils.isUserLevelMethod(method)) &#123;</span><br><span class="line">            <span class="keyword">return</span> txAttr;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>问题到这里就差不多解决了，Spring根据@Transaction的value值设置qualifier，继而决定使用哪一个TransactionManager。问题的出现是我们没有设置value值，Spring默认选择使用了defaultTransactionManager，defaultTransactionManager由声明顺序决定，第一个声明的TransactionManager就是default，项目中DemoA设置在前，所以在不指定value的情况下使用了demoATransactionManager，和需要操作的数据源demoBDataSource不匹配，自然也就无法管理事务，回滚异常也是自然的。</p>
<h1 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h1><p>指定使用demoBTranscationManager，问题的解决很简单，但是背后的原理以及排查过程却是充满挑战且有意义的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyService</span></span>&#123;</span><br><span class="line">	<span class="meta">@AutoWired</span></span><br><span class="line">	<span class="keyword">private</span> Myhandler myhandler;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBatch</span><span class="params">()</span></span>&#123;</span><br><span class="line">		MyContext myContext = applicationContext.getBean(MyContext.class);</span><br><span class="line">		myhandler.saveBatch(myContext);	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyHandler</span></span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveBathch</span><span class="params">(MyContext myContext)</span></span>&#123;</span><br><span class="line">			init(myContext);</span><br><span class="line">			build(myContext);</span><br><span class="line">			myContext.commit();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="meta">@Transactional</span>(rollbackFor = Exception.class)</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(MyContext myContext)</span></span>&#123;...&#125;</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">build</span><span class="params">(MyContext myContext)</span></span>&#123;...&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope</span>(ConfigurableBeanFactory.SCOPE_PROTOTYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyContext</span></span>&#123;</span><br><span class="line">    <span class="meta">@Transactional</span>(value = <span class="string">"demoBTransactionManager"</span>, rollbackFor = Exception.class)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commiy</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	<span class="comment">//这里调用dao的方法将数据批量入库</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><ul>
<li><p>Spring AOP和IOC是两大特性，两大特性密不可分，提供了强大功能</p>
</li>
<li><p>Spring AOP生效的原则是使用了代理，使用代理的前提是:</p>
<ul>
<li>不能在一个类内部方法调用自己的另一个事务方法，代理只能代理一层</li>
<li><p>基于JDK代理的方法只能代理接口方法，所以只能是public，方法不能被static，private，protected，final修饰(接口也不能被这些修饰)</p>
</li>
<li><p>基于CGLIB代理的方法可以代理普通类方法</p>
</li>
</ul>
</li>
<li><p>Spring默认使用JDK动态代理，在无法使用JDK的普通类上Spring使用CGLIB做代理</p>
</li>
<li><p>Spring使用代理模式来实现AOP</p>
</li>
<li><p>Spring AOP增强代理类，涉及多个interceptor的执行，使用责任链模式</p>
</li>
<li><p>配置多DataSource数据源的工程，使用事务时应指定TransactionManager，单数据源最好也指定一下，以防以后配置多数据源留下隐患</p>
</li>
<li><p>事出反常必有妖，源码阅读是良策。</p>
</li>
</ul>

      </div>
      <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://shinerio.cc">shinerio</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://shinerio.cc/2019/07/16/other/Spring事务踩过的坑/">https://shinerio.cc/2019/07/16/other/Spring事务踩过的坑/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>
      <footer class="post-footer">
        <div class="post-tags">
            <a href="/tags/java/">java</a>
            <a href="/tags/debug/">debug</a>
            <a href="/tags/Spring/">Spring</a>
            </div>
        
        <nav class="post-nav"><a class="prev" href="/2019/08/11/java/java锁/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">java锁</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    <a class="next" href="/2019/07/07/rocketmq/rocket源码阅读(三)/">
        <span class="next-text nav-default">rocket源码阅读(三)</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    </nav></footer>
    </article></div><div class="comments" id="comments"><div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div></div>
      </main>

      <footer id="footer" class="footer"><div class="social-links"><a href="mailto:jstxzhangrui@163.com" class="iconfont icon-email" title="email"></a>
        <a href="https://github.com/shinerio" class="iconfont icon-github" title="github"></a>
        <a href="/atom.xml" class="iconfont icon-rss" title="rss"></a>
    </div><div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">&copy;2015 - 2023<span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">shinerio</span>
  </span>
</div>
</footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div><script type="text/javascript">
    var disqus_config = function () {
        this.page.url = 'https://shinerio.cc/2019/07/16/other/Spring事务踩过的坑/';
        this.page.identifier = '2019/07/16/other/Spring事务踩过的坑/';
        this.page.title = 'Spring事务踩过的坑';
    };
    (function() {
    var d = document, s = d.createElement('script');

    s.src = '//shinerio.disqus.com/embed.js';

    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();  
  </script><script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/src/even.js?v=2.11.0"></script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->
</body>
</html>
