---
title: 2022-03-27未命名文件 
tags: 新建,模板,小书匠
category: /小书匠/日记/2022-03
renderNumberedHeading: true
grammar_cjkRuby: true
---
## 问题描述

分页查询snat规则表，时延较高。

```shell
select count(1) as num,tenant_id from snat_rules group by snat_rules.tenant_id;

  NUM  |            TENANT_ID             
-------+----------------------------------
     1 | 05996fbb7580d2952fd1c00fc6738442
     1 | 05996fb3cb80d2952f5ec005f4a21cb9
     1 | 0d677961c180d2e02f15c0030e2cdf06
     1 | 0c68991c7580d22d2f46c001ed69bad2
   179 | 057ef081c000d2732fcfc00723a207ee
     2 | 05996fb37880d2952f5ac00f6c29058e
     5 | 057ef081fd80d2732fd2c003b6a43a38
     5 | 05996fb9f880d2952fbac01cd9419acf
     1 | 05996fb89280d2952fa8c01981e371b3
     2 | 05996fb36580d2952f59c0008608a595
     1 | 05996fb32a00d2952f56c014c4f9d0bf
     2 | 05996fb72400d2952f92c0175fdca74b
     1 | 05996fc25b80d2952f30c0112a049f1e
 14684 | 057ef0819a80d2732fcdc0024a9a30a7
     1 | 05bd64e1c680d5c32f01c003c0321beb
     5 | 05996fba4500d2952fbec01a1b0ebacd
     2 | 05bd64e87d00d3062fe2c012ed8e6b6f
     4 | 057ef0821200d2732fd3c00c28c27fb3
     2 | 05bd64a89c80d41d2f4fc01e027908ed
     1 | 057ef0818800d2732fccc01ccd4044b0
     2 | 05996fc48e80d2952f4cc010a46df3f2
     1 | 070496232080d29f2f82c01879a4a9a1
  4128 | 057ef081ad80d2732fcec011fdbc01c0
(23 rows)
```

使用explain analyze分析数据如下：


```shell
explain analyze select snat_rules.id, snat_rules.nat_gateway_id, snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, group_concat(distinct(ext_snat_rules.cidr)) as cidr, snat_rules.source_type, snat_rules.description, (array_agg(snat_rule_fip_associations.br_vni))[1] as br_vni, (array_agg(snat_rule_fip_associations.br_vtep))[1] as br_vtep, (array_agg(snat_rule_fip_associations.nat_vni))[1] as nat_vni, group_concat(distinct(ext_snat_rules.host_id)) as host_id, group_concat(distinct(ext_snat_rules.seq0)) as seq0, group_concat(distinct(ext_snat_rules.status)) as action_status, group_concat(distinct(ext_snat_rules.internal_vni)) as internal_vni, group_concat(distinct(snat_rule_fip_associations.floating_ip_id)) as floating_ip_id, group_concat(distinct(snat_rule_fip_associations.floating_ip_address)) as floating_ip_address from snat_rules left join snat_rule_fip_associations on snat_rule_fip_associations.snat_rule_id=snat_rules.id and snat_rule_fip_associations.admin_state = 'NORMAL' left join ext_snat_rules ext_snat_rules on ext_snat_rules.id=snat_rules.id left join snat_rule_fip_associations snat_fip_freezed on snat_fip_freezed.snat_rule_id=snat_rules.id and snat_fip_freezed.admin_state = 'FREEZED' where snat_rules.tenant_id = '057ef0819a80d2732fcdc0024a9a30a7' group by snat_rules.id order by snat_rules.id asc ,snat_rules.created_at asc limit '2000';

                                                                                                   QUERY PLAN                                                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=655092.98..655097.98 rows=2000 width=282) (actual time=1242.384..1242.731 rows=2000 loops=1)
   ->  Sort  (cost=655092.98..655129.69 rows=14685 width=282) (actual time=1242.383..1242.578 rows=2000 loops=1)
         Sort Key: SNAT_RULES.ID, SNAT_RULES.CREATED_AT
         Sort Method: quicksort  Memory: 15292kB
         ->  GroupAggregate  (cost=0.00..654214.39 rows=14685 width=282) (actual time=0.330..1218.925 rows=14684 loops=1)
               ->  Nested Loop Left Join  (cost=0.00..647687.68 rows=141476 width=282) (actual time=0.141..597.476 rows=176076 loops=1)
                     ->  Nested Loop Left Join  (cost=0.00..332008.92 rows=14685 width=214) (actual time=0.134..363.295 rows=14684 loops=1)
                           ->  Nested Loop Left Join  (cost=0.00..17798.65 rows=14685 width=214) (actual time=0.096..132.768 rows=14684 loops=1)
                                 ->  Index Scan using SNAT_RULES_PKEY on SNAT_RULES  (cost=0.00..2183.34 rows=14685 width=163) (actual time=0.014..29.071 rows=14684 loops=1)
                                       Filter: ((TENANT_ID)::TEXT = '057ef0819a80d2732fcdc0024a9a30a7'::TEXT)
                                       Rows Removed by Filter: 4348
                                 ->  Index Scan using EXT_SNAT_RULES_PKEY on EXT_SNAT_RULES  (cost=0.00..1.05 rows=1 width=88) (actual time=0.006..0.006 rows=1 loops=14684)
                                       Index Cond: ((ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                           ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS SNAT_FIP_FREEZED  (cost=0.00..21.39 rows=1 width=37) (actual time=0.015..0.015 rows=0 loops=14684)
                                 Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                                 Filter: ((ADMIN_STATE)::TEXT = 'FREEZED'::TEXT)
                                 Rows Removed by Filter: 12
                     ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS  (cost=0.00..21.39 rows=11 width=105) (actual time=0.003..0.013 rows=12 loops=14684)
                           Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                           Filter: ((ADMIN_STATE)::TEXT = 'NORMAL'::TEXT)
 Total runtime: 1244.112 ms
(21 rows)    
```

结果分析如下：

```
 limit获取2000条，累计花费1242.384ms
    ->   排序，累计花费1242.578ms
         ->  分组聚合，累计花费 1218.925ms
               ->  再次关联SNAT_RULE_FIP_ASSOCIATIONS，累计花费597.476ms
                     ->  再次关联snat_fip_freezed临时表，累计花费363.295ms
                           -> 关联snat_rules表和ext_snat_rules表，累计花费132.768ms
                                 ->  对snat_rules表进行index scan扫描，使用tenant_id进行过滤，花费29.071ms
                                 ->  对ext_snat_rules表进行index scan，共花费0.006 * 14684 = 88.104ms
                           ->  对snat_rule_fip_associations进行index scan，过滤admin_state状态为FREEZED的数据，共花费0.015 * 14684 = 220.26ms
                     ->   对snat_rule_fip_associations进行index scan，过滤admin_state状态为NORMAL的数据，共花费0.013 * 14684 = 190.892ms

```

可以看出时间主要花费在

1. 多次表关联耗费时间较多
2. 对ext_snat_rules和snat_rule_fip_associations进行扫描时，扫描了该租户下所有数据（14684），而我们实际只需要2000条
3. 分组聚合花费时间巨大

> 这里可以看出表关联的代价是非常大的，尤其是大表关联，对于被关联表的中的每一条数据，都会在关联表里进行一次扫描，消耗的时间与关联表的数量是成指数增长的，所以我们平常写sql的时候要尽量避免大表join

## 优化一

对snat_rule_fip_associations的关联可以减少为1次，对于冻结eip的处理，可以在业务代码中完成，避免多次表关联。

```shell
explain analyze select snat_rules.id, snat_rules.nat_gateway_id, snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, group_concat(distinct(ext_snat_rules.cidr)) as cidr, snat_rules.source_type, snat_rules.description, (array_agg(snat_rule_fip_associations.br_vni))[1] as br_vni, (array_agg(snat_rule_fip_associations.br_vtep))[1] as br_vtep, (array_agg(snat_rule_fip_associations.nat_vni))[1] as nat_vni, group_concat(distinct(ext_snat_rules.host_id)) as host_id, group_concat(distinct(ext_snat_rules.seq0)) as seq0, group_concat(distinct(ext_snat_rules.status)) as action_status, group_concat(distinct(ext_snat_rules.internal_vni)) as internal_vni, group_concat(distinct(snat_rule_fip_associations.floating_ip_id)) as floating_ip_id, group_concat(distinct(snat_rule_fip_associations.floating_ip_address)) as floating_ip_address from snat_rules left join snat_rule_fip_associations on snat_rule_fip_associations.snat_rule_id=snat_rules.id left join ext_snat_rules ext_snat_rules on ext_snat_rules.id=snat_rules.id where snat_rules.tenant_id = '057ef0819a80d2732fcdc0024a9a30a7' group by snat_rules.id order by snat_rules.id asc ,snat_rules.created_at asc limit '2000';                                                                                  
                                                                                         QUERY PLAN                                                                                          
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=340479.42..340484.42 rows=2000 width=282) (actual time=932.689..933.033 rows=2000 loops=1)
   ->  Sort  (cost=340479.42..340516.14 rows=14685 width=282) (actual time=932.688..932.887 rows=2000 loops=1)
         Sort Key: SNAT_RULES.ID, SNAT_RULES.CREATED_AT
         Sort Method: quicksort  Memory: 15292kB
         ->  GroupAggregate  (cost=0.00..339600.84 rows=14685 width=282) (actual time=0.165..909.822 rows=14684 loops=1)
               ->  Nested Loop Left Join  (cost=0.00..333073.58 rows=141489 width=282) (actual time=0.045..343.671 rows=176076 loops=1)
                     ->  Nested Loop Left Join  (cost=0.00..17798.65 rows=14685 width=214) (actual time=0.029..85.101 rows=14684 loops=1)
                           ->  Index Scan using SNAT_RULES_PKEY on SNAT_RULES  (cost=0.00..2183.34 rows=14685 width=163) (actual time=0.013..21.406 rows=14684 loops=1)
                                 Filter: ((TENANT_ID)::TEXT = '057ef0819a80d2732fcdc0024a9a30a7'::TEXT)
                                 Rows Removed by Filter: 4348
                           ->  Index Scan using EXT_SNAT_RULES_PKEY on EXT_SNAT_RULES  (cost=0.00..1.05 rows=1 width=88) (actual time=0.004..0.004 rows=1 loops=14684)
                                 Index Cond: ((ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                     ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS  (cost=0.00..21.36 rows=11 width=105) (actual time=0.004..0.015 rows=12 loops=14684)
                           Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
 Total runtime: 934.476 ms
(15 rows)
```

> 由于少关联了一次表，时间的消耗也降低300ms，但时间还是较长。可以看出在对snat_rule_fip_associations表进行扫描的时候，还是扫描了14684行，实际我们并不需要这么多数据。

我们可以做一个实验，查询一个规则比较少的租户

```shell
explain analyze select snat_rules.id, snat_rules.nat_gateway_id, snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, snat_rules.source_type, snat_rules.description, snat_rules.cidr as cidr, snat_rule_fip_associations.floating_ip_id as floating_ip_id, snat_rule_fip_associations.floating_ip_address as floating_ip_address, snat_rule_fip_associations.admin_state as admin_state from snat_rules left join snat_rule_fip_associations on snat_rule_fip_associations.snat_rule_id=snat_rules.id left join ext_snat_rules ext_snat_rules on ext_snat_rules.id=snat_rules.id where snat_rules.tenant_id = '745f75f368b84fb2b49594bcf4a0d624' group by snat_rules.id ,snat_rule_fip_associations.floating_ip_id ,snat_rule_fip_associations.floating_ip_address ,snat_rule_fip_associations.admin_state order by snat_rules.created_at asc limit '2000';
                                                                                           QUERY PLAN                                                                                           
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=1265.56..1265.57 rows=4 width=250) (actual time=6.410..6.411 rows=1 loops=1)
   ->  Sort  (cost=1265.56..1265.57 rows=4 width=250) (actual time=6.409..6.410 rows=1 loops=1)
         Sort Key: SNAT_RULES.CREATED_AT
         Sort Method: quicksort  Memory: 25kB
         ->  HashAggregate  (cost=1265.48..1265.52 rows=4 width=250) (actual time=6.402..6.402 rows=1 loops=1)
               ->  Nested Loop Left Join  (cost=0.00..1265.44 rows=4 width=250) (actual time=0.028..6.398 rows=1 loops=1)
                     ->  Seq Scan on SNAT_RULES  (cost=0.00..1257.46 rows=1 width=193) (actual time=0.012..6.380 rows=1 loops=1)
                           Filter: ((TENANT_ID)::TEXT = '745f75f368b84fb2b49594bcf4a0d624'::TEXT)
                           Rows Removed by Filter: 30916
                     ->  Index Scan using IX_SNAT_RULE_FIP_ASSOCIATIONS_SNAT_RULE_ID on SNAT_RULE_FIP_ASSOCIATIONS  (cost=0.00..7.94 rows=4 width=94) (actual time=0.013..0.014 rows=1 loops=1)
                           Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
 Total runtime: 6.451 ms
```

> 可以看到时间只消耗了6.451ms，对snat_rule_fip_associations表进行扫描的时候，只loop了一次。因此可以得出数据量对查询效率影响巨大的结论。

## 负优化

在上面我们，我们使用了array_agg和group_concat函数进行聚合，未来适配br多集群后，每个eip的br信息有可能不一样，我们不能使用array_agg的方式，而是需要返回每一个eip的详细信息。更改sql如下

```shell
explain analyze select snat_rules.id, snat_rules.nat_gateway_id, snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, group_concat(distinct(ext_snat_rules.cidr)) as cidr, snat_rules.source_type, snat_rules.description, snat_rule_fip_associations.br_vni, snat_rule_fip_associations.br_vtep, snat_rule_fip_associations.nat_vni, group_concat(distinct(ext_snat_rules.host_id)) as host_id, group_concat(distinct(ext_snat_rules.seq0)) as seq0, group_concat(distinct(ext_snat_rules.status)) as action_status, group_concat(distinct(ext_snat_rules.internal_vni)) as internal_vni, snat_rule_fip_associations.floating_ip_id, snat_rule_fip_associations.floating_ip_address as floating_ip_address from snat_rules left join snat_rule_fip_associations on snat_rule_fip_associations.snat_rule_id=snat_rules.id left join ext_snat_rules ext_snat_rules on ext_snat_rules.id=snat_rules.id where snat_rules.tenant_id = '057ef0819a80d2732fcdc0024a9a30a7' group by snat_rules.id,snat_rule_fip_associations.br_vni, snat_rule_fip_associations.br_vtep, snat_rule_fip_associations.nat_vni,snat_rule_fip_associations.floating_ip_id ,snat_rule_fip_associations.floating_ip_address order by snat_rules.id asc, snat_rules.created_at asc limit '2000';    
                                                                                 
                                                                                                                    QUERY PLAN                                                                                                                     
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=362167.41..362172.41 rows=2000 width=282) (actual time=2624.049..2624.563 rows=2000 loops=1)
   ->  Sort  (cost=362167.41..362521.14 rows=141489 width=282) (actual time=2624.048..2624.409 rows=2000 loops=1)
         Sort Key: SNAT_RULES.ID, SNAT_RULES.CREATED_AT
         Sort Method: quicksort  Memory: 96934kB
         ->  GroupAggregate  (cost=344151.77..353702.28 rows=141489 width=282) (actual time=968.385..2453.326 rows=176076 loops=1)
               ->  Sort  (cost=344151.77..344505.49 rows=141489 width=282) (actual time=968.339..989.343 rows=176076 loops=1)
                     Sort Key: SNAT_RULES.ID, SNAT_RULE_FIP_ASSOCIATIONS.BR_VNI, SNAT_RULE_FIP_ASSOCIATIONS.BR_VTEP, SNAT_RULE_FIP_ASSOCIATIONS.NAT_VNI, SNAT_RULE_FIP_ASSOCIATIONS.FLOATING_IP_ID, SNAT_RULE_FIP_ASSOCIATIONS.FLOATING_IP_ADDRESS
                     Sort Method: quicksort  Memory: 96934kB
                     ->  Nested Loop Left Join  (cost=0.00..332047.15 rows=141489 width=282) (actual time=0.052..398.490 rows=176076 loops=1)
                           ->  Nested Loop Left Join  (cost=0.00..16772.22 rows=14685 width=214) (actual time=0.032..91.076 rows=14684 loops=1)
                                 ->  Seq Scan on SNAT_RULES  (cost=0.00..1156.91 rows=14685 width=163) (actual time=0.010..11.859 rows=14684 loops=1)
                                       Filter: ((TENANT_ID)::TEXT = '057ef0819a80d2732fcdc0024a9a30a7'::TEXT)
                                       Rows Removed by Filter: 4348
                                 ->  Index Scan using EXT_SNAT_RULES_PKEY on EXT_SNAT_RULES  (cost=0.00..1.05 rows=1 width=88) (actual time=0.005..0.005 rows=1 loops=14684)
                                       Index Cond: ((ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                           ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS  (cost=0.00..21.36 rows=11 width=105) (actual time=0.006..0.018 rows=12 loops=14684)
                                 Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
 Total runtime: 2633.055 ms
 (18 rows)
```

> 可以看到时延明显上升，达到了快3s。对比之前可以看出多了一次排序。Sort Key: SNAT_RULES.ID, SNAT_RULE_FIP_ASSOCIATIONS.BR_VNI, SNAT_RULE_FIP_ASSOCIATIONS.BR_VTEP, SNAT_RULE_FIP_ASSOCIATIONS.NAT_VNI, SNAT_RULE_FIP_ASSOCIATIONS.FLOATING_IP_ID, SNAT_RULE_FIP_ASSOCIATIONS.FLOATING_IP_ADDRESS，此操作花费将近600ms。分组聚合时间更是达到了1.5s左右。

## 优化二

分析上述结果，[负优化](#负优化)中多的一次排序没有任何必要，我们其实只需要对id和create_at进行排序就行了。结合最开始的分析，我们有两个地方可以优化：

1. 其实我们不需要那么多数据，那么我们可以对db查询顺序进行优化，先对snat_rules表进行limit，这样关联的时候就只需要进行limit次扫描了。
2. 先snat_rules表进行排序后，在进行关联操作，避免大表（三表关联后的表）排序

```shell
explain analyze select snat_rules.id, snat_rules.nat_gateway_id, snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, snat_rules.source_type, snat_rules.description, snat_rules.cidr as cidr, snat_rule_fip_associations.floating_ip_id as floating_ip_id, snat_rule_fip_associations.floating_ip_address as floating_ip_address, snat_rule_fip_associations.admin_state as admin_state from (select * from snat_rules where snat_rules.tenant_id = '057ef0819a80d2732fcdc0024a9a30a7' order by snat_rules.created_at asc limit '2000') snat_rules left join snat_rule_fip_associations on snat_rule_fip_associations.snat_rule_id=snat_rules.id left join ext_snat_rules on ext_snat_rules.id=snat_rules.id group by snat_rules.id, snat_rules.nat_gateway_id,snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, snat_rules.source_type, snat_rules.description, snat_rules.cidr,snat_rule_fip_associations.floating_ip_id ,snat_rule_fip_associations.floating_ip_address, snat_rule_fip_associations.admin_state;

                                                                                  QUERY PLAN                                                                                   
-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 HashAggregate  (cost=54203.02..54429.88 rows=22686 width=235) (actual time=115.794..133.148 rows=23923 loops=1)
   ->  Nested Loop Left Join  (cost=2035.50..53465.72 rows=22686 width=235) (actual time=16.878..84.129 rows=23923 loops=1)
         ->  Limit  (cost=2035.50..2040.50 rows=2000 width=277) (actual time=16.845..17.737 rows=2000 loops=1)
               ->  Sort  (cost=2035.50..2072.21 rows=14685 width=277) (actual time=16.843..17.515 rows=2000 loops=1)
                     Sort Key: SNAT_RULES.CREATED_AT
                     Sort Method: quicksort  Memory: 4285kB
                     ->  Seq Scan on SNAT_RULES  (cost=0.00..1156.91 rows=14685 width=277) (actual time=0.023..9.501 rows=14684 loops=1)
                           Filter: ((TENANT_ID)::TEXT = '057ef0819a80d2732fcdc0024a9a30a7'::TEXT)
                           Rows Removed by Filter: 4348
         ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS  (cost=0.00..25.59 rows=11 width=94) (actual time=0.011..0.030 rows=12 loops=2000)
               Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
 Total runtime: 134.733 ms
(12 rows)
```

> 可以看出，时间直接降低到了134.733ms，可以满足我们的正常使用。主要优化有两点，一是对SNAT_RULE_FIP_ASSOCIATIONS的扫描只花费0.03 * 2000 = 60ms，相对于原来的190 + 220 = 410ms提升巨大。二是避免了外层排序

## 加固验证

我们使用优化前和优化后的sql，查询1条数据进行对比。

```shell
explain analyze select snat_rules.id, snat_rules.nat_gateway_id, snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, group_concat(distinct(ext_snat_rules.cidr)) as cidr, snat_rules.source_type, snat_rules.description, (array_agg(snat_rule_fip_associations.br_vni))[1] as br_vni, (array_agg(snat_rule_fip_associations.br_vtep))[1] as br_vtep, (array_agg(snat_rule_fip_associations.nat_vni))[1] as nat_vni, group_concat(distinct(ext_snat_rules.host_id)) as host_id, group_concat(distinct(ext_snat_rules.seq0)) as seq0, group_concat(distinct(ext_snat_rules.status)) as action_status, group_concat(distinct(ext_snat_rules.internal_vni)) as internal_vni, group_concat(distinct(snat_rule_fip_associations.floating_ip_id)) as floating_ip_id, group_concat(distinct(snat_rule_fip_associations.floating_ip_address)) as floating_ip_address from snat_rules left join snat_rule_fip_associations on snat_rule_fip_associations.snat_rule_id=snat_rules.id and snat_rule_fip_associations.admin_state = 'NORMAL' left join ext_snat_rules ext_snat_rules on ext_snat_rules.id=snat_rules.id left join snat_rule_fip_associations snat_fip_freezed on snat_fip_freezed.snat_rule_id=snat_rules.id and snat_fip_freezed.admin_state = 'FREEZED' where snat_rules.tenant_id = '057ef0819a80d2732fcdc0024a9a30a7' group by snat_rules.id order by snat_rules.id asc ,snat_rules.created_at asc limit 1;

                                                                                                   QUERY PLAN                                                                                                    
-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 Limit  (cost=654287.81..654287.82 rows=1 width=282) (actual time=1215.949..1215.949 rows=1 loops=1)
   ->  Sort  (cost=654287.81..654324.53 rows=14685 width=282) (actual time=1215.948..1215.948 rows=1 loops=1)
         Sort Key: SNAT_RULES.ID, SNAT_RULES.CREATED_AT
         Sort Method: quicksort  Memory: 15292kB
         ->  GroupAggregate  (cost=0.00..654214.39 rows=14685 width=282) (actual time=0.291..1194.232 rows=14684 loops=1)
               ->  Nested Loop Left Join  (cost=0.00..647687.68 rows=141476 width=282) (actual time=0.096..561.952 rows=176076 loops=1)
                     ->  Nested Loop Left Join  (cost=0.00..332008.92 rows=14685 width=214) (actual time=0.087..315.556 rows=14684 loops=1)
                           ->  Nested Loop Left Join  (cost=0.00..17798.65 rows=14685 width=214) (actual time=0.037..100.216 rows=14684 loops=1)
                                 ->  Index Scan using SNAT_RULES_PKEY on SNAT_RULES  (cost=0.00..2183.34 rows=14685 width=163) (actual time=0.016..25.887 rows=14684 loops=1)
                                       Filter: ((TENANT_ID)::TEXT = '057ef0819a80d2732fcdc0024a9a30a7'::TEXT)
                                       Rows Removed by Filter: 4348
                                 ->  Index Scan using EXT_SNAT_RULES_PKEY on EXT_SNAT_RULES  (cost=0.00..1.05 rows=1 width=88) (actual time=0.004..0.004 rows=1 loops=14684)
                                       Index Cond: ((ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                           ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS SNAT_FIP_FREEZED  (cost=0.00..21.39 rows=1 width=37) (actual time=0.014..0.014 rows=0 loops=14684)
                                 Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                                 Filter: ((ADMIN_STATE)::TEXT = 'FREEZED'::TEXT)
                                 Rows Removed by Filter: 12
                     ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS  (cost=0.00..21.39 rows=11 width=105) (actual time=0.004..0.014 rows=12 loops=14684)
                           Index Cond: ((SNAT_RULE_ID)::TEXT = (SNAT_RULES.ID)::TEXT)
                           Filter: ((ADMIN_STATE)::TEXT = 'NORMAL'::TEXT)
 Total runtime: 1217.812 ms
(21 rows)

explain analyze select snat_rules.id, snat_rules.nat_gateway_id, snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, snat_rules.source_type, snat_rules.description, snat_rules.cidr as cidr, snat_rule_fip_associations.floating_ip_id as floating_ip_id, snat_rule_fip_associations.floating_ip_address as floating_ip_address, snat_rule_fip_associations.admin_state as admin_state from (select * from snat_rules where snat_rules.tenant_id = '057ef0819a80d2732fcdc0024a9a30a7' order by snat_rules.created_at asc limit '1') snat_rules left join snat_rule_fip_associations on snat_rule_fip_associations.snat_rule_id=snat_rules.id left join ext_snat_rules on ext_snat_rules.id=snat_rules.id group by snat_rules.id, snat_rules.nat_gateway_id,snat_rules.tenant_id, snat_rules.network_id, snat_rules.status, snat_rules.admin_state_up, snat_rules.tenant_id, snat_rules.created_at, snat_rules.source_type, snat_rules.description, snat_rules.cidr,snat_rule_fip_associations.floating_ip_id ,snat_rule_fip_associations.floating_ip_address, snat_rule_fip_associations.admin_state;

                                                                                QUERY PLAN                                                                                 
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------
 HashAggregate  (cost=1257.34..1257.45 rows=11 width=235) (actual time=18.769..18.770 rows=1 loops=1)
   ->  Nested Loop Left Join  (cost=1230.34..1256.98 rows=11 width=235) (actual time=18.743..18.748 rows=1 loops=1)
         ->  Limit  (cost=1230.34..1230.34 rows=1 width=277) (actual time=18.704..18.705 rows=1 loops=1)
               ->  Sort  (cost=1230.34..1267.05 rows=14685 width=277) (actual time=18.702..18.702 rows=1 loops=1)
                     Sort Key: PUBLIC.SNAT_RULES.CREATED_AT
                     Sort Method: quicksort  Memory: 4285kB
                     ->  Seq Scan on SNAT_RULES  (cost=0.00..1156.91 rows=14685 width=277) (actual time=0.011..9.315 rows=14684 loops=1)
                           Filter: ((TENANT_ID)::TEXT = '057ef0819a80d2732fcdc0024a9a30a7'::TEXT)
                           Rows Removed by Filter: 4348
         ->  Index Scan using SNAT_RULE_FIP_ASSOCIATIONS_PKEY on SNAT_RULE_FIP_ASSOCIATIONS  (cost=0.00..26.52 rows=11 width=94) (actual time=0.026..0.029 rows=1 loops=1)
               Index Cond: ((SNAT_RULE_ID)::TEXT = (PUBLIC.SNAT_RULES.ID)::TEXT)
 Total runtime: 18.844 ms
(12 rows)
```

> 可以看到优化前，即使limit为1也需要接近1217ms，而优化的sql只需要18ms就能完成。