<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Httpè¿æ¥æ±  - Shinerio's Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="article-page" id="theme-body">
    <div class="page-wrapper">
        <header class="page-header">
            <div class="container">
                <nav class="page-nav">
                    <div class="nav-links">
                        <a href="index.html" class="nav-link ">Home</a>
                        <a href="articles.html" class="nav-link ">Articles</a>
                        <a href="search.html" class="nav-link ">Search</a>
                    </div>
                    <div class="theme-toggle-container">
                        <button id="theme-toggle" aria-label="Toggle dark mode" class="theme-toggle-btn">
                            <span class="sun-icon">â˜€ï¸</span>
                            <span class="moon-icon">ğŸŒ™</span>
                        </button>
                    </div>
                </nav>
            </div>
        </header>
        <main class="page-main">
            <div class="container">
                <article>
    <header>
        <h1>Httpè¿æ¥æ± </h1>
        <time datetime="2026-01-03T13:04:29.159Z">2026å¹´1æœˆ3æ—¥</time>
        <div class="tags">
            
        </div>
    </header>
    <section class="content">
        {<h1>1. é•¿è¿æ¥</h1>
<p>é•¿è¿æ¥åˆ©ç”¨keep-aliveæŠ€æœ¯å®ç°ï¼Œèƒ½åœ¨å¤šæ¬¡ HTTP ä¹‹é—´é‡ç”¨åŒä¸€ä¸ª TCP è¿æ¥ï¼Œä»è€Œ<strong>å‡å°‘åˆ›å»º/å…³é—­å¤šä¸ª TCP è¿æ¥çš„å¼€é”€ï¼ˆåŒ…æ‹¬å“åº”æ—¶é—´ã€CPU èµ„æºã€å‡å°‘æ‹¥å µç­‰ï¼‰</strong>ã€‚<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images20241218234752650.png" alt="image.png"></p>
<p>ç„¶è€Œé•¿è¿æ¥å¹¶éæ²¡æœ‰å¼Šç«¯ï¼Œå¤©ä¸‹æ²¡æœ‰å…è´¹çš„åˆé¤ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨æ¥æ”¶å®Œæ‰€æœ‰çš„ä¿¡æ¯ä¹‹åè¿˜æ²¡æœ‰å…³é—­è¿æ¥ï¼Œåˆ™æœåŠ¡ç«¯ç›¸åº”çš„èµ„æºè¿˜åœ¨è¢«å ç”¨ï¼ˆå°½ç®¡å·²ç»æ²¡ç”¨äº†ï¼‰ã€‚ä¾‹å¦‚Tomcatçš„BIOå®ç°ä¸­ï¼Œæœªå…³é—­çš„è¿æ¥ä¼šå ç”¨å¯¹åº”çš„å¤„ç†çº¿ç¨‹ï¼Œå¦‚æœä¸€ä¸ªé•¿è¿æ¥å®é™…ä¸Šå·²ç»å¤„ç†å®Œæ¯•ï¼Œä½†å…³é—­çš„è¶…æ—¶æ—¶é—´æœªåˆ°ï¼Œåˆ™è¯¥çº¿ç¨‹ä¼šä¸€ç›´è¢«å ç”¨ï¼ˆä½¿ç”¨NIOçš„å®ç°æ²¡æœ‰è¯¥é—®é¢˜ï¼‰ã€‚æ˜¾ç„¶ï¼Œ<strong>å¦‚æœå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯çš„ç¡®éœ€è¦è¿›è¡Œå¤šæ¬¡é€šä¿¡ï¼Œåˆ™å¼€å¯ keep-alive æ˜¯æ›´å¥½çš„é€‰æ‹©</strong>ï¼Œä¾‹å¦‚åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œé€šå¸¸å¾®æœåŠ¡çš„ä½¿ç”¨æ–¹å’Œæä¾›æ–¹ä¼šé•¿æœŸæœ‰äº¤æµã€‚åœ¨ä¸€äº› TPS/QPS å¾ˆé«˜çš„ REST æœåŠ¡ä¸­ï¼Œå¦‚æœä½¿ç”¨çš„æ˜¯çŸ­è¿æ¥ï¼ˆå³æ²¡æœ‰å¼€å¯keep-aliveï¼‰ï¼Œåˆ™å¾ˆå¯èƒ½å‘ç”Ÿå®¢æˆ·ç«¯ç«¯å£è¢«å æ»¡çš„æƒ…å½¢ã€‚è¿™æ˜¯ç”±äºçŸ­æ—¶é—´å†…ä¼šåˆ›å»ºå¤§é‡TCP è¿æ¥ï¼Œè€Œåœ¨ TCP å››æ¬¡æŒ¥æ‰‹ç»“æŸåï¼Œå®¢æˆ·ç«¯çš„ç«¯å£ä¼šå¤„äºTIME_WAITä¸€æ®µæ—¶é—´(2MSLï¼Œlinuxç³»ç»Ÿä¸­å¤§æ¦‚<code>60*2=120</code>ç§’)ï¼Œè¿™æœŸé—´ç«¯å£ä¸ä¼šè¢«é‡Šæ”¾ï¼Œä»è€Œå¯¼è‡´ç«¯å£è¢«å æ»¡ã€‚è¿™ç§æƒ…å†µä¸‹æœ€å¥½ä½¿ç”¨é•¿è¿æ¥ã€‚</p>
<h2>1.1. å¼€å¯æ–¹æ³•</h2>
<ul>
<li>åœ¨ HTTP1.0ä¸­ï¼Œè‹¥è¦ä½¿ç”¨é•¿è¿æ¥ï¼Œéœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æ˜ç¡®æ·»åŠ  â€œConnection: keep-aliveâ€ã€‚åªæœ‰å½“å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨éƒ½è®¾ç½®äº†è¯¥å­—æ®µæ—¶ï¼Œæ‰ä¼šå»ºç«‹é•¿è¿æ¥ã€‚å®¢æˆ·ç«¯å‘å‡ºå¸¦æœ‰ â€œConnection: keep-aliveâ€ å¤´çš„è¯·æ±‚ï¼›æœåŠ¡ç«¯æ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚åï¼Œæ ¹æ® HTTP 1.0 å’Œè¯¥å¤´ä¿¡æ¯åˆ¤æ–­å‡ºè¿™æ˜¯ä¸€ä¸ªé•¿è¿æ¥ï¼Œä¼šåœ¨å“åº”å¤´ä¸­ä¹Ÿå¢åŠ  â€œConnection: keep-aliveâ€ï¼Œå¹¶ä¸”ä¸ä¼šå…³é—­å·²å»ºç«‹çš„ TCP è¿æ¥ï¼›å®¢æˆ·ç«¯æ”¶åˆ°æœåŠ¡ç«¯çš„å“åº”åï¼Œå‘ç°å…¶ä¸­åŒ…å« â€œConnection: keep-aliveâ€ï¼Œå°±è®¤ä¸ºæ˜¯ä¸€ä¸ªé•¿è¿æ¥ï¼Œä¸å…³é—­è¿™ä¸ªè¿æ¥ã€‚</li>
<li>HTTP 1.1 é»˜è®¤æ”¯æŒé•¿è¿æ¥ï¼Œæ— éœ€é¢å¤–è®¾ç½® â€œConnection: keep-aliveâ€ã€‚</li>
</ul>
<h2>1.2. LBé•¿è¿æ¥</h2>
<p>LBçš„å‰åç«¯è¿æ¥æ˜¯ç‹¬ç«‹çš„ï¼Œé•¿è¿æ¥çš„ç»´æŠ¤ä¹Ÿæ˜¯ç‹¬ç«‹çš„ï¼Œä¼šæœ‰å‰åç«¯ä¸¤ä¸ªç‹¬ç«‹çš„è¿æ¥æ± ã€‚å³ä½¿å®¢æˆ·ç«¯ä¸LBåœ¨ä¸€ä¸ªé•¿è¿æ¥ä¼šè¯ä¸­å‘èµ·å¤šæ¬¡è¯·æ±‚ï¼Œè¿™äº›è¯·æ±‚ä¹Ÿä¼šè¢«è´Ÿè½½å‡è¡¡åˆ°å¤šä¸ªLBä¸åç«¯serverçš„è¿æ¥ä¸­å®Œæˆã€‚</p>
<h2>1.3. http1.0é•¿è¿æ¥æµ‹è¯•</h2>
<p>serverç«¯ä»£ç </p>
<pre><code class="language-python">from http.server import HTTPServer, BaseHTTPRequestHandler
import time

class LongConnectionHandler(BaseHTTPRequestHandler):
    protocol_version = &quot;HTTP/1.0&quot;

    def do_GET(self):
        self.send_response(200)
        self.send_header(&#39;Content-type&#39;, &#39;text/html&#39;)
        self.send_header(&#39;Connection&#39;, &#39;keep-alive&#39;)  # è®¾ç½®å“åº”å¤´ï¼Œè¡¨æ˜æ”¯æŒé•¿è¿æ¥
        self.end_headers()
        self.wfile.write(b&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;)

if __name__ == &quot;__main__&quot;:
    server_address = (&#39;&#39;, 8000)
    httpd = HTTPServer(server_address, LongConnectionHandler)
    print(&#39;Starting server, use &lt;Ctrl-C&gt; to stop&#39;)
    httpd.serve_forever()
</code></pre>
<p>clientç«¯ä»£ç (è¿™é‡Œè£¸å†™çš„socketç¼–ç¨‹ï¼ŒçœŸæ­£çš„HTTP clientéœ€è¦çœ‹å“åº”å¤´ä¸­æ˜¯å¦æºå¸¦keep-aliveæ¥å†³å®šè¦ä¸è¦ä¿æŒé•¿è¿æ¥ï¼Œä½¿ç”¨å¦‚ä¸‹ä»£ç åæ˜¯å¦ä¿æŒé•¿è¿æ¥å°±åªå–å†³äºæœåŠ¡ç«¯è¡Œä¸ºäº†)</p>
<pre><code class="language-python">import socket
import time

def http_1_0_client():
    host = &quot;localhost&quot;
    port = 8000
    buffer_size = 10240

    # åˆ›å»ºå¥—æ¥å­—å¹¶è¿æ¥åˆ°æœåŠ¡å™¨
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client_socket.connect((host, port))

    # æ„é€ HTTP 1.0è¯·æ±‚æ¶ˆæ¯ï¼Œè®¾ç½®é•¿è¿æ¥å¤´éƒ¨
    request = &quot;GET / HTTP/1.0\r\n&quot;
    request += &quot;Host: localhost\r\n&quot;
    request += &quot;Connection: Keep-Alive\r\n\r\n&quot;

    # å‘é€ç¬¬ä¸€æ¬¡è¯·æ±‚
    client_socket.send(request.encode())
    # ç­‰å¾…æœåŠ¡ç«¯å“åº”
    time.sleep(1)
    response = client_socket.recv(buffer_size).decode()
    print(&quot;ç¬¬ä¸€æ¬¡å“åº”:&quot;)
    print(response)

    time.sleep(10)

    # æ„é€ å¹¶å‘é€ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆå¯ä»¥å¤šæ¬¡é‡å¤ç±»ä¼¼æ“ä½œä½“ç°é•¿è¿æ¥æŒç»­äº¤äº’ï¼‰
    second_request = &quot;GET / HTTP/1.0\r\n&quot;
    second_request += &quot;Host: localhost\r\n&quot;
    second_request += &quot;Connection: Keep-Alive\r\n\r\n&quot;
    client_socket.send(second_request.encode())
    # ç­‰å¾…æœåŠ¡ç«¯å“åº”
    time.sleep(1)
    second_response = client_socket.recv(buffer_size).decode()
    print(&quot;ç¬¬äºŒæ¬¡å“åº”:&quot;)
    print(second_response)
    client_socket.close()

if __name__ == &quot;__main__&quot;:
    http_1_0_client()
</code></pre>
<p>å¯ä»¥çœ‹åˆ°åœ¨æ­¤æœŸé—´è¿æ¥ä¸€ç›´å¤„äºestablishedçŠ¶æ€ï¼Œå®¢æˆ·ç«¯çš„ä¸¤æ¬¡è¯·æ±‚å¤ç”¨äº†åŒä¸€ä¸ªtcpè¿æ¥ã€‚</p>
<pre><code class="language-shell">âœ  ~ netstat -anv|grep 8000
tcp4       0      0  127.0.0.1.8000         127.0.0.1.64622        ESTABLISHED 408241 146988  48143      0 0x0002 0x00000004
tcp4      48      0  127.0.0.1.64622        127.0.0.1.8000         ESTABLISHED 408160 146988  48145      0 0x0002 0x00000000
tcp4       0      0  *.8000                 *.*                    LISTEN      131072 131072  48143      0 0x0000 0x00000006
</code></pre>
<h2>1.4. http1.1é•¿è¿æ¥æµ‹è¯•</h2>
<p>http1.1ä¸‹ä¸éœ€è¦æºå¸¦keep-aliveå¤´ï¼Œé»˜è®¤ä½¿ç”¨é•¿è¿æ¥ã€‚Clientæˆ–è€…Serveréƒ½å¯ä»¥é€šè¿‡è®¾ç½®è¯·æ±‚å¤´æˆ–å“åº”å¤´<code>&quot;Connection&quot;: &quot;close&quot;</code>æ–¹å¼å¼ºåˆ¶å…³é—­ã€‚</p>
<p>serverç«¯ä»£ç </p>
<pre><code class="language-python">from http.server import HTTPServer, BaseHTTPRequestHandler
import time

class LongConnectionHandler(BaseHTTPRequestHandler):
    protocol_version = &quot;HTTP/1.1&quot;

    def do_GET(self):
        self.send_response(200)
        self.send_header(&#39;Content-type&#39;, &#39;text/html&#39;)
        self.end_headers()
        self.wfile.write(b&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;)

if __name__ == &quot;__main__&quot;:
    server_address = (&#39;&#39;, 8000)
    httpd = HTTPServer(server_address, LongConnectionHandler)
    print(&#39;Starting server, use &lt;Ctrl-C&gt; to stop&#39;)
    httpd.serve_forever()
</code></pre>
<p>clientç«¯ä»£ç </p>
<pre><code class="language-python">import socket
import time

def http_1_0_client():
    host = &quot;localhost&quot;
    port = 8000
    buffer_size = 10240

    # åˆ›å»ºå¥—æ¥å­—å¹¶è¿æ¥åˆ°æœåŠ¡å™¨
    client_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    client_socket.connect((host, port))

    # æ„é€ HTTP 1.1è¯·æ±‚æ¶ˆæ¯ï¼Œé»˜è®¤é•¿è¿æ¥
    request = &quot;GET / HTTP/1.1\r\n&quot;
    request += &quot;Host: localhost\r\n\r\n&quot;

    # å‘é€ç¬¬ä¸€æ¬¡è¯·æ±‚
    client_socket.send(request.encode())
    # ç­‰å¾…æœåŠ¡ç«¯å“åº”
    time.sleep(1)
    response = client_socket.recv(buffer_size).decode()
    print(&quot;ç¬¬ä¸€æ¬¡å“åº”:&quot;)
    print(response)

    time.sleep(10)

    # æ„é€ å¹¶å‘é€ç¬¬äºŒæ¬¡è¯·æ±‚ï¼ˆå¯ä»¥å¤šæ¬¡é‡å¤ç±»ä¼¼æ“ä½œä½“ç°é•¿è¿æ¥æŒç»­äº¤äº’ï¼‰
    second_request = &quot;GET / HTTP/1.1\r\n&quot;
    second_request += &quot;Host: localhost\r\n\r\n&quot;
    client_socket.send(second_request.encode())
    # ç­‰å¾…æœåŠ¡ç«¯å“åº”
    time.sleep(1)
    second_response = client_socket.recv(buffer_size).decode()
    print(&quot;ç¬¬äºŒæ¬¡å“åº”:&quot;)
    print(second_response)
    client_socket.close()

if __name__ == &quot;__main__&quot;:
    http_1_0_client()
</code></pre>
<h2>1.5. é•¿é“¾æ¥è¶…æ—¶è®¾ç½®</h2>
<ul>
<li>å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯éƒ½å¯ä»¥ç‹¬ç«‹å£°æ˜è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸ</li>
<li>å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´å»ºè®®è®¾ç½®æ¯”æœåŠ¡ç«¯çŸ­</li>
<li>å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯ä¸­é—´æœ‰å¯èƒ½ä¼šæœ‰7å±‚LBï¼Œæ­¤æ—¶LBå‰åç«¯çš„è¿æ¥æ˜¯ç‹¬ç«‹çš„ã€‚==å»ºè®®å®¢æˆ·ç«¯è¶…æ—¶æ—¶é—´&lt;lbè¶…æ—¶æ—¶é—´&lt;åç«¯serverè¶…æ—¶æ—¶é—´==</li>
</ul>
<h1>2. httpå¸¸è§é—®é¢˜</h1>
<h3>2.1.1. reactor.netty.http.client.PrematureCloseException: Connection prematurely closed BEFORE response</h3>
<p>å®¢æˆ·ç«¯å‘èµ·è¯·æ±‚çš„è¿‡ç¨‹ä¸­serverç«¯æ­£å¥½è¶…æ—¶finäº†ã€‚</p>
<p><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian/IMG_2680.JPG" alt=""></p>
<h3>2.1.2. Connection reset by peer</h3>
<ol>
<li><strong>å†™å¼‚å¸¸</strong> å¦‚æœä¸€ç«¯çš„Socketè¢«å…³é—­ï¼ˆæˆ–ä¸»åŠ¨å…³é—­ï¼Œæˆ–å› ä¸ºå¼‚å¸¸é€€å‡ºè€Œå¼•èµ·çš„å…³é—­ï¼‰ï¼Œå¦ä¸€ç«¯ä»å‘é€æ•°æ®ï¼Œå‘é€çš„ç¬¬ä¸€ä¸ªæ•°æ®åŒ…å¼•å‘è¯¥å¼‚å¸¸(Connect reset by peer)ã€‚Socketé»˜è®¤è¿æ¥60ç§’ï¼Œ60ç§’ä¹‹å†…æ²¡æœ‰è¿›è¡Œå¿ƒè·³äº¤äº’ï¼Œå³è¯»å†™æ•°æ®ï¼Œå°±ä¼šè‡ªåŠ¨å…³é—­è¿æ¥ã€‚</li>
<li><strong>è¯»å¼‚å¸¸</strong> ä¸€ç«¯é€€å‡ºä½†é€€å‡ºæ—¶å¹¶æœªå…³é—­è¯¥è¿æ¥ï¼Œå¦ä¸€ç«¯å¦‚æœåœ¨ä»è¿æ¥ä¸­è¯»æ•°æ®åˆ™æŠ›å‡ºè¯¥å¼‚å¸¸ã€‚</li>
</ol>
<p>å¯ä»¥é€šè¿‡python pdbçš„æ–¹å¼è°ƒè¯•serverç«¯ä»£ç ï¼Œåœ¨<code>self.wfile.write(b&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello, World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;)</code>å¤„æ–­ç‚¹ï¼Œç„¶åæ‰§è¡Œclientä»£ç ï¼Œç­‰å¾…serveræ‰§è¡Œçš„æ–­ç‚¹å¤„æ—¶ï¼Œå¼ºåˆ¶kill clientç«¯ï¼Œæ­¤æ—¶ç»§ç»­æ‰§è¡Œserverç«¯ä»£ç è¾“å‡ºå“åº”ä½“ï¼Œserverç«¯å°±ä¼šæŠ¥é”™<code>ConnectionResetError: [Errno 54] Connection reset by peer</code><br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images20241219224340496.png" alt="image.png"></p>
<h3>2.1.3. Broken pipe</h3>
<p>Broken pipeå®é™…ä¸Šæ˜¯ä¸€ä¸ªä¸åº”è¯¥å‡ºç°çš„é”™è¯¯ï¼Œç”šè‡³å¯ä»¥ç†è§£ä¸ºæ˜¯ä¸€ä¸ªbugï¼Œè¡¨æ˜äº†ä½ åœ¨å¾€ä¸€ä¸ªå·²ç»å…³é—­çš„socketä¸­å†™æ•°æ®ã€‚å½“å¯¹ç«¯å› ä¸ºç§ç§åŸå› éœ€è¦å¼ºåˆ¶å…³é—­è¿æ¥çš„æ—¶å€™ä¼šå‘é€RSTï¼Œè¿™æ—¶å€™åº”ç”¨æ•è·ä¼šæŠ¥é”™Connection reset by peerï¼Œè€Œå½“ä½ ä¸é¡¾è¿™ä¸ªé”™è¯¯ï¼Œç»§ç»­å†™çš„æ—¶å€™ï¼Œå°±ä¼šæŠ¥é”™Broken pipeã€‚</p>
<h3>2.1.4. Connection refused</h3>
<ol>
<li><strong>æœåŠ¡æœªå¯åŠ¨</strong>ï¼šæ¯”å¦‚ä½ å°è¯•è®¿é—®ä¸€ä¸ªWebæœåŠ¡å™¨ï¼Œä½†WebæœåŠ¡å™¨è½¯ä»¶æ²¡æœ‰è¿è¡Œèµ·æ¥ï¼Œé‚£ä¹ˆåœ¨å®ƒå¯¹åº”çš„ç«¯å£ï¼ˆå¦‚80ç«¯å£ç”¨äºHTTPæœåŠ¡ï¼‰å°±æ²¡æœ‰æœåŠ¡åœ¨ç›‘å¬ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯å°±ä¼šæ”¶åˆ°â€œConnection refusedâ€çš„åé¦ˆã€‚</li>
<li><strong>é˜²ç«å¢™é˜»æ­¢</strong>ï¼šé˜²ç«å¢™è§„åˆ™å¯èƒ½ä¼šé˜»æ­¢å®¢æˆ·ç«¯å¯¹ç‰¹å®šç«¯å£çš„è®¿é—®ã€‚å³ä½¿æœåŠ¡å™¨åœ¨æ­£å¸¸è¿è¡Œå¹¶ä¸”ç›‘å¬äº†ç›¸åº”ç«¯å£ï¼Œä½†é˜²ç«å¢™è®¾ç½®å¯èƒ½ä¼šå¯¼è‡´è¿æ¥è¯·æ±‚è¢«æ‹’ç»ï¼Œå®¢æˆ·ç«¯åŒæ ·ä¼šæ”¶åˆ°â€œConnection refusedâ€çš„æ¶ˆæ¯ã€‚<br>åœ¨ä¸å¯åŠ¨serverçš„æƒ…å†µä¸‹ï¼Œç›´æ¥å¯åŠ¨clientå‘é€è¯·æ±‚ï¼Œå¯ä»¥å‘ç°tcpç¬¬ä¸€æ¬¡æ¡æ‰‹åï¼Œç›´æ¥è¢«serverå‘é€RSTæ‹’ç»äº†ï¼Œæ­¤æ—¶å®¢æˆ·ç«¯ä¼šæŠ¥é”™<code>ConnectionRefusedError: [Errno 61] Connection refused</code>ã€‚<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images20241219224619720.png" alt="image.png"></li>
</ol>
<h3>2.1.5. 502 Bad Gateway</h3>
<p>ä¸å»ºè®®å¤šä¸ªLBæŒ‚ç›¸åŒçš„åç«¯èŠ‚ç‚¹ï¼Œå¯¹äºå®¢æˆ·ç«¯æ¥è¯´ï¼Œçœ‹åˆ°çš„æ˜¯ä¸åŒçš„ç›®çš„IPï¼Œæ­¤æ—¶å¯èƒ½æºç«¯å£ä¼šå¤ç”¨ã€‚ç¬¬äºŒä¸ªè¯·æ±‚å‘é€çš„synåŒ…å¯¹æœåŠ¡ç«¯æ¥è¯´æ˜¯ä¸å¯æ¥å—çš„ï¼Œå› æ­¤serverç«¯å‘é€rstå°†è¿æ¥ä¸­æ–­ï¼Œä»è€Œå¯¼è‡´ä¸¤ä¸ªè¯·æ±‚éƒ½å¤±è´¥ï¼ˆä¹Ÿæœ‰è¯·æ±‚æ˜¯ï¼Œå‘é€synåç«‹é©¬æ”¶åˆ°äº†serverå¯¹äºç¬¬ä¸€ä¸ªè¿æ¥çš„ackæˆ–è€…pshæŠ¥æ–‡ï¼Œè¿™æ—¶å€™clientä¹Ÿä¼šè®¤ä¸ºå¼‚å¸¸ï¼Œä»è€Œå‘é€rståˆ°æœåŠ¡ç«¯ï¼‰ã€‚è¿™ç§æƒ…å†µä¸‹ï¼ŒLBéƒ½æ— æ³•ä¸åç«¯æœåŠ¡å»ºç«‹æ­£å¸¸è¿æ¥ï¼Œå› æ­¤ä¼šæŠ¥é”™è¿”å›502ã€‚</p>
<p>LBèŠ‚ç‚¹è¶…æ—¶æ—¶é—´æ¯”åç«¯Serverè¶…æ—¶æ—¶é—´è¦é•¿ï¼Œæœ‰æ¦‚ç‡å¯¼è‡´LBä½¿ç”¨äº†å·²ç»è¢«åç«¯å…³é—­çš„è¿æ¥ï¼Œæ­¤æ—¶ä¹Ÿä¼šå»ºé“¾å¤±è´¥ï¼Œä»è€ŒæŠ¥é”™502ã€‚</p>
<h1>3. è¿æ¥æ± </h1>
<p>HttpClientä¸­ä½¿ç”¨äº†è¿æ¥æ± æ¥ç®¡ç†æŒæœ‰è¿æ¥ï¼ŒåŒä¸€æ¡ TCP é“¾è·¯ä¸Šï¼Œè¿æ¥æ˜¯å¯ä»¥å¤ç”¨çš„ã€‚HttpClient é€šè¿‡è¿æ¥æ± çš„æ–¹å¼è¿›è¡Œè¿æ¥æŒä¹…åŒ–ã€‚å…¶å®â€œæ± â€æŠ€æœ¯æ˜¯ä¸€ç§é€šç”¨çš„è®¾è®¡ï¼Œå…¶è®¾è®¡æ€æƒ³å¹¶ä¸å¤æ‚ï¼š</p>
<ol>
<li>å½“æœ‰è¿æ¥ç¬¬ä¸€æ¬¡ä½¿ç”¨çš„æ—¶å€™å»ºç«‹è¿æ¥</li>
<li>ç»“æŸæ—¶å¯¹åº”è¿æ¥ä¸å…³é—­ï¼Œå½’è¿˜åˆ°æ± ä¸­</li>
<li>ä¸‹æ¬¡åŒä¸ªç›®çš„çš„è¿æ¥å¯ä»æ± ä¸­è·å–ä¸€ä¸ªå¯ç”¨è¿æ¥</li>
<li>å®šæœŸæ¸…ç†è¿‡æœŸè¿æ¥</li>
</ol>
<h1>4. reference</h1>
<p><a href="https://blog.csdn.net/rickiyeat/article/details/107900585?sharetype=blogdetail&shareId=107900585&sharerefer=APP&sharesource=jstxzhangrui&sharefrom=link">https://blog.csdn.net/rickiyeat/article/details/107900585?sharetype=blogdetail&amp;shareId=107900585&amp;sharerefer=APP&amp;sharesource=jstxzhangrui&amp;sharefrom=link</a></p>
<p>!<a href="httpåè®®è§£æ.html" class="internal-link">HTTPåè®®è§£æ</a></p>
}
    </section>
</article>
            </div>
        </main>
        <footer class="page-footer">
            <div class="container">
                <p>&copy; 2026 Shinerio's Blog. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Theme switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.getElementById('theme-body');

            // Check for saved theme preference or respect OS preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            // Set initial theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
                body.setAttribute('data-theme', 'dark');
            } else {
                body.removeAttribute('data-theme'); // light theme
            }

            // Toggle theme function
            function toggleTheme() {
                if (body.getAttribute('data-theme') === 'dark') {
                    body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Add event listener to theme toggle button
            themeToggle.addEventListener('click', toggleTheme);

            // Listen for OS theme changes
            prefersDarkScheme.addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        body.setAttribute('data-theme', 'dark');
                    } else {
                        body.removeAttribute('data-theme');
                    }
                }
            });

            // Search functionality
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchResults = document.getElementById('search-results');
            const searchSuggestions = document.getElementById('search-suggestions');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');

            if (searchInput && searchButton) {
                let searchData = null;

                // Load search data
                async function loadSearchData() {
                    try {
                        const response = await fetch('./assets/js/search-data.json');
                        if (response.ok) {
                            searchData = await response.json();
                        } else {
                            console.error('Failed to load search data:', response.status);
                        }
                    } catch (error) {
                        console.error('Error loading search data:', error);
                    }
                }

                // Initialize search data
                loadSearchData();

                // Debounce function to limit search calls
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // Get selected search type
                function getSelectedSearchType() {
                    const selectedRadio = document.querySelector('input[name="search-type"]:checked');
                    return selectedRadio ? selectedRadio.value : 'all';
                }

                // Perform search
                function performSearch(query) {
                    if (!searchData || !query.trim()) {
                        searchResults.innerHTML = '';
                        searchSuggestions.innerHTML = '';
                        return;
                    }

                    const queryTerms = query.toLowerCase().split(/\s+/).filter(term => term.length > 0);
                    const searchType = getSelectedSearchType();

                    if (queryTerms.length === 0) {
                        searchResults.innerHTML = '';
                        return;
                    }

                    const results = [];

                    // Search through articles
                    searchData.articles.forEach(article => {
                        let score = 0;
                        let snippet = '';

                        // Get content based on search type
                        const lowerTitle = article.title.toLowerCase();
                        const lowerContent = article.content.toLowerCase();
                        const lowerTags = article.tags.join(' ').toLowerCase();

                        queryTerms.forEach(term => {
                            switch(searchType) {
                                case 'title':
                                    // Only title matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    break;
                                case 'content':
                                    // Only content matches count (fixed to exclude title matches)
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    break;
                                case 'all':
                                default:
                                    // Both title and content matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    // Tag matches get medium-high score
                                    if (lowerTags.includes(term)) {
                                        score += 5;
                                    }
                                    break;
                            }
                        });

                        if (score > 0) {
                            // Generate snippet based on search type
                            let content = '';

                            if (searchType === 'title') {
                                // For title-only search, show title content
                                content = article.title.substring(0, 200);
                            } else if (searchType === 'content') {
                                // For content-only search, show content excerpt
                                content = article.content.substring(0, 200);
                            } else {
                                // For all search, show content with title as context
                                content = article.content.substring(0, 200);
                            }

                            // Find first occurrence of query term in content for snippet
                            queryTerms.forEach(term => {
                                let searchIn = content.toLowerCase();
                                if (searchType === 'title') {
                                    searchIn = lowerTitle;
                                } else if (searchType === 'content') {
                                    searchIn = lowerContent;
                                }

                                const index = searchIn.indexOf(term);
                                if (index !== -1) {
                                    // Expand snippet around the match
                                    let start, end;
                                    if (searchType === 'title') {
                                        start = Math.max(0, index - 15);
                                        end = Math.min(content.length, index + term.length + 35);
                                    } else {
                                        start = Math.max(0, index - 30);
                                        end = Math.min(content.length, index + term.length + 70);
                                    }

                                    content = (start > 0 ? '...' : '') +
                                              content.substring(start, end) +
                                              (end < (searchType === 'title' ? article.title.length : article.content.length) ? '...' : '');

                                    // Highlight the term in the snippet
                                    const searchContent = searchType === 'title' ? article.title : article.content;
                                    const adjustedIndex = searchType === 'title' ?
                                        Math.min(index, article.title.length - 1) :
                                        Math.min(index, article.content.length - 1);

                                    content = content.replace(
                                        new RegExp(`(${escapeRegExp(term)})`, 'gi'),
                                        '<mark>$1</mark>'
                                    );
                                }
                            });

                            results.push({
                                article: article,
                                score: score,
                                snippet: content
                            });
                        }
                    });

                    // Sort results by score
                    results.sort((a, b) => b.score - a.score);

                    // Display results
                    displaySearchResults(results);
                }

                // Display search results
                function displaySearchResults(results) {
                    if (results.length === 0) {
                        searchResults.innerHTML = '<p class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>';
                        return;
                    }

                    const resultsHTML = results.map(result => `
                        <div class="search-result-item">
                            <h3 class="search-result-title">
                                <a href="./${result.article.slug}.html">${highlightQueryTerms(result.article.title, document.querySelector('#search-input').value)}</a>
                            </h3>
                            <div class="search-result-meta">
                                ${result.article.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                            </div>
                            <p class="search-result-excerpt">${result.snippet}</p>
                        </div>
                    `).join('');

                    searchResults.innerHTML = resultsHTML;
                }

                // Highlight query terms in text
                function highlightQueryTerms(text, query) {
                    if (!query.trim()) return text;

                    const queryTerms = query.split(/\s+/).filter(term => term.length > 0);
                    let highlightedText = text;

                    queryTerms.forEach(term => {
                        const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');
                    });

                    return highlightedText;
                }

                // Escape special regex characters
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Event listener for search button
                searchButton.addEventListener('click', function() {
                    const query = searchInput.value;
                    performSearch(query);
                });

                // Event listener for Enter key
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        const query = searchInput.value;
                        performSearch(query);
                    }
                });

                // Add debounced input handler for live search (optional)
                const debouncedSearch = debounce(function() {
                    const query = searchInput.value;
                    performSearch(query);
                }, 300);

                searchInput.addEventListener('input', debouncedSearch);

                // Add event listeners for search type radios
                searchTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const query = searchInput.value;
                        if (query.trim()) {
                            performSearch(query);
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>