---
title: 负载均衡
date: 2022-05-01
categories:
- 网络安全
tags: 负载均衡
- ELB
- 负载均衡
---

对于一个简单的demo项目来说，我们可以用一个单体架构完成，而实际的线上应用普遍面临着高并发、高流量问题。作为一个上线的项目，对服务的可靠性还是有很高要求的，因此会选择使用一组服务器作为集群来提供服务，以此来保证单节点的处理性能以及保证服务的高可靠。如何将请求分担到不同的后端节点上，这就是负载均衡做的事情。

<!--more-->

# 1. 四层负载均衡和七层负载均衡

四层负载均衡工作在OSI模型的传输层，主要工作就是流量转发，它在接口到客户端的流量以后通过修改数据包地址信息的方式将流量转发到应用服务器。七层负载均衡工作在OSI模型的应用层，因此需要解析应用层的流量，所以七层负载均衡在接收到客户端的流量以后需要经过一个完成的TPC/IP协议栈。七层负载均衡与客户端建立一条完成的连接并将应用层的请求流量解析出来，再按照调度算法选择一个应用服务器，并与应用服务器建立另外一条连接将请求发送出去，因此七层负载均衡的本质就是反向代理。七层负载均衡在四层负载均衡的基础上，再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据IP+PORT，还可根据七层的URL、浏览器类别、语言、Cookie来决定是否要进行负载均衡。举个例子，如果你的Web服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。目前主流的负载均衡主要是基于nginx，haproxy和lvs实现，其中nginx和haproxy主要用于七层负载均衡，lvs主要用于四层lvs。

![](https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images/uncategoryload+balance.png)

> 四层的本质是转发，七层的本质是代理。

由于七层负载均衡经过的协议栈链路更长，解析内容更多，且需要分别和client和server建立独立的两条tcp连接，因此通常情况下七层负载均衡的性能是要**稍**弱于四层负载均衡的，而七层应用负载均衡的好处，是使得整个网络更“智能化”。一个常见的场景就是API网关，其就是通过七层的方式实现的，可以将不同的url转发到不同的后端服务器组上，作为内部多个微服务组件的统一外部访问入口。且正是由于API网关工作在七层，API网关能承担起鉴权、过滤、流控和防SYN攻击的能力。API网关在可以对用户的请求header进行重写或响应response添加字段等。云服务时代，网络常见的鉴权方式有TOKEN、AK/SK等，API网关可以对API进行统一鉴权，在鉴权通过后统一转化为TOKEN放入到请求header中，对内部服务屏蔽细节，减少内部服务的适配难度。API网关还可以对请求body提进行过滤，防止命令注入和sql注入等。另外一个常常被提到功能就是安全性，网络中最常见的SYN Flood攻击，即使用虚假IP地址对同一目标发送SYN攻击。通常这种攻击会大量发送SYN报文，快速耗尽服务器的连接资源，以达到Denial of Service(DoS) 的目的。从技术原理上也可以看出，四层模式下这些 SYN 攻击都会被转发到后端的服务器上，而七层负载均衡由于client和负载均衡器无法建立完整的tcp连接，自然也不会对后端发起请求，不会影响后端服务器的正常运行。现在的七层负载均衡，主要还是着重于应用广泛的 HTTP 协议，所以其应用范围主要是众多的网站或者内部信息平台等基于 B/S 开发的系统，4 层负载均衡则对应其他 TCP 应用，例如基于 C/S 开发的 ERP 等系统。


 # 2. 七层负载均衡
 
 ## 2.1 nginx
 
 Nginx（发音同engine x）是一个网页服务器，它能反向代理HTTP, HTTPS, SMTP, POP3, IMAP的协议链接，以及一个负载均衡器和一个HTTP缓存。

Nginx主要用来做七层负载均衡。

 ## 2.2 haproxy
 
 HAProxy是一个使用C语言编写的自由及开放源代码软件，其提供高可用性、负载均衡，以及基于TCP和HTTP的应用程序代理。

Haproxy主要用来做七层负载均衡。
 
# 3. 四层负载均衡lvs

# 5. 硬件负载均衡

F5

# 6. 负载均衡算法

# 7. ECMP

# 8. DNS + ECMP + LVS + NGINX
# 8. 参考链接

1. [MGW——美团点评高性能四层负载均衡](https://tech.meituan.com/2017/01/05/mgw.html)
2. [四层、七层负载均衡的区别](https://cloud.tencent.com/developer/article/1082047)