---
title: ali-intern
date: 2019-09-04
categories:
- 项目
tags:
- 项目
password: loveshinerio   
abstract: 实验室项目整理
message: 密码 
---

## 库存分配策略

逻辑分散，代码重复实现，烟囱林立，维护难。给定业务诉求和单据信息，结合库存情况，完成库存的选择排序，最终完成库存占用

**主要难点：**

- 领域模型设计
- 规则配置
- 分配计算
- 行锁问题

**主要技术：**

RPC(HSF)，SPI扩展，QL表达式引擎，排队分流

### 领域模型设计

库区、商品效期、库存状态、波次类型、包装类型等因子——>抽象为原子规则。

商品类型、商品数量、订单类型等——>匹配因子

### 规则生成

运用`unit of wort`模式、工厂模式、策略模式和责任链模式等。动态数据源选择、模型构建与转化。

### 规则计算

- 库存内部接口，完成基本需求

  控制商品效期，不允许失效商品出库——>选择器

  根据库区优先级判断从哪个库区出库——>排序器

- SPI扩展，利用库存无法感知的一些信息进行库存过滤和排序

  不同行业或者业务方实现，库存以二方包形式动态加载

- QL表达式引擎，应对复杂场景进行

  通过规则表达式引擎，可以在程序运行时获取具体排序筛选规则，使用灵活

### 库存占用之排队分流引擎

**数据存放及格式：**

数据库中存放订单明细完整信息：sku+num+docCode

库存与上游通过消息队列进行任务解耦，消费metaQ消息，将sku信息做hash对预定义的"桶数"取余得key值，调度数据本身(sku+调度任务层级)作为value，以`Map<Key, Set<Value>>`的数据格式存入redis中，形成一级分流，并且为每个value记录了score值，用于一级排队。

二级分流，使用一致性hash算法把每个“桶”分给集群中的每台机器（同样的sku会被hash取余后key相同，进入相同的redis桶），每台机器内部启动调度线程拉取任务，根据调度任务分发到不同的queue中(一级账占用，二级账占用)。最后启动多线程监听任务执行Queue，根据订单明细优先级来完成二级排队。最后根据执行结果决定是否清理redis中调度任务

### 意义

- 订单拆成明细维度解决一个订单多个明细同时占用带来的行锁问题

- 流量削峰、流量整形





 