各位评委老师，大家好，我是实习生墨海，6月以来我一直在菜鸟仓储技术部库存小组实习，收获了很多，成长了很多，今天我将对我这段时间以来的学习和工作内容做一个总结和陈述。

从个人介绍、学习情况、工作内容和个人感悟等角度出发，我的答辩主要分为以下5个部分。

首先请允许我做一个简要的自我介绍。

我本科就读于北京科技大学，以专业第三的成绩保研到了北京邮电大学。学业取得良好成绩的同时，我还获得了多个奖项，包括研究生创新创业大赛的第一名，阿里巴巴天池比赛冠军，coco 关键点挑战赛第三名等。我还发表了一篇国际学术论文，作为第一发明人拥有一项专利。我有过两段实习经验，做过算法，干过开发，对技术始终充满热情。

第二部分以及第三部分主要对我实习工作的一个总结，其中我独立设计开发的两个项目都已经上线并投入使用。首先库存分配策略相关，我将以领域模型设计为视角展开介绍。

库存管理系统中，对库存做移动、扣减等操作前，都需要先锁定库存。库存分配策略解决的是在给定业务诉求，单据信息的条件下，如何完成库存的选择和分配的问题。库存占用作为一个基础服务，占用逻辑根据业务不同而不同，分散在各个行业和上层系统中，并行烟囱林立，代码逻辑重复实现，维护难，库存分配策略的核心目标对库存占用逻辑进行收拢和整合，通过配置化的方式适应不断变化的业务需求。库存分配策略整体上可以分为两步，策略匹配以及规则控制。策略匹配主要是根据单据信息进行匹配（DocAttributeMap），行业或链路有特殊业务诉求也可以直接指定规则（AllocateFactorMap）。库存占用中的常见诉求是指定库区或库区状态，按效期规则先过期先出等。对这些规则进行领域建模，可以将其抽象为原子规则，这些原子规则可以通过表达式引擎，库存内部逻辑实现，行业实现spi扩展点等方式实现。原子规则组成原子规则组，完成了对库存的过滤和排序。

库存分配链路接入了多条链路，我主要负责对复短拣链路进行了库存分配策略的升级改造，工作内容主要有5部分组成。下面我将以复拣链路为例，梳理一下库存分配的完整过程。gis系统以明细为力度进行占用，复短拣链路和gis通过特殊的标来决定是否允许订单部分占用。库存分配策略以二方包的形式接入gis系统，库存分配策略的输入主要有两个维度，库存情况以及业务需求。库存分配策略通过业务指定或者单据匹配的方式得到，如果这两种情况都失败，我设计并提供了fallover机制，保障库存占用能够正常实现。规则控制作为库存分配策略的核心，主要分为选择器和排序器。我通过效期选择器实现了对商品禁售日期、宽限时间等的控制。对于复短拣链路来说，有一个诉求是，比如原先在agv拣选区的，复短拣过程中优先从agv区占，从底层服务能力的角度出发，这个诉求可以抽象为对库存优先级占用的控制，这个我通过了一个库存排序器来实现。功能实现的最后一步是进行完备的测试，通过HSF OPS和MOCk机制我进行了完备的接口测试和单元测试，顺利保证了复短拣链路的平稳升级。

我独立设计并实现的第一个项目是库存导入。库存分配策略是以仓库维度来进行环境隔离的，层级多，规则复杂，人工配置成本高。通过模板拷贝功能，可以快速的实现从Diamond或源仓库database向目标仓库database的数据导入。从用户发起请求到规则持久化到目标仓库，核心功能点主要有三部分，动态数据源仓库，规则模型的构建以及规则模型的转换功能。

库存模板功能的实现，我主要用到了三种设计模式来提高代码的可读性以及扩展性。

从构建请求出发，库存模板拷贝可能存在的需求有全仓拷贝，根据规则或者规则组的code或者id进行。由于库存分配策略模型复杂，拷贝过程往往涉及多层数据结构，且相互之间存在依赖关系，业务处理过程中需要进行复杂、频繁的参数传递。使用请求容器模式，把一次请求中依赖的基础数据、中间临时结果存储在以一次请求为声明周期的容器中，容器整个流程可见，不需要进行复杂的参数透传，业务代码实现能力提供。对于模型数据的处理也可以代理给容器，避免在不同流程中重复实现相同逻辑，减少代码复杂性。容器对数据进行缓存，最终进行一致性提交，减少了事务的粒度，提升了性能。测试过程直接对容器对象进行mock，提升了代码的可测性。

库存拷贝不仅可以从数据库中获取源数据，还可以从diamond中获得，同时为了应付可能存在的更多数据源。底层数据查询我采用的工厂模式+策略模式的设计方案。程序运行时动态生产查询接口模型，动态决定查询接口行为。

库存分配策略结构大致分为6层，上层依赖下层，层层递进。对于源仓库到目标仓库的转换可以抽象为一个责任链模式，每个节点负责处理自己责任范围内的数据模型转化，并对上层提供数据支持，业务职责划分清晰，各层之间接口透明，细节隐藏，同时可以实现流程的动态调整。

第一个项目主要是体现了我领域模型设计的能力，我独立设计完成的第二个项目是库存导入，在上周上线并帮助韩国TOF仓库完成了向大宝WMS的库存数据迁移任务。这个项目，我将从系统设计、技术选型的角度来进行总结介绍。

随着菜鸟的仓储系统大宝的迅速发展，整个经济体内越来越多的仓库和行业希望切换大宝。基本都是从其他的WMS切平台换到大宝WMS。这中间面临的一个首要问题就是如何做数据的迁移。我设计的库存导入主要分为四条核心链路。用户下载模板，本地填充数据，通过大宝系统，数据上传至oss仓库。系统对oss中数据进行一步校验工作，主要是是进行基础域数据的合法性验证。对于校验失败的数据，用户可以通过系统从oss中导出并进行更正。校验成功的数据将存入临时表，用户可以对临时表进行数据检索，确认数据无误后，可以进行库存通过，完成一二三级账的构建。

前端主要通过toffee平台完成，这是我的一个前端UI示意图。

库存导入的核心功能都是通过异步完成， 流程之间需要进行互斥资源控制，这个可以通过tair的分布式锁完成。但是核心功能之间可能存在相互调用关系，比如在数据导入后，用户可以选择立即进行数据校验，数据导入与校验两部分都需要加锁，由于tair不支持锁重入功能，导致锁失败。因此我结合了reentrantlock和以及分布式的特点，设计并改造了tair锁，实现可重入功能。锁资源是以仓库为维度的，将warehouseId作为key。为了赋予tair锁更多的功能，value的设计需要包含更多的语义信息。利用机器ip+jvm进程号+线程ip可以唯一定位一台机器上的一个jvm进程中的唯一线程，通过重入计数来达到同一线程重复加锁的功能。

数据校验整个项目中最为复杂和耗时的流程。主要可以分为三步，数据校验的主要使用了流式处理，阻塞队列，多线程并行处理等技术。全流程使用流式处理，可以避免在内存中缓存过多的数据，降低内存消耗。通过两个阻塞队列，利用生产者消费者模型进行异步任务解耦，流量削峰等功能。因为数据校验过程需要频繁通过hsf与基础域进行交互，是整个系统的瓶颈所在，这一部分，我使用了线程池的方式进行并行化处理。validate的过程非常耗时导致两个生产消费模型面临不同的问题。首先excelParser作为生产者从oss中拉取任务，放到线程任务池中，validator作为消费者，多线程进行数据消费，生产速度小于消费速度。为了保证消息的正常消费，有两种策略可以使用，一种是使用无限容量的任务队列，这样做的好处是实现简单，但是会存在队列过大，内存消耗过高的风险，我采用的方式是使用线程池的拒绝策略，当任务达到队列上限时，通过使用阻塞队列put方法将生产线程阻塞。当validator作为生产者提供数据，excelwriter作为消费者写文件时，生产速度远远小于消费速度，为了保证消费线程能够在任务未完成时阻塞等待数据，任务结束后及时关闭线程，我设计了一套线程协同方案。拉取任务结束后，关闭校验任务线程池，阻塞等待所有校验任务完成，通知写线程进入任务结束准备状态，同时打断写线程可能存在的阻塞状态，阻塞等待写线程完成剩余写入任务，确认所有数据校验成功后，将数据导入临时表中。

阿里有众多优秀的中间件产品

以metaQ为例，介绍一下我中间件学习的心得。略。。。。略。。。

最后我想谈一谈我在工作中的一些体会和思考。首先以我在项目中解决的一个线上bug为例，一个Spring事务相关的问题。在进行库存分配策略拷贝的过程中发生了异常，数据没有回滚，师兄指出了我的错误，在同一类的方法内部调用另一个方法，事务不会不会生效，需要将事务声明在直接调用方法之上。这个问题涉及到Spring事务原理相关，spring通过aop的方式，用代理模式将事务逻辑编织到业务代码中，反射调用方法，所以只能管理直接调用的方法，对于方法内部的实现细节其实是隐藏的。事情并没有这么顺利，更改使用方式后事务依然没有生效。于是通过我自己的一个小问题，深挖下去，发现了线上系统的存在的bug——一个由@Transactional注解引发的血案。通过源码阅读我发现Spring事务时通过TransactionManager完成的，而Transactionmanager是由TransactionInterceptor中的determineTransactionManager方法指定的，而项目中配置了两个数据源，在未指定TransactionManager的情况下，Spring默认使用了第一个声明事务管理器，导致了操作数据源B的所有事务都没有生效，也就是说线上系统中有一半的事务都是未生效的。最后问题解决很简单，在声明事务的时候，指定事务管理器就可以了。这里我有自己的一个小思考，Spring的事务机制其实是不合理的，Datasource-sessionFactory以及TransactionManager其实是一对一关系，Spring应该是有能力动态决定TransactionManager，而不是采用默认机制，留下一个隐患。

在做库存分配策略保税行业联调支持的过程中，出现了线上运行代码与实际发布不一致的情况，利用Arthas反编译jvm中的class发现，存在两个类全限定名相同，行业编码也一致的两个版本的类，导致新发布的代码一直没有生效。联想到之前对pandora的学习，可以总结解决类冲突的一类问题。java通过类权限定名和类加载器判定两个类是否相同，对于类全限定名完全一致的，可以通过类加载器进行隔离。Pandora利用这个来实现阿里中间件依赖的隔离，菜鸟park平台利用这个机制实现了行业扩展包的隔离。

来菜鸟也接近三个月，我想谈谈我对阿里，对菜鸟，对我所在部门的一点认知。信息流、商流、资金流和物流作为阿里巴巴集团的基石，支撑着阿里的快速发展。而物流作为四流中唯一的重资产，可以成为百年阿里的护城河。 而菜鸟就是阿里在物流方面的布局，打通了买家和买家之前的联系。对于物流来说土地、仓库是最重要的资产，而这些资产的运作都离不开仓储部门的努力。商品在仓库的库存信息是仓库的核心任务之一，这也是我所在库存小组的核心任务。我对库存小组的理解是，我们的定位是基础平台，中级目标是做到账实一致，最终库存作为一个底层系统，通过能力平台的方式透出各种能力，支撑不断变化的业务。

最后，我想用一个闭环来总结一下我学习工作中的方法论。项目源于业务，高于业务，完成功能只是最低要求，我们要重设计，提供足够高的扩展性，我们库存小组最常说的一句话就是，你们这个业务需求我们天然支持，零代码改动成本，这就是重设计的功能。做项目过程中，需要勤思考，不断迭代，寻求改进，对业务需求中的共同点做抽象。完成业务后需要善总结，在菜鸟实习的这段时间以来，处理日常周报外，我还沉淀了接近30篇技术博客。最后最重要的一点就是需要持续学习，不断提高自我，学习新技术，阅读源码，阅读书籍等。

我的答辩到此结束，谢谢大家。