<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geneveéš§é“é…ç½® - Shinerio's Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="article-page" id="theme-body">
    <div class="page-wrapper">
        <header class="page-header">
            <div class="container">
                <nav class="page-nav">
                    <div class="nav-links">
                        <a href="index.html" class="nav-link ">Home</a>
                        <a href="articles.html" class="nav-link ">Articles</a>
                        <a href="search.html" class="nav-link ">Search</a>
                    </div>
                    <div class="theme-toggle-container">
                        <button id="theme-toggle" aria-label="Toggle dark mode" class="theme-toggle-btn">
                            <span class="sun-icon">â˜€ï¸</span>
                            <span class="moon-icon">ğŸŒ™</span>
                        </button>
                    </div>
                </nav>
            </div>
        </header>
        <main class="page-main">
            <div class="container">
                <article>
    <header>
        <h1>Geneveéš§é“é…ç½®</h1>
        <time datetime="2026-01-03T13:04:29.257Z">2026å¹´1æœˆ3æ—¥</time>
        <div class="tags">
            
        </div>
    </header>
    <section class="content">
        {<h1>1. geneveåè®®æ ¼å¼</h1>
<p><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images20250106234908676.png" alt="image.png"><br>GENEVEä¸VXLANç±»ä¼¼ï¼Œä»ç„¶æ˜¯Ethernet over UDPï¼Œä¹Ÿå°±æ˜¯ç”¨UDPå°è£…Ethernetã€‚VXLAN headeræ˜¯å›ºå®šé•¿åº¦çš„ï¼ˆ8ä¸ªå­—èŠ‚ï¼Œå…¶ä¸­åŒ…å«24bit VNIï¼‰ï¼Œä¸VXLANä¸åŒçš„æ˜¯ï¼ŒGENEVE headerä¸­å¢åŠ äº†TLVï¼ˆType-Length-Valueï¼‰ï¼Œç”±8ä¸ªå­—èŠ‚çš„å›ºå®šé•¿åº¦å’Œ0~252ä¸ªå­—èŠ‚å˜é•¿çš„TLVç»„æˆã€‚GENEVE headerä¸­çš„TLVä»£è¡¨äº†å¯æ‰©å±•çš„å…ƒæ•°æ®ã€‚<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images20250107000425787.png" alt="image.png"></p>
<ul>
<li>Versionï¼ˆ2bitï¼‰ï¼šç›®å‰æ˜¯0</li>
<li>Opt Lenï¼ˆ6bitï¼‰ï¼šä»¥4å­—èŠ‚ä¸ºå•ä½ï¼Œè¡¨æ˜Variable Length Optionsçš„é•¿åº¦ã€‚å› ä¸ºåªæœ‰6bitï¼Œæ‰€ä»¥Variable Length Optionsæœ€å¤šæ˜¯252ï¼ˆ63*4ï¼‰å­—èŠ‚ã€‚</li>
<li>Oï¼ˆ1bitï¼‰ï¼šè¡¨æ˜è¿™æ˜¯ä¸€ä¸ªOAMåŒ…ï¼ŒåŒ…å«äº†æ§åˆ¶ä¿¡æ¯ï¼Œè€Œéæ•°æ®ã€‚Endpointå¯ä»¥æ ¹æ®è¿™ä¸ªbitæ¥ä¼˜å…ˆå¤„ç†è¿™ä¸ªåŒ…ã€‚</li>
<li>Cï¼ˆ1bitï¼‰ï¼šè¡¨æ˜åœ¨Variable Length Optionsé‡Œé¢ï¼Œå­˜åœ¨ä¸€ä¸ªæˆ–è€…å¤šä¸ªCriticalçš„optionã€‚å½“Cè¢«ç½®ä½æ—¶ï¼ŒVariable Length Optionså¿…é¡»è¢«è§£æï¼Œå¦‚æœå½“å‰Endpointä¸æ”¯æŒGENEVEè§£æï¼Œé‚£ä¹ˆåº”è¯¥ä¸¢å¼ƒæ•°æ®åŒ…ã€‚å¦‚æœCæ²¡æœ‰è¢«ç½®ä½ï¼Œé‚£ä¹ˆEndpointå¯ä»¥æ ¹æ®Opt Lenç›´æ¥ä¸¢å¼ƒæ‰€æœ‰çš„Variable Length Optionsã€‚</li>
<li>Rsvd.ï¼ˆ6bitï¼‰ï¼šä¿ç•™å­—æ®µã€‚</li>
<li>Protocol Typeï¼ˆ16bitï¼‰ï¼šè¢«å°è£…çš„åè®®ç±»å‹ï¼Œä¾‹å¦‚Ethernetå°±æ˜¯0x6558ã€‚è¿™ä¸ªå­—æ®µçš„å­˜åœ¨ï¼Œä½¿å¾—GENEVEå°è£…å…¶ä»–çš„äºŒå±‚åè®®æˆä¸ºå¯èƒ½ã€‚</li>
<li>VNIï¼ˆ24bitï¼‰ï¼šVNIã€‚</li>
<li>Reservedï¼ˆ8bitï¼‰ï¼šä¿ç•™å­—æ®µã€‚</li>
<li>pVariable Length Optionsï¼šç”±TLVæ„æˆï¼ŒåŒ…å«äº†å¯æ‰©å±•çš„å…ƒæ•°æ®ã€‚</li>
</ul>
<h1>2. åŸºç¡€å®éªŒ</h1>
<p>å®¿ä¸»æœºæ·»åŠ geneveå£ï¼Œé…ç½®è·¯ç”±ä¸‹ä¸€è·³æŒ‡å‘geneveå£</p>
<pre><code class="language-shell"># host a with ip 192.168.0.251
sudo ip link add name geneve0 type geneve id 1000 remote 10.0.0.250
sudo ip link set geneve0 up
sudo ip addr add 11.200.1.1/32 dev geneve0
sudo ip route add 11.200.2.1/32 dev geneve0

# host b with ip 192.168.0.250
sudo ip link add name geneve0 type geneve id 1000 remote 10.0.0.251
sudo ip link set geneve0 up
sudo ip addr add 11.200.2.1/32 dev geneve0
sudo ip route add 11.200.1.1/32 dev geneve0
</code></pre>
<p>host aæŠ“åŒ…</p>
<pre><code class="language-shell">root@iZbp13m4rux6j370521ygbZ:~# tcpdump udp port 6081 -nne -vvvv
tcpdump: listening on eth0, link-type EN10MB (Ethernet), snapshot length 262144 bytes
22:47:57.358107 ee:ff:ff:ff:ff:ff &gt; 00:16:3e:13:d7:e3, ethertype IPv4 (0x0800), length 148: (tos 0x0, ttl 64, id 32272, offset 0, flags [none], proto UDP (17), length 134)
    10.0.0.250.13206 &gt; 10.0.0.251.6081: [no cksum] Geneve, Flags [none], vni 0x3e8, proto TEB (0x6558)
    f6:ed:db:8e:76:6e &gt; 76:4d:d9:e8:20:34, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 53977, offset 0, flags [DF], proto ICMP (1), length 84)
    11.200.2.1 &gt; 11.200.1.1: ICMP echo request, id 4534, seq 45, length 64
22:47:57.358154 00:16:3e:13:d7:e3 &gt; ee:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 148: (tos 0x0, ttl 64, id 15677, offset 0, flags [none], proto UDP (17), length 134)
    10.0.0.251.50482 &gt; 10.0.0.250.6081: [no cksum] Geneve, Flags [none], vni 0x3e8, proto TEB (0x6558)
    76:4d:d9:e8:20:34 &gt; f6:ed:db:8e:76:6e, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 18896, offset 0, flags [none], proto ICMP (1), length 84)
    11.200.1.1 &gt; 11.200.2.1: ICMP echo reply, id 4534, seq 45, length 64
22:47:58.382102 ee:ff:ff:ff:ff:ff &gt; 00:16:3e:13:d7:e3, ethertype IPv4 (0x0800), length 148: (tos 0x0, ttl 64, id 32583, offset 0, flags [none], proto UDP (17), length 134)
    10.0.0.250.13206 &gt; 10.0.0.251.6081: [no cksum] Geneve, Flags [none], vni 0x3e8, proto TEB (0x6558)
    f6:ed:db:8e:76:6e &gt; 76:4d:d9:e8:20:34, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 54651, offset 0, flags [DF], proto ICMP (1), length 84)
    11.200.2.1 &gt; 11.200.1.1: ICMP echo request, id 4534, seq 46, length 64
22:47:58.382151 00:16:3e:13:d7:e3 &gt; ee:ff:ff:ff:ff:ff, ethertype IPv4 (0x0800), length 148: (tos 0x0, ttl 64, id 16143, offset 0, flags [none], proto UDP (17), length 134)
    10.0.0.251.50482 &gt; 10.0.0.250.6081: [no cksum] Geneve, Flags [none], vni 0x3e8, proto TEB (0x6558)
    76:4d:d9:e8:20:34 &gt; f6:ed:db:8e:76:6e, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 19382, offset 0, flags [none], proto ICMP (1), length 84)
    11.200.1.1 &gt; 11.200.2.1: ICMP echo reply, id 4534, seq 46, length 64
</code></pre>
<h1>3. geneveå£æ”¾ç½®åˆ°è‡ªå®šä¹‰ç½‘æ¡¥ä¸­</h1>
<p>å°†geneveå£æ”¾åˆ°ç½‘æ¡¥ä¸Šï¼Œè·¯ç”±ä¸‹ä¸€è·³æŒ‡å‘br0</p>
<pre><code class="language-shell"># host a with ip 192.168.0.251
brctl addbr br0
ip address add 12.200.1.1/24 dev br0
ip link set br0 up
ip link add name geneve1 type geneve vni 1000 remote 10.0.0.250 dstport 6082
ip link set geneve1 up
brctl addif br0 geneve1

# host a with ip 192.168.0.250
brctl addbr br0
ip address add 12.200.1.2/24 dev br0
ip link set br0 up
ip link add name geneve1 type geneve vni 1000 remote 10.0.0.251 dstport 6082
ip link set geneve1 up
brctl addif br0 geneve1
</code></pre>
<p>æŠ“åŒ…å¦‚ä¸‹<br>!<a href="6082pcap.html" class="internal-link">6082.pcap</a><br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images20250102231759112.png" alt="image.png"><br>br0å£å§‹å‘ï¼Œé€šè¿‡geneveéš§é“å‘èµ·arp requestã€‚arpæŠ¥æ–‡æ˜¯é€šè¿‡geneve1å£å­¦ä¹ åˆ°çš„ï¼Œæ‰€ä»¥br0ä¼šæŠŠå‘å¾€å¯¹ç«¯çš„æµé‡é€åˆ°geneve1å£ã€‚</p>
<blockquote>
<p>æ³¨æ„ï¼šä¸»æœºå’Œbr0ç½‘æ¡¥å„æœ‰ä¸€å¼ macè¡¨</p>
</blockquote>
<pre><code class="language-shell">root@iZbp1b28f6ecl05u00dl9lZ:~# arp -n
Address                  HWtype  HWaddress           Flags Mask            Iface
169.254.67.1                     (incomplete)                              veth-host
169.254.67.1             ether   ce:97:8e:75:90:df   C                     br0
10.0.0.253               ether   ee:ff:ff:ff:ff:ff   C                     eth0
12.200.1.2               ether   8a:8f:4c:0a:71:c1   C                     br0
10.0.0.250               ether   ee:ff:ff:ff:ff:ff   C                     eth0
root@iZbp1b28f6ecl05u00dl9lZ:~# brctl showmacs br0
port no	mac addr		is local?	ageing timer
  2	76:7c:8c:b6:9e:01	yes		   0.00
  2	76:7c:8c:b6:9e:01	yes		   0.00
  1	8a:8f:4c:0a:71:c1	no		   3.02
  1	ba:04:f4:74:9d:8f	yes		   0.00
  1	ba:04:f4:74:9d:8f	yes		   0.00
root@iZbp1b28f6ecl05u00dl9lZ:~# brctl show br0
bridge name	bridge id		STP enabled	interfaces
br0		8000.6e25202550d3	no		    geneve1
                                        veth-host
</code></pre>
<h1>4. å®¹å™¨ä½¿ç”¨geneveéš§é“</h1>
<h2>4.1. å°†geneveéš§é“ç›´æ¥ç§»åˆ°å®¹å™¨å‘½åç©ºé—´</h2>
<p>host a</p>
<pre><code class="language-shell">docker run -itd --privileged --network=none --name client1 myubuntu bash
# æŸ¥æ‰¾å®¹å™¨çš„è¿›ç¨‹ID 
PID=$(docker inspect -f &#39;&#39; client1)
sudo mkdir -p /var/run/netns
sudo ln -s /proc/$PID/ns/net /var/run/netns/$PID

ip link add name geneve1 type geneve vni 1000 remote 10.0.0.250 dstport 6082
ip link set geneve1 netns $PID
ip netns exec $PID ip link set geneve1 up
ip netns exec $PID ip addr add 169.254.67.1/32 dev geneve1
ip netns exec $PID ip route add default dev geneve1
</code></pre>
<p>host b</p>
<pre><code class="language-shell">brctl addbr br0
ip address add 12.200.1.2/24 dev br0
ip link set br0 up
ip link add name geneve1 type geneve vni 1000 remote 10.0.0.251 dstport 6082
ip link set geneve1 up
brctl addif br0 geneve1
ip route add 169.254.67.1/32 dev br0
</code></pre>
<h3>4.1.1. æŠ“åŒ…åˆ†æ</h3>
<p>åœ¨host aå®¹å™¨ä¸­æ‰§è¡Œ<code>ping 12.200.1.2</code></p>
<p>host bçš„br0ç½‘æ¡¥æŠ“åŒ…</p>
<pre><code class="language-shell">tcpdump: listening on br0, link-type EN10MB (Ethernet), capture size 262144 bytes
17:31:59.955468 ae:3d:e0:0c:58:73 &gt; ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 42: Ethernet (len 6), IPv4 (len 4), Request who-has 12.200.1.2 tell 169.254.67.1, length 28
17:31:59.955508 5a:d5:32:45:37:9e &gt; ae:3d:e0:0c:58:73, ethertype ARP (0x0806), length 42: Ethernet (len 6), IPv4 (len 4), Reply 12.200.1.2 is-at 5a:d5:32:45:37:9e, length 28
17:31:59.956375 ae:3d:e0:0c:58:73 &gt; 5a:d5:32:45:37:9e, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 7972, offset 0, flags [DF], proto ICMP (1), length 84)
    169.254.67.1 &gt; 12.200.1.2: ICMP echo request, id 83, seq 1, length 64
17:31:59.956419 5a:d5:32:45:37:9e &gt; ae:3d:e0:0c:58:73, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 11877, offset 0, flags [none], proto ICMP (1), length 84)
    12.200.1.2 &gt; 169.254.67.1: ICMP echo reply, id 83, seq 1, length 64
</code></pre>
<p>host bçš„geneve1å£æŠ“åŒ…</p>
<pre><code class="language-shell">tcpdump: listening on geneve1, link-type EN10MB (Ethernet), capture size 262144 bytes
17:31:59.955468 ae:3d:e0:0c:58:73 &gt; ff:ff:ff:ff:ff:ff, ethertype ARP (0x0806), length 42: Ethernet (len 6), IPv4 (len 4), Request who-has 12.200.1.2 tell 169.254.67.1, length 28
17:31:59.955512 5a:d5:32:45:37:9e &gt; ae:3d:e0:0c:58:73, ethertype ARP (0x0806), length 42: Ethernet (len 6), IPv4 (len 4), Reply 12.200.1.2 is-at 5a:d5:32:45:37:9e, length 28
17:31:59.956375 ae:3d:e0:0c:58:73 &gt; 5a:d5:32:45:37:9e, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 7972, offset 0, flags [DF], proto ICMP (1), length 84)
    169.254.67.1 &gt; 12.200.1.2: ICMP echo request, id 83, seq 1, length 64
17:31:59.956422 5a:d5:32:45:37:9e &gt; ae:3d:e0:0c:58:73, ethertype IPv4 (0x0800), length 98: (tos 0x0, ttl 64, id 11877, offset 0, flags [none], proto ICMP (1), length 84)
    12.200.1.2 &gt; 169.254.67.1: ICMP echo reply, id 83, seq 1, length 64
</code></pre>
<p>host bä¸Šæ¥å£ä¿¡æ¯</p>
<pre><code class="language-shell">15: br0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether 5a:d5:32:45:37:9e brd ff:ff:ff:ff:ff:ff
    inet 12.200.1.2/24 scope global br0
       valid_lft forever preferred_lft forever
    inet6 fe80::504c:edff:fe1f:9a5d/64 scope link 
       valid_lft forever preferred_lft forever
16: geneve1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br0 state UNKNOWN group default qlen 1000
    link/ether 5a:d5:32:45:37:9e brd ff:ff:ff:ff:ff:ff
    inet 12.200.1.3/24 scope global geneve1
       valid_lft forever preferred_lft forever
    inet6 fe80::58d5:32ff:fe45:379e/64 scope link 
       valid_lft forever preferred_lft forever
</code></pre>
<p>host aä¸Šå®¹å™¨ä¸­çš„arpè¡¨</p>
<pre><code class="language-shell">~# ip netns exec $PID arp -n         
Address                  HWtype  HWaddress           Flags Mask            Iface
12.200.1.2               ether   5a:d5:32:45:37:9e   C                     geneve1
</code></pre>
<p>host bä¸Šarpè¡¨ä»¥åŠbr0ç½‘æ¡¥çš„macè¡¨</p>
<pre><code class="language-shell">~# arp -n
Address                  HWtype  HWaddress           Flags Mask            Iface
169.254.67.1             ether   ae:3d:e0:0c:58:73   C                     br0
192.168.1.1              ether   fa:16:3e:17:96:ac   C                     eth0
192.168.1.53             ether   fa:16:3e:ac:87:86   C                     eth0
192.168.1.254            ether   fa:fa:fa:fa:fa:01   C                     eth0
~# brctl showmacs br0
port no	mac addr		is local?	ageing timer
  1	5a:d5:32:45:37:9e	yes		   0.00
  1	5a:d5:32:45:37:9e	yes		   0.00
  1	ae:3d:e0:0c:58:73	no		   0.25
~# brctl show br0 
bridge name	bridge id		STP enabled	interfaces
br0		8000.5ad53245379e	no		geneve1           
# geneve1ä»£è¡¨ç½‘æ¡¥ä¸Šçš„Port noä¸º1çš„å£ï¼Œ5a:d5:32:45:37:9eå°±æ˜¯geneve1å£çš„macï¼Œloca:yesä»£è¡¨ç›´è¿ï¼›ae:3d:e0:0c:58:73æ˜¯host aä¸­å®¹å™¨çš„æºmacï¼Œlocal:noä»£è¡¨å­¦ä¹ åˆ°çš„
</code></pre>
<ol>
<li>host aï¼šå®¹å™¨å‘èµ·arp requestå¹¿æ’­æ¶ˆæ¯</li>
<li>host a: ä¸»æœºaçš„geneve1å£ä¸ºéš§é“å£ï¼Œå°†å¹¿æ’­æ¶ˆæ¯å°è£…geneveéš§é“ï¼ŒåŒ¹é…ä¸»æœºè·¯ç”±ä»ä¸»æœºaçš„ethå£å‘å‡º</li>
<li>host b: ä¸»æœºbçš„ethå£æ”¶åˆ°geneveæŠ¥æ–‡ï¼Œè§£å°è£…å¤–å±‚éš§é“ä¿¡æ¯ï¼Œä»ä¸»æœºbçš„geneve1å£å‘å‡ºå¹¿æ’­</li>
<li>host b: æµé‡åˆ°è¾¾host bçš„br0ç½‘æ¡¥ï¼Œç½‘æ¡¥è®°å½•<code>ae:3d:e0:0c:58:73</code>å¯¹åº”ç«¯å£ä¸ºgeneve1</li>
<li>host b: ç½‘æ¡¥æ¥å£æ”¶åˆ°å¹¿æ’­æŠ¥æ–‡ï¼Œå‘ç°ç›®çš„IPæ˜¯è‡ªå·±<strong>ä¸”è¯·æ±‚IPçš„ç½‘å…³</strong>ä¹Ÿæ˜¯è‡ªå·±ï¼Œäºæ˜¯ä¾¿å•æ’­å“åº”arp replyï¼›</li>
<li>host b: æµé‡åˆ°è¾¾br0ç½‘æ¡¥ï¼Œå‘ç°å›ç¨‹<code>ae:3d:e0:0c:58:73</code>å¯¹åº”çš„ç«¯å£ä¸ºgeneve1ï¼Œäºæ˜¯ä»geneve1å£å‘å‡º</li>
<li>host b: å°è£…geneveéš§é“ï¼Œä»ä¸»æœºbçš„ethå£å‘å‡º</li>
<li>host a: ä¸»æœºaçš„ethå£æ”¶åˆ°geneveæŠ¥æ–‡ï¼Œè§£å°è£…å¤–å±‚éš§é“ä¿¡æ¯ï¼Œé€åˆ°ä¸»æœºaå®¹å™¨ä¸­çš„geneve1å£ï¼Œå®¹å™¨å®Œæˆarpå­¦ä¹ </li>
<li>host a: å®¹å™¨icmp requestå•æ’­æ¶ˆæ¯ï¼ŒåŒ¹é…é»˜è®¤è·¯ç”±ä¸‹ä¸€è·³é€geneve1å£</li>
<li>host a: ä¸»æœºaçš„geneve1å£ä¸ºéš§é“å£ï¼Œæ”¶åˆ°å¹¿æ’­æ¶ˆæ¯åå°è£…geneveéš§é“ï¼Œä»ä¸»æœºaçš„ethå£å‘å‡º</li>
<li>host b: ä¸»æœºbçš„ethå£æ”¶åˆ°geneveæŠ¥æ–‡ï¼Œè§£å°è£…å¤–å±‚éš§é“ä¿¡æ¯ï¼Œä»geneve1å£å‘å‡ºåˆ°è¾¾br0ç½‘æ¡¥</li>
<li>æµé‡åˆ°è¾¾br0ç½‘æ¡¥ï¼ŒæŸ¥æ‰¾macè¡¨ï¼Œå‘ç°IPæ˜¯ç½‘æ¡¥æ¥å£ï¼Œäºæ˜¯br0ç½‘æ¡¥æ¥å£å“åº”ICMP replyï¼Œç„¶åå‘å‡ºå›åˆ°br0ç½‘æ¡¥</li>
<li>ç½‘æ¡¥æŸ¥æ‰¾macè½¬å‘è¡¨ï¼Œå‡ºæ¥å£æ˜¯<code>ae:3d:e0:0c:58:73</code>ï¼Œäºæ˜¯ä»geneve1å£å‘å‡º</li>
<li>host b: æµé‡å°è£…geneveéš§é“ï¼Œä»ä¸»æœºbçš„ethå£å‘å‡º</li>
<li>host a: ä¸»æœºaçš„ethå£æ”¶åˆ°geneveæŠ¥æ–‡ï¼Œè§£å°è£…å¤–å±‚éš§é“ä¿¡æ¯ï¼Œå‘ç°ç›®çš„æ˜¯è‡ªå·±ï¼Œé€šä¿¡ç»“æŸ</li>
</ol>
<blockquote>
<p>æˆ‘ä»¬åœ¨ä¸»æœºbä¸Šæ·»åŠ äº†ä¸€æ¡ç›®çš„åœ°å€æ˜¯ä¸»æœºå®¹å™¨åœ°å€ï¼Œä¸‹ä¸€è·³é€br0ç½‘æ¡¥æ¥å£çš„è·¯ç”±ã€‚å¦‚æœè¿™æ¡è·¯ç”±ä¸‹ä¸€è·³æŒ‡å‘ä¸»æœºaçš„geneve1å£ä¼šæ€ä¹ˆæ ·ï¼Ÿarpè¯·æ±‚åˆ°è¾¾ä¸»æœºbçš„geneve1å£çš„æ—¶å€™ï¼Œä¼šå‘ç°ç½‘å…³æ˜¯è‡ªå·±ï¼Œè‡ªå·±åº”è¯¥ä»£ç­”ï¼Œä½†æ˜¯è¯·æ±‚çš„IPå´ä¸æ˜¯è‡ªå·±ï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¼šä¸¢åŒ…äº†ï¼ˆç½‘å…³ä¸ä¼šä»£ç­”äºŒå±‚ï¼ŒäºŒå±‚å†…çš„çœŸå®ä¸»æœºåº”è¯¥å›ç­”ï¼‰ <a href="arp1-arpå“åº”çš„æ¡ä»¶.html" class="internal-link">ARP<span class="tag">#1</span>. arpå“åº”çš„æ¡ä»¶</a>]</p>
</blockquote>
<h2>4.2. å®¹å™¨é€šè¿‡vethè¿æ¥å®¿ä¸»æœºç½‘æ¡¥ä¸Šgeneveå£</h2>
<p>host aé…ç½®</p>
<pre><code class="language-shell">ip link add name geneve1 type geneve vni 1000 remote 10.0.0.250 dstport 6082
ip link set geneve1 up
brctl addbr br0
ip link set br0 up
brctl addif br0 geneve1

docker run -itd --privileged --network=none --name client1 myubuntu bash
PID=$(docker inspect -f &#39;&#39; client1)
sudo mkdir -p /var/run/netns
sudo ln -s /proc/$PID/ns/net /var/run/netns/$PID
ip link add veth-host type veth peer name veth-client1
ip link set veth-host up
brctl addif br0 veth-host
ip link set veth-client1 netns $PID
ip netns exec $PID ip addr add 169.254.67.1/16 dev veth-client1 
ip netns exec $PID ip link set veth-client1 up 
ip netns exec $PID ip route add default dev veth-client1
</code></pre>
<p>host bé…ç½®</p>
<pre><code class="language-shell">brctl addbr br0
ip address add 12.200.1.2/24 dev br0
ip link set br0 up
ip link add name geneve1 type geneve vni 1000 remote 10.0.0.251 dstport 6082
ip link set geneve1 up
brctl addif br0 geneve1
route add 169.254.67.1/32 dev br0
</code></pre>
<p>iptablesè§„åˆ™</p>
<pre><code class="language-shell"># iptables -nvL FORWARD                                                        
Chain FORWARD (policy DROP 1246 packets, 105K bytes)
 pkts bytes target     prot opt in     out     source               destination         
 1246  105K DOCKER-ISOLATION  all  --  *      *       0.0.0.0/0            0.0.0.0/0           
    0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED
    0     0 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           
    0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0
</code></pre>
<p>ç”±äºç»è¿‡ç½‘æ¡¥çš„ç›®çš„ipä¸æ˜¯æœ¬æœºåœ°å€ï¼Œå› æ­¤ä¼šè¢«<a href="bridgeiptables.html" class="internal-link">bridge|iptables</a>çš„forwardé“¾è¿‡æ»¤ï¼Œè¿™é‡Œä¸»æœºaä¸Šè¿˜éœ€è¦æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š</p>
<pre><code class="language-shell">iptables -I FORWARD -i br0 -o br0 -j ACCEPT
# æˆ–è€…ç›´æ¥å…³é—­forward
sysctl -w net.bridge.bridge-nf-call-iptables=0
</code></pre>
<p>ä¸ºäº†é¿å…arpå­¦ä¹ ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ é™æ€macè§£å†³</p>
<pre><code class="language-shell"># é…ç½®ä¸€ä¸ªå‡ç½‘å…³ï¼Œç»™å‡ç½‘å…³é…ç½®é™æ€macï¼Œæµé‡åˆ°è¾¾ç½‘æ¡¥ç”±äºç½‘æ¡¥ä¸çŸ¥é“macå¯¹åº”portï¼Œå› æ­¤ä¼šåœ¨æ‰€æœ‰éå‘é€ç«¯å£ä¸Šæ³›æ´ªï¼Œä¹ŸåŒ…æ‹¬geneve1å£ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦å¯¹ç«¯å›åŒ…ï¼Œåˆ™è¿™ä¸ªmacå¿…é¡»å’Œç›®çš„ç«¯macåŒ¹é…ï¼Œå¦åˆ™å¯¹ç«¯ä¼šä¸¢åŒ…ï¼Œæˆ–è€…å¯¹ç«¯è®¾å¤‡æ”¯æŒä¸æ ¡éªŒç›®çš„mac
ip netns exec $PID ip route add default via 169.254.175.253 dev veth-client1
ip netns exec $PID arp -s 169.254.175.253 52:7d:b1:92:5a:0f
</code></pre>
<h2>4.3. åŒä¸€å®¿ä¸»æœºä¸Šä¸åŒå®¹å™¨ä½¿ç”¨ç›¸åŒVNIä¸åŒDstPORT</h2>
<p>host aé…ç½®ä¸¤ä¸ªå®¹å™¨çš„æºIPä¸€æ ·ï¼Œä½¿ç”¨ä¸åŒç›®çš„portåŒºåˆ†éš§é“</p>
<pre><code class="language-shell">docker run -itd --privileged --network=none --name client1 myubuntu bash
# æŸ¥æ‰¾å®¹å™¨çš„è¿›ç¨‹ID 
PID=$(docker inspect -f &#39;&#39; client1)
sudo mkdir -p /var/run/netns
sudo ln -s /proc/$PID/ns/net /var/run/netns/$PID

ip link add name geneve1 type geneve vni 1000 remote 10.0.0.250 dstport 6081
    ip link set geneve1 netns $PID
ip netns exec $PID ip link set geneve1 up
ip netns exec $PID ip addr add 169.254.175.252/32 dev geneve1
ip netns exec $PID ip route add default dev geneve1

docker run -itd --privileged --network=none --name client2 myubuntu bash
# æŸ¥æ‰¾å®¹å™¨çš„è¿›ç¨‹ID 
PID=$(docker inspect -f &#39;&#39; client2)
sudo mkdir -p /var/run/netns
sudo ln -s /proc/$PID/ns/net /var/run/netns/$PID

ip link add name geneve1 type geneve vni 1000 remote 10.0.0.250 dstport 6082
ip link set geneve1 netns $PID
ip netns exec $PID ip link set geneve1 up
ip netns exec $PID ip addr add 169.254.176.252/32 dev geneve1
ip netns exec $PID ip route add default dev geneve1
</code></pre>
<p>host bç›¸åŒé…ç½®</p>
<pre><code class="language-shell">docker run -itd --privileged --network=none --name client1 myubuntu bash
# æŸ¥æ‰¾å®¹å™¨çš„è¿›ç¨‹ID 
PID=$(docker inspect -f &#39;&#39; client1)
sudo mkdir -p /var/run/netns
sudo ln -s /proc/$PID/ns/net /var/run/netns/$PID

ip link add name geneve1 type geneve vni 1000 remote 10.0.0.251 dstport 6081
ip link set geneve1 netns $PID
ip netns exec $PID ip link set geneve1 up
ip netns exec $PID ip addr add 169.254.177.252/32 dev geneve1
ip netns exec $PID ip route add default dev geneve1

docker run -itd --privileged --network=none --name client2 myubuntu bash
# æŸ¥æ‰¾å®¹å™¨çš„è¿›ç¨‹ID 
PID=$(docker inspect -f &#39;&#39; client2)
sudo mkdir -p /var/run/netns
sudo ln -s /proc/$PID/ns/net /var/run/netns/$PID

ip link add name geneve1 type geneve vni 1000 remote 10.0.0.251 dstport 6082
ip link set geneve1 netns $PID
ip netns exec $PID ip link set geneve1 up
ip netns exec $PID ip addr add 169.254.178.252/32 dev geneve1
ip netns exec $PID ip route add default dev geneve1
</code></pre>
<p>æ­¤æ—¶ä¸¤ä¸ªä¸»æœºä¸Šçš„ä¸¤ä¸ªå®¹å™¨å¯ä»¥é€šè¿‡ä¸¤ä¸ªä»…ç›®çš„ç«¯å£ä¸ä¸€æ ·çš„éš§é“åŒæ—¶äº’é€š<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/blog_images20250106233311014.png" alt="image.png"></p>
<h3>4.3.1. Extension</h3>
<p>ä¸ºäº†é¿å…arpå­¦ä¹ ï¼Œå¯ä»¥åœ¨å®¹å™¨å†…é…ç½®é™æ€arpï¼Œä»¥ä¸€ä¸ªå®¹å™¨ä¸¾ä¾‹</p>
<pre><code class="language-shell"># ä¿®æ”¹geneve1å£ç½‘æ®µä¸º31ä½ï¼Œé…ç½®ç½‘å…³ä¸º169.254.175.253ï¼Œè¿™æ ·æ‰€æœ‰æµé‡éƒ½ä¼šä»geneve1å£å‡ºï¼ŒåŒæ—¶å¯ä»¥æ·»åŠ é™æ€arpï¼Œé¿å…arpå­¦ä¹ ä¸åˆ°ç½‘å…³mac
ip addr add 169.254.175.252/31 dev geneve1
ip route add default via 169.254.175.253 dev geneve1
arp -s 169.254.175.253 1e:53:8a:c3:1a:be
</code></pre>
<blockquote>
<p>è¿™é‡Œé™æ€macåœ°å€æ˜¯æ·»åŠ çš„å¯¹ç«¯å®¹å™¨169.254.177.252çš„çœŸå®macï¼Œå¦åˆ™å¯¹ç«¯ä¼šç”±äºmacä¸å¯¹è€Œç›´æ¥ä¸¢åŒ…ã€‚è¿™ç§é™æ€é…ç½®çš„æ–¹å¼åªé€‚åˆé€šä¿¡å¯¹ç«¯åªæœ‰ä¸€ä¸ªåœ°å€ä¸”macå›ºå®šçš„æƒ…å†µã€‚å¦åˆ™éœ€è¦å¯¹ç«¯å¯¹ç›®çš„macä¸æ ¡éªŒã€‚</p>
</blockquote>
<h1>5. æ³¨æ„ç‚¹</h1>
<ol>
<li>è¦é…ç½®å¥½å›ç¨‹è·¯ç”±ï¼Œå¦åˆ™ä¼šè®¤ä¸ºå›ç¨‹ä¸å¯è¾¾ï¼Œä¸ä¼šå‘é€arpå“åº”</li>
</ol>
}
    </section>
</article>
            </div>
        </main>
        <footer class="page-footer">
            <div class="container">
                <p>&copy; 2026 Shinerio's Blog. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Theme switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.getElementById('theme-body');

            // Check for saved theme preference or respect OS preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            // Set initial theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
                body.setAttribute('data-theme', 'dark');
            } else {
                body.removeAttribute('data-theme'); // light theme
            }

            // Toggle theme function
            function toggleTheme() {
                if (body.getAttribute('data-theme') === 'dark') {
                    body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Add event listener to theme toggle button
            themeToggle.addEventListener('click', toggleTheme);

            // Listen for OS theme changes
            prefersDarkScheme.addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        body.setAttribute('data-theme', 'dark');
                    } else {
                        body.removeAttribute('data-theme');
                    }
                }
            });

            // Search functionality
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchResults = document.getElementById('search-results');
            const searchSuggestions = document.getElementById('search-suggestions');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');

            if (searchInput && searchButton) {
                let searchData = null;

                // Load search data
                async function loadSearchData() {
                    try {
                        const response = await fetch('./assets/js/search-data.json');
                        if (response.ok) {
                            searchData = await response.json();
                        } else {
                            console.error('Failed to load search data:', response.status);
                        }
                    } catch (error) {
                        console.error('Error loading search data:', error);
                    }
                }

                // Initialize search data
                loadSearchData();

                // Debounce function to limit search calls
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // Get selected search type
                function getSelectedSearchType() {
                    const selectedRadio = document.querySelector('input[name="search-type"]:checked');
                    return selectedRadio ? selectedRadio.value : 'all';
                }

                // Perform search
                function performSearch(query) {
                    if (!searchData || !query.trim()) {
                        searchResults.innerHTML = '';
                        searchSuggestions.innerHTML = '';
                        return;
                    }

                    const queryTerms = query.toLowerCase().split(/\s+/).filter(term => term.length > 0);
                    const searchType = getSelectedSearchType();

                    if (queryTerms.length === 0) {
                        searchResults.innerHTML = '';
                        return;
                    }

                    const results = [];

                    // Search through articles
                    searchData.articles.forEach(article => {
                        let score = 0;
                        let snippet = '';

                        // Get content based on search type
                        const lowerTitle = article.title.toLowerCase();
                        const lowerContent = article.content.toLowerCase();
                        const lowerTags = article.tags.join(' ').toLowerCase();

                        queryTerms.forEach(term => {
                            switch(searchType) {
                                case 'title':
                                    // Only title matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    break;
                                case 'content':
                                    // Only content matches count (fixed to exclude title matches)
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    break;
                                case 'all':
                                default:
                                    // Both title and content matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    // Tag matches get medium-high score
                                    if (lowerTags.includes(term)) {
                                        score += 5;
                                    }
                                    break;
                            }
                        });

                        if (score > 0) {
                            // Generate snippet based on search type
                            let content = '';

                            if (searchType === 'title') {
                                // For title-only search, show title content
                                content = article.title.substring(0, 200);
                            } else if (searchType === 'content') {
                                // For content-only search, show content excerpt
                                content = article.content.substring(0, 200);
                            } else {
                                // For all search, show content with title as context
                                content = article.content.substring(0, 200);
                            }

                            // Find first occurrence of query term in content for snippet
                            queryTerms.forEach(term => {
                                let searchIn = content.toLowerCase();
                                if (searchType === 'title') {
                                    searchIn = lowerTitle;
                                } else if (searchType === 'content') {
                                    searchIn = lowerContent;
                                }

                                const index = searchIn.indexOf(term);
                                if (index !== -1) {
                                    // Expand snippet around the match
                                    let start, end;
                                    if (searchType === 'title') {
                                        start = Math.max(0, index - 15);
                                        end = Math.min(content.length, index + term.length + 35);
                                    } else {
                                        start = Math.max(0, index - 30);
                                        end = Math.min(content.length, index + term.length + 70);
                                    }

                                    content = (start > 0 ? '...' : '') +
                                              content.substring(start, end) +
                                              (end < (searchType === 'title' ? article.title.length : article.content.length) ? '...' : '');

                                    // Highlight the term in the snippet
                                    const searchContent = searchType === 'title' ? article.title : article.content;
                                    const adjustedIndex = searchType === 'title' ?
                                        Math.min(index, article.title.length - 1) :
                                        Math.min(index, article.content.length - 1);

                                    content = content.replace(
                                        new RegExp(`(${escapeRegExp(term)})`, 'gi'),
                                        '<mark>$1</mark>'
                                    );
                                }
                            });

                            results.push({
                                article: article,
                                score: score,
                                snippet: content
                            });
                        }
                    });

                    // Sort results by score
                    results.sort((a, b) => b.score - a.score);

                    // Display results
                    displaySearchResults(results);
                }

                // Display search results
                function displaySearchResults(results) {
                    if (results.length === 0) {
                        searchResults.innerHTML = '<p class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>';
                        return;
                    }

                    const resultsHTML = results.map(result => `
                        <div class="search-result-item">
                            <h3 class="search-result-title">
                                <a href="./${result.article.slug}.html">${highlightQueryTerms(result.article.title, document.querySelector('#search-input').value)}</a>
                            </h3>
                            <div class="search-result-meta">
                                ${result.article.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                            </div>
                            <p class="search-result-excerpt">${result.snippet}</p>
                        </div>
                    `).join('');

                    searchResults.innerHTML = resultsHTML;
                }

                // Highlight query terms in text
                function highlightQueryTerms(text, query) {
                    if (!query.trim()) return text;

                    const queryTerms = query.split(/\s+/).filter(term => term.length > 0);
                    let highlightedText = text;

                    queryTerms.forEach(term => {
                        const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');
                    });

                    return highlightedText;
                }

                // Escape special regex characters
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Event listener for search button
                searchButton.addEventListener('click', function() {
                    const query = searchInput.value;
                    performSearch(query);
                });

                // Event listener for Enter key
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        const query = searchInput.value;
                        performSearch(query);
                    }
                });

                // Add debounced input handler for live search (optional)
                const debouncedSearch = debounce(function() {
                    const query = searchInput.value;
                    performSearch(query);
                }, 300);

                searchInput.addEventListener('input', debouncedSearch);

                // Add event listeners for search type radios
                searchTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const query = searchInput.value;
                        if (query.trim()) {
                            performSearch(query);
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>