<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kafka Stream - Shinerio's Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="article-page" id="theme-body">
    <div class="page-wrapper">
        <header class="page-header">
            <div class="container">
                <nav class="page-nav">
                    <div class="nav-links">
                        <a href="index.html" class="nav-link ">Home</a>
                        <a href="articles.html" class="nav-link ">Articles</a>
                        <a href="search.html" class="nav-link ">Search</a>
                    </div>
                    <div class="theme-toggle-container">
                        <button id="theme-toggle" aria-label="Toggle dark mode" class="theme-toggle-btn">
                            <span class="sun-icon">â˜€ï¸</span>
                            <span class="moon-icon">ğŸŒ™</span>
                        </button>
                    </div>
                </nav>
            </div>
        </header>
        <main class="page-main">
            <div class="container">
                <article>
    <header>
        <h1>Kafka Stream</h1>
        <time datetime="2026-01-03T13:04:29.189Z">2026å¹´1æœˆ3æ—¥</time>
        <div class="tags">
            
        </div>
    </header>
    <section class="content">
        {<h1>1. æµå¼è®¡ç®—å’Œæ‰¹è®¡ç®—</h1>
<h2>1.1. æµå¼è®¡ç®—</h2>
<p>æµå¼è®¡ç®—æ˜¯æŒç»­åœ°ä»æ•°æ®æºè·å–æ•°æ®ï¼Œå¹¶å®æ—¶åœ°å¯¹æ•°æ®è¿›è¡Œå¤„ç†å’Œåˆ†æã€‚</p>
<h3>1.1.1. ç‰¹ç‚¹</h3>
<ul>
<li><strong>å®æ—¶æ€§å¼º</strong>ï¼Œèƒ½å¤Ÿåœ¨æ•°æ®åˆ°è¾¾æ—¶ç«‹å³è¿›è¡Œå¤„ç†ã€‚</li>
<li><strong>æ•°æ®æ— è¾¹ç•Œ</strong>ï¼Œæ˜¯æŒç»­äº§ç”Ÿçš„</li>
<li><strong>è®¡ç®—æ¨¡å‹æœ‰çŠ¶æ€</strong>ï¼Œéœ€è¦ç»´æŠ¤ä¸­é—´çŠ¶æ€ï¼Œä¸€èˆ¬ç”¨å¢é‡è®¡ç®—ä»£æ›¿å…¨é‡è®¡ç®—</li>
<li><strong>æ—¶å»¶æ•æ„Ÿ</strong>ï¼Œéœ€è¦ä½å»¶è¿Ÿå¤„ç†ã€‚</li>
</ul>
<h3>1.1.2. åº”ç”¨åœºæ™¯</h3>
<ul>
<li>å®æ—¶ç›‘æ§å’Œå¼‚å¸¸æ£€æµ‹(å¦‚ç½‘ç»œæµé‡ç›‘æ§ã€å®‰å…¨å¨èƒæ£€æµ‹ç­‰)</li>
<li>å®æ—¶æ•°æ®åˆ†æ(å¦‚å®æ—¶ç‚¹å‡»æµåˆ†æã€ç”¨æˆ·è¡Œä¸ºåˆ†æç­‰)</li>
<li>å®æ—¶å†³ç­–å’Œæ¨è(å¦‚å®æ—¶å®šä»·ã€ä¸ªæ€§åŒ–æ¨èç­‰)</li>
</ul>
<h2>1.2. æ‰¹è®¡ç®—</h2>
<p>ä»¥ç¦»çº¿çš„æ–¹å¼ï¼Œå‘¨æœŸæ€§åœ°ä»æ•°æ®æºæ ¹æ®è¿‡æ»¤æ¡ä»¶è·å–æ•°æ®é›†ï¼Œå¹¶å¯¹æ•´ä¸ªæ•°æ®é›†è¿›è¡Œå¤„ç†å’Œåˆ†æã€‚</p>
<h3>1.2.1. ç‰¹ç‚¹</h3>
<ul>
<li><strong>æ•°æ®é›†æœ‰è¾¹ç•Œ</strong>ï¼Œä¸€èˆ¬æ˜¯é™æ€çš„</li>
<li><strong>è®¡ç®—æ¨¡å‹æ— çŠ¶æ€</strong>ï¼Œä¸éœ€è¦ç»´æŠ¤ä¸­é—´çŠ¶æ€ï¼Œä¸€èˆ¬é‡‡ç”¨å…¨é‡è®¡ç®—</li>
<li><strong>å»¶è¿Ÿä¸æ•æ„Ÿ</strong>ï¼Œä½†å¤„ç†ååé‡å¤§</li>
</ul>
<h3>1.2.2. åº”ç”¨åœºæ™¯</h3>
<ul>
<li>ç¦»çº¿æ•°æ®åˆ†æ(å¦‚ç”¨æˆ·ç”»åƒ)</li>
<li>å¤§è§„æ¨¡æ•°æ®å¤„ç†(å¦‚ç½‘é¡µç´¢å¼•ã€æ¨èç³»ç»Ÿæ„å»ºç­‰)</li>
<li>æœºå™¨å­¦ä¹ æ¨¡å‹è®­ç»ƒå’Œè¯„ä¼°</li>
</ul>
<h1>2. kafka stream</h1>
<p>å¸¸è§çš„æµå¼å¤„ç†æ¡†æ¶æœ‰flinkå’Œstormç­‰ï¼Œç›¸æ¯”å¦‚è¿™äº›ä¸“ä¸šçš„æµå¤±å¤„ç†æ¡†æ¶ï¼Œkafka streamçš„ä¸€ä¸ªæœ€å¤§ä¼˜ç‚¹æ˜¯éå¸¸è½»é‡ï¼Œkafka Streamsåˆ©ç”¨kafkaä½œä¸ºæ•°æ®æºï¼Œå…¶æœ¬èº«ä»…ä»…æ˜¯kafkaçš„ä¸€ä¸ªå®¢æˆ·ç«¯åº“ï¼Œå®ƒå¯ä»¥åƒå…¶ä»–æ™®é€šçš„Kafkaæ¶ˆè´¹è€…å®¢æˆ·ç«¯ä¸€æ ·ï¼Œé€šè¿‡æ ‡å‡†çš„kafkaåè®®ä¸brokerè¿›è¡Œäº¤äº’ã€‚kafka streamså®æ—¶æ¶ˆè´¹ä¸Šæ¸¸çš„topicï¼Œç»è¿‡è‡ªå®šä¹‰çš„è®¡ç®—ï¼Œå°†ç»“æœç”Ÿäº§åˆ°ä¸‹æ¸¸çš„topicï¼Œç†è®ºä¸Šä½ å¯ä»¥è‡ªå·±å†™è°ƒç”¨Producer apiå’ŒConsumer apiæ¥å®ç°ä¸€ä¸ªæµè®¡ç®—åº”ç”¨ã€‚</p>
<h2>2.1. å…³é”®ç‰¹æ€§</h2>
<ul>
<li>æ—¶é—´çš„å®šä¹‰ï¼šç”Ÿæˆæ—¶é—´ã€å¤„ç†æ—¶é—´ã€äº‹ä»¶æ—¶é—´</li>
<li>æ—¶é—´çª—å£ï¼šsliding windowã€hopping windowã€event window</li>
<li>å¤„ç†æ™šåˆ°æ•°æ®</li>
<li>map-reduce</li>
<li>table join</li>
<li>ä¸­é—´çŠ¶æ€</li>
<li>exactly-once</li>
</ul>
<h2>2.2. è®¡ç®—æ¨¡å‹</h2>
<p><code>KStream</code>å’Œ<code>KTable</code>åˆ™æ˜¯<code>Kafka Stream</code>åº“åœ¨å®¢æˆ·ç«¯å¯¹æ•°æ®æµè¿›è¡Œå„ç§è½¬æ¢æ“ä½œæ—¶ä½¿ç”¨çš„æŠ½è±¡æ¨¡å‹ </p>
<ul>
<li><code>KStream</code>ä»£è¡¨äº†ä¸€ä¸ªæ— ç•Œçš„æŒç»­æ›´æ–°çš„è®°å½•æµï¼Œç”¨äºè¡¨ç¤ºå’Œå¤„ç†æœ‰åºçš„ã€ä¸æ–­æ’å…¥çš„äº‹ä»¶åºåˆ—</li>
<li><code>KTable</code>æ˜¯æŒä¹…åŒ–çŠ¶æ€å­˜å‚¨ï¼Œç”¨äºè¡¨ç¤ºè®°å½•å¯¹è¿ç»­æ•°æ®æµæ‰§è¡Œè®¡ç®—åæŒä¹…åŒ–å­˜å‚¨çš„ç»“æœè§†å›¾</li>
</ul>
<h2>2.3. å­˜å‚¨æ¨¡å‹</h2>
<h3>2.3.1. KTable</h3>
<p>Kafka Streamå¯ä»¥ä¸ºæ¯ä¸ªæµä»»åŠ¡åµŒå…¥ä¸€ä¸ªæˆ–å¤šä¸ªæœ¬åœ°çŠ¶æ€å­˜å‚¨[KTable](<a href="https://kafka.apache.org/31/documentation/streams/architecture">https://kafka.apache.org/31/documentation/streams/architecture</a><span class="tag">#streams_architecture_recovery</span>)ï¼Œå¹¶ä¸”å…è®¸å¼€å‘è€…é€šè¿‡APIçš„æ–¹å¼è¿›è¡Œè®¿é—®ã€æŸ¥è¯¢æ‰€éœ€è¦å¤„ç†çš„æ•°æ®ã€‚è¿™äº›çŠ¶æ€æ•°æ®åº•å±‚é»˜è®¤æ˜¯åŸºäºRocksDBæ•°æ®åº“å®ç°çš„ï¼Œæœ¬è´¨å…¶å®æ˜¯åœ¨å†…å­˜çš„ä¸€ä¸ªhashmapã€‚ è€Œä¸”çŠ¶æ€å­˜å‚¨é»˜è®¤æ”¯æŒåŒæ­¥åˆ°è¿œç«¯çš„kafka brokerï¼Œä»¥topicçš„æ–¹å¼è®°å½•æœ¬åœ°å­˜å‚¨çš„changelogã€‚ å½“kafka streamsçš„taskå› é‡å»ºæˆ–è€…åŠ¨æ€æ‰©ç¼©å®¹è€Œå‘ç”Ÿè¿ç§»æ—¶ï¼Œè‹¥è¿ç§»åçš„kafka streamså®ä¾‹æ— æ³•ä»æœ¬åœ°ç£ç›˜æ¢å¤çŠ¶æ€ï¼Œå°±ä¼šè¯»å–ä¸‹changelogçš„topicæ¥é‡å»ºçŠ¶æ€å­˜å‚¨ã€‚å…·ä½“çš„å·¥ä½œæµç¨‹å¦‚ä¸‹ï¼š</p>
<ol>
<li><strong>ä»å˜æ›´æ—¥å¿—æ¢å¤çŠ¶æ€</strong>ï¼š å½“Kafka Streamsåº”ç”¨å¯åŠ¨æ—¶ï¼Œå®ƒé¦–å…ˆæ£€æŸ¥æœ¬åœ°çŠ¶æ€å­˜å‚¨ã€‚å¦‚æœçŠ¶æ€å­˜å‚¨å­˜åœ¨ï¼Œå®ƒä¼šæ£€æŸ¥æœ€åå¤„ç†çš„åç§»é‡ã€‚<ul>
<li>å¦‚æœæœ¬åœ°çŠ¶æ€å­˜å‚¨çš„æ•°æ®æ˜¯å®Œæ•´çš„ï¼ŒKafka Streamsä¼šä»æœ¬åœ°çŠ¶æ€å­˜å‚¨æ¢å¤æ•°æ®ã€‚</li>
<li>ç„¶åï¼Œä»å˜æ›´æ—¥å¿—ä¸»é¢˜ä¸­è¯»å–ä»æœ€åä¸€ä¸ªå¤„ç†åç§»é‡åˆ°å½“å‰æœ€æ–°åç§»é‡ä¹‹é—´çš„æ‰€æœ‰å˜æ›´ï¼Œå¹¶å°†è¿™äº›å˜æ›´åº”ç”¨åˆ°æœ¬åœ°çŠ¶æ€å­˜å‚¨ã€‚</li>
</ul>
</li>
<li><strong>ä»æ£€æŸ¥ç‚¹æ¢å¤è¿›åº¦</strong>ï¼š Kafka Streamsè¿˜ä¼šä»æ£€æŸ¥ç‚¹æ¢å¤å¤„ç†è¿›åº¦ã€‚æ£€æŸ¥ç‚¹è®°å½•äº†æ¯ä¸ªåˆ†åŒºçš„åç§»é‡ï¼Œå³æ¯ä¸ªåˆ†åŒºå¤„ç†åˆ°å“ªä¸€æ¡è®°å½•ã€‚å½“åº”ç”¨ç¨‹åºé‡æ–°å¯åŠ¨æ—¶ï¼Œå®ƒä¼šä»è¿™äº›åç§»é‡ç»§ç»­è¯»å–å’Œå¤„ç†è®°å½•ã€‚</li>
<li><strong>ä¿è¯æ•°æ®ä¸€è‡´æ€§</strong>ï¼š<ul>
<li>Kafka Streamsç¡®ä¿æœ¬åœ°çŠ¶æ€å­˜å‚¨ä¸å˜æ›´æ—¥å¿—ä¸»é¢˜ä¸­çš„æ•°æ®ä¸€è‡´ã€‚æ¯æ¬¡çŠ¶æ€å­˜å‚¨æ›´æ–°æ—¶ï¼Œéƒ½ä¼šè®°å½•åœ¨å˜æ›´æ—¥å¿—ä¸­ã€‚</li>
<li>é€šè¿‡äº‹åŠ¡æœºåˆ¶ï¼ŒKafka Streamså¯ä»¥ç¡®ä¿æ‰€æœ‰æ“ä½œï¼ˆè¯»å–ã€å¤„ç†ã€å†™å…¥ï¼‰çš„ä¸€è‡´æ€§ã€‚å³ä½¿åœ¨å‘ç”Ÿæ•…éšœæ—¶ï¼Œæœªå®Œæˆçš„äº‹åŠ¡ä¹Ÿä¼šå›æ»šï¼Œä¿è¯ä¸ä¼šå‡ºç°é‡å¤å¤„ç†æˆ–æ•°æ®ä¸¢å¤±çš„æƒ…å†µã€‚</li>
</ul>
</li>
</ol>
<h3>2.3.2. GlobalKtable</h3>
<p><code>KTable</code>çš„æ•°æ®æ˜¯æŒ‰ä¸»é¢˜åˆ†åŒºçš„ï¼Œæ¯ä¸ªæµå¤„ç†åº”ç”¨å®ä¾‹åªå¤„ç†å…¶è´Ÿè´£çš„partitionçš„æ•°æ®ã€‚<code>globalKtable</code>ä¿å­˜æ¥è‡ªæ‰€æœ‰kafka stream clientè¾“å‡ºçš„ktableæ•°æ®ï¼Œç›¸åŒkeyçš„æƒ…å†µä¸‹ï¼Œkafkaçš„é¡ºåºæœºåˆ¶ä¿è¯åå†™å…¥çš„ä¼šè¦†ç›–ä¹‹å‰å†™å…¥çš„ã€‚</p>
<ul>
<li><strong>æ•°æ®åˆ†å¸ƒ</strong>ï¼š<ul>
<li><code>KTable</code>ï¼šæŒ‰åˆ†åŒºå¤„ç†ï¼Œæ¯ä¸ªå®ä¾‹åªå¤„ç†åˆ†é…ç»™å®ƒçš„åˆ†åŒºæ•°æ®ã€‚</li>
<li><code>GlobalKTable</code>ï¼šå…¨å±€å¤„ç†ï¼Œæ¯ä¸ªå®ä¾‹éƒ½æœ‰æ•´ä¸ªè¡¨çš„å‰¯æœ¬ã€‚</li>
</ul>
</li>
<li><strong>çŠ¶æ€å­˜å‚¨</strong>ï¼š<ul>
<li><code>KTable</code>ï¼šæœ¬åœ°çŠ¶æ€å­˜å‚¨ä¸åˆ†åŒºæ•°æ®ç›¸å…³ã€‚</li>
<li><code>GlobalKTable</code>ï¼šæœ¬åœ°çŠ¶æ€å­˜å‚¨æ•´ä¸ªè¡¨çš„æ•°æ®ã€‚</li>
</ul>
</li>
<li><strong>æŸ¥è¯¢èƒ½åŠ›</strong>ï¼š<ul>
<li><code>KTable</code>ï¼šåªèƒ½æŸ¥è¯¢æœ¬åœ°åˆ†åŒºæ•°æ®ã€‚</li>
<li><code>GlobalKTable</code>ï¼šå¯ä»¥æŸ¥è¯¢æ•´ä¸ªè¡¨çš„æ•°æ®ã€‚</li>
</ul>
</li>
<li><strong>ä½¿ç”¨åœºæ™¯</strong>ï¼š<ul>
<li><code>KTable</code>ï¼šé€‚ç”¨äºéœ€è¦å¯¹åˆ†åŒºæ•°æ®è¿›è¡Œå¤„ç†å’Œå˜æ¢çš„åœºæ™¯ã€‚</li>
<li><code>GlobalKTable</code>ï¼šé€‚ç”¨äºéœ€è¦å…¨å±€çŠ¶æ€è®¿é—®çš„åœºæ™¯ã€‚<blockquote>
<p>ä¼˜åŠ¿globalKtableçš„æ•°æ®åœ¨æœ¬åœ°ä¹Ÿä¼šç¼“å­˜ï¼Œå› æ­¤æ— æ³•é¿å…å¹¶å‘é—®é¢˜ï¼Œå¹¶å‘åœºæ™¯ä¸‹å»ºè®®å°†æ•°æ®å­˜å‚¨åˆ°å…³ç³»å‹æ•°æ®åº“æˆ–redisç­‰é›†ä¸­å¼ä»“åº“ã€‚</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<p><a href="https://hustclf.github.io/posts/cfee7ffb/">kafka streamsï¼šä¸€æ¬¾è½»é‡çº§æµå¼è®¡ç®—å¼•æ“ | å¤§é£å“¥çš„åšå®¢ (hustclf.github.io)</a><br><a href="https://blog.csdn.net/u012364631/article/details/94019707">KafkaStreamä¹‹æ—¶é—´çª—å£WindowBy_kafka steam windowedby æ—¶é—´ä¸å‡†ç¡®-CSDNåšå®¢</a></p>
<h2>2.4. ä»»åŠ¡åˆ†é…</h2>
<p>ç”±äºkafka streamçš„æ•°æ®æ¥æºæ˜¯topicï¼Œå› æ­¤kafka streamä»»åŠ¡çš„åˆ†é…ä¹Ÿå’Œpartitionçš„åˆ†é…ä¸€æ ·ï¼Œkafkaä¼šå°†å¤šä¸ªpartitionå¹³å‡åˆ†é…åˆ°å¤šä¸ªèŠ‚ç‚¹ä¸Šï¼Œå¦‚æœkafka stream clientçš„æ•°é‡å¤§äºkafka stream partitionï¼Œé‚£ä¹ˆä¼šå­˜åœ¨æŸä¸ªclientæ²¡æœ‰ä»»åŠ¡å¯ä»¥å¤„ç†çš„æƒ…å†µã€‚å½“kafka stream clientåŠ¨æ€å¢åŠ ä¼šå‡å°‘æ—¶ï¼Œä¼šå‡ºç°tasksé‡æ–°åˆ†é…ã€‚tasksé‡æ–°åˆ†é…éœ€è¦<code>state store</code>é‡å»ºç„¶åæ‰èƒ½ç»§ç»­æ‰§è¡Œtaskï¼Œ é‡å»º<code>state store</code>ä¼šä¼˜å…ˆä»æœ¬åœ°ç£ç›˜æ¢å¤ï¼Œè‹¥æ‰¾ä¸åˆ°æœ¬åœ°ç£ç›˜ä¿¡æ¯åˆ™ä¼šé€šè¿‡è¿œç«¯kafkaé›†ç¾¤çš„å¤‡ä»½topicæ¥é‡å»ºè¿™äº›ä¿¡æ¯ï¼Œå¯èƒ½ä¼šè€—æ—¶è¾ƒé•¿ã€‚</p>
<h2>2.5. æœ‰å‘æ— ç¯å›¾</h2>
<p><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian/202406222050375.png" alt="image.png"><br>System.out.println(topology.describe());topology ä¸­ processor æœ‰ä¸¤ç§æ¯”è¾ƒç‰¹æ®Šã€‚</p>
<ul>
<li>source processor: å®šä¹‰äº† topology çš„å…¥å£ï¼Œå³ä»å“ªäº›topic è¯»å–æ•°æ®  </li>
<li>sink processor: å®šä¹‰äº† topology çš„å‡ºå£ï¼Œå³å°†æœ€ç»ˆç»“æœå†™å…¥å“ªäº› topic</li>
</ul>
<pre><code class="language-java">public class App {  
    public static void main(String[] args) throws InterruptedException {  
        Properties properties = new Properties();  
        properties.put(StreamsConfig.APPLICATION_ID_CONFIG, &quot;wordcount-app&quot;);  
        properties.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9092&quot;);  
        properties.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());  
        properties.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());  
  
        Topology topology = new Topology();  
        StoreBuilder&lt;KeyValueStore&lt;String, Long&gt;&gt; countStoreBuilder =  
                Stores.keyValueStoreBuilder(  
                        Stores.persistentKeyValueStore(&quot;counts-store&quot;),  
                        Serdes.String(),  
                        Serdes.Long()  
                );  
        // å°†çŠ¶æ€å­˜å‚¨æ·»åŠ åˆ°æ‹“æ‰‘  
        topology.addStateStore(countStoreBuilder);  
  
        // ä½¿ç”¨text-lines-topicä½œä¸ºè¾“å…¥æºï¼Œkafka streamæ”¯æŒå®šä¹‰ä»å¤šä¸ªæ•°æ®æºè·å–æ•°æ®
        topology.addSource(&quot;Source&quot;, &quot;text-lines-topic&quot;)  
                // processor1: åˆ é™¤å¼•å·  
                .addProcessor(&quot;removeQuotes&quot;, RemoveQuotesProcessor::new,&quot;Source&quot;) 
                // processor2: å•è¯ç»Ÿè®¡  
                .addProcessor(&quot;wordCount&quot;, WordCountProcessor::new,&quot;removeQuotes&quot;)                 // wordCountéœ€è¦ç”¨åˆ°å•è¯è®¡æ•°ä½œä¸ºä¸­é—´çŠ¶æ€
                .connectProcessorAndStateStores(&quot;wordCount&quot;, &quot;counts-store&quot;) 
                // å°†æ•°æ®è¾“å‡ºåˆ°streams-wordcount-outputä¸­ï¼Œæ”¯æŒå¤šä¸ªtopicè¾“å‡ºï¼Œè¾“å‡ºçš„valueæ˜¯longç±»å‹ï¼Œæ‰€ä»¥éœ€è¦æŒ‡å®šä¸ºLongSerializer()
                .addSink(&quot;Sink&quot;, &quot;streams-wordcount-output&quot;, new StringSerializer(), new LongSerializer(), &quot;wordCount&quot;);  
        System.out.println(topology.describe());  
  
        KafkaStreams kafkaStreams = new KafkaStreams(topology, properties);  
        kafkaStreams.setUncaughtExceptionHandler((Thread thread, Throwable throwable) -&gt; {  
            System.err.println(&quot;Uncaught exception in thread &quot; + thread + &quot;: &quot; + throwable);  
            throwable.printStackTrace();  
        });  
  
        kafkaStreams.setStateListener((newState, oldState) -&gt; {  
            System.out.println(&quot;State changed from &quot; + oldState + &quot; to &quot; + newState);  
        });  
  
        kafkaStreams.start();  
    }  
  
    static class RemoveQuotesProcessor implements Processor&lt;String, String, String, String&gt; {  
  
        /**  
         * æ³›å‹1ï¼šå½“å‰processorå¤„ç†åè¾“å‡ºçš„keyçš„ç±»å‹  
         * æ³›å‹2ï¼šå½“å‰processorå¤„ç†åè¾“å‡ºçš„valueçš„ç±»å‹  
         */  
        private ProcessorContext&lt;String, String&gt; context;  
  
        /**  
         * åªè°ƒç”¨ä¸€æ¬¡ï¼Œåœ¨å¤„ç†å™¨å¼€å§‹å¤„ç†æ•°æ®ä¹‹å‰è¢«è°ƒç”¨ï¼Œç”¨äºåˆå§‹åŒ–å¤„ç†å™¨ã€‚  
         * 1. è·å–å’Œå­˜å‚¨ ProcessorContextã€‚  
         * 2. åˆå§‹åŒ–ä»»ä½•éœ€è¦çš„èµ„æº,å¦‚çŠ¶æ€å­˜å‚¨ã€‚  
         * 3. è®¾ç½®å®šæ—¶å™¨æˆ–è°ƒåº¦å®šæœŸæ“ä½œ  
         */  
        @Override  
        public void init(ProcessorContext&lt;String, String&gt; context) {  
            this.context = context;  
        }  
  
        @Override  
        public void process(Record&lt;String, String&gt; record) {  
            String replace = record.value().replace(&quot;\&quot;&quot;, &quot;&quot;);  
            // åˆ›å»ºæ–°çš„è®°å½•ï¼Œå¹¶ä¿ç•™åŸå§‹è®°å½•çš„æ—¶é—´æˆ³  
            context.forward(record.withValue(replace));  
        }  
  
        @Override  
        public void close() {  
            Processor.super.close();  
        }  
    }  
  
    static class WordCountProcessor implements Processor&lt;String, String, String, Long&gt; {  
  
        private ProcessorContext&lt;String, Long&gt; context;  
        private KeyValueStore&lt;String, Long&gt; kvStore;  
  
        @Override  
        public void init(ProcessorContext&lt;String, Long&gt; context) {  
            this.context = context;  
            // åˆå§‹åŒ–è®¡æ•°å™¨ï¼Œç”¨äºå­˜å‚¨ä¸­é—´è®¡ç®—çŠ¶æ€ï¼Œä»¥ä¾¿è¿›è¡Œæµå¼è®¡ç®—
            this.kvStore = context.getStateStore(&quot;counts-store&quot;);  
        }  
  
        @Override  
        public void process(Record&lt;String, String&gt; record) {  
            String[] words = record.value().toLowerCase().split(&quot;\\W+&quot;);  
            for (String word : words) {  
                Long count = kvStore.get(word);  
                if (count == null) {  
                    kvStore.put(word, 1L);  
                    context.forward(new Record&lt;&gt;(word, 1L, record.timestamp()));  
                } else {  
                    kvStore.put(word, count + 1);  
                    context.forward(new Record&lt;&gt;(word, count + 1, record.timestamp()));  
                }  
            }  
        }  
    }  
}
</code></pre>
<p>æ‰“å°å‡ºæ¥çš„topologyå¦‚ä¸‹ï¼š</p>
<pre><code>Topologies:
   Sub-topology: 0
    Source: Source (topics: [text-lines-topic])
      --&gt; removeQuotes
    Processor: removeQuotes (stores: [])
      --&gt; wordCount
      &lt;-- Source
    Processor: wordCount (stores: [counts-store])
      --&gt; Sink
      &lt;-- removeQuotes
    Sink: Sink (topic: streams-wordcount-output)
      &lt;-- wordCount
</code></pre>
<h2>2.6. æ—¶é—´</h2>
<p>timeæ˜¯kafka streamsä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„æ¦‚å¿µï¼Œä¸‹æ–‡åŸºäºçª—å£çš„å¤„ç†æ“ä½œä¹Ÿä¾èµ–æ—¶é—´å®šä¹‰æ¥åˆ’åˆ†è¾¹ç•Œã€‚kakfa streamsåˆ†ä¸º3ç§æ—¶é—´å®šä¹‰ï¼š</p>
<ul>
<li>Event timeï¼š äº‹ä»¶çœŸå®å‘ç”Ÿçš„æ—¶é—´ï¼Œåœ¨å†™å…¥kafkaæ—¶å¯ä»¥æŒ‡å®š timestampæ¥è¡¨è¿°è¯¥æ—¶é—´ã€‚å¦‚æœäº‹ä»¶æ˜¯æ±½è½¦GPSä¼ æ„Ÿå™¨æŠ¥å‘Šçš„åœ°ç†ä½ç½®å˜åŒ–ï¼Œåˆ™ç›¸å…³çš„äº‹ä»¶æ—¶é—´å°±æ˜¯GPSä¼ æ„Ÿå™¨æ•è·ä½ç½®å˜åŒ–çš„æ—¶é—´ã€‚</li>
<li>Processing timeï¼šæ—¥å¿—åœ¨kafka streamsä»»åŠ¡ä¸­å¤„ç†æ—¶çš„æ—¶é—´ï¼Œå³è®°å½•è¢«æ¶ˆè´¹çš„æ—¶é—´ã€‚å¤„ç†æ—¶é—´å¯èƒ½æ¯”åŸå§‹äº‹ä»¶æ—¶é—´æ™šå‡ æ¯«ç§’ã€å‡ å°æ—¶æˆ–å‡ å¤©ç­‰ã€‚æƒ³è±¡ä¸€ä¸ªåˆ†æå¹³å°ï¼Œå®ƒè¯»å–å’Œå¤„ç†æ¥è‡ªæ±½è½¦ä¼ æ„Ÿå™¨çš„åœ°ç†ä½ç½®æ•°æ®ï¼Œå¹¶å°†å…¶å‘ˆç°åœ¨è½¦é˜Ÿç®¡ç†ä»ªè¡¨æ¿ä¸Šã€‚åœ¨è¿™é‡Œï¼Œåˆ†æåº”ç”¨ç¨‹åºçš„å¤„ç†æ—¶é—´å¯èƒ½æ¯”äº‹ä»¶æ—¶é—´æ™šå‡ æ¯«ç§’æˆ–å‡ ç§’(ä¾‹å¦‚ï¼ŒåŸºäºApache Kafkaå’ŒKafka Streamsçš„å®æ—¶ç®¡é“)ï¼Œæˆ–è€…æ™šå‡ å°æ—¶(ä¾‹å¦‚ï¼ŒåŸºäºApache Hadoopæˆ–Apache Sparkçš„æ‰¹å¤„ç†ç®¡é“)ã€‚</li>
<li>Ingestion timeï¼šè®°å½•æ—¥å¿—è¢«å†™è¿›kafkaçš„topicçš„æ—¶é—´ã€‚ä¸äº‹ä»¶æ—¶é—´çš„åŒºåˆ«åœ¨äºï¼Œè¿™ä¸ªæ‘„å…¥æ—¶é—´æˆ³æ˜¯åœ¨Kafka brokerå°†è®°å½•è¿½åŠ åˆ°ç›®æ ‡topicæ—¶ç”Ÿæˆçš„ï¼Œè€Œä¸æ˜¯åœ¨&quot;æºå¤´&quot;åˆ›å»ºè®°å½•æ—¶ç”Ÿæˆçš„ã€‚ä¸å¤„ç†æ—¶é—´çš„åŒºåˆ«åœ¨äºï¼Œå¤„ç†æ—¶é—´æ˜¯æµå¤„ç†åº”ç”¨ç¨‹åºå¤„ç†è®°å½•çš„æ—¶é—´ã€‚ä¾‹å¦‚,å¦‚æœä¸€ä¸ªè®°å½•ä»æœªè¢«å¤„ç†ï¼Œå®ƒå°±æ²¡æœ‰å¤„ç†æ—¶é—´çš„æ¦‚å¿µï¼Œä½†å®ƒä»ç„¶æœ‰æ‘„å…¥æ—¶é—´ã€‚<br>äº‹ä»¶æ—¶é—´å’Œæ‘„å…¥æ—¶é—´ä¹‹é—´çš„é€‰æ‹©å®é™…ä¸Šæ˜¯é€šè¿‡Kafkaçš„é…ç½®æ¥å®Œæˆçš„(è€Œä¸æ˜¯Kafka Streams)ã€‚ä»Kafka 0.10.xå¼€å§‹ï¼Œæ—¶é—´æˆ³ä¼šè‡ªåŠ¨åµŒå…¥åˆ°Kafkaæ¶ˆæ¯ä¸­ã€‚æ ¹æ®Kafkaçš„é…ç½®ï¼Œè¿™äº›æ—¶é—´æˆ³ä»£è¡¨äº‹ä»¶æ—¶é—´æˆ–æ‘„å…¥æ—¶é—´ã€‚ç›¸åº”çš„Kafkaé…ç½®è®¾ç½®å¯ä»¥åœ¨brokerçº§åˆ«æˆ–æ¯ä¸ªtopicä¸ŠæŒ‡å®šã€‚Kafka Streamsä¸­çš„é»˜è®¤æ—¶é—´æˆ³æå–å™¨å°†æŒ‰åŸæ ·æ£€ç´¢è¿™äº›åµŒå…¥çš„æ—¶é—´æˆ³ã€‚å› æ­¤ï¼Œåº”ç”¨ç¨‹åºçš„æœ‰æ•ˆæ—¶é—´è¯­ä¹‰å–å†³äºè¿™äº›åµŒå…¥æ—¶é—´æˆ³çš„Kafkaé…ç½®ã€‚</li>
</ul>
<p>Kafka Streamsé€šè¿‡TimestampExtractoræ¥å£ä¸ºæ¯ä¸ªæ•°æ®è®°å½•åˆ†é…ä¸€ä¸ªæ—¶é—´æˆ³ã€‚æ¯æ¡è®°å½•çš„æ—¶é—´æˆ³æè¿°äº†æµåœ¨æ—¶é—´æ–¹é¢çš„è¿›å±•ï¼Œå¹¶è¢«è¯¸å¦‚çª—å£æ“ä½œç­‰ä¾èµ–æ—¶é—´çš„æ“ä½œæ‰€ä½¿ç”¨ã€‚å› æ­¤ï¼Œè¿™ä¸ªæ—¶é—´åªæœ‰åœ¨æ–°è®°å½•åˆ°è¾¾å¤„ç†å™¨æ—¶æ‰ä¼šå‰è¿›ã€‚æˆ‘ä»¬å°†è¿™ç§æ•°æ®é©±åŠ¨çš„æ—¶é—´ç§°ä¸ºåº”ç”¨ç¨‹åºçš„stream timeï¼Œä»¥åŒºåˆ«äºåº”ç”¨ç¨‹åºå®é™…æ‰§è¡Œæ—¶çš„wall-clock timeã€‚TimestampExtractoræ¥å£çš„å…·ä½“å®ç°å°†ä¸ºstream timeå®šä¹‰æä¾›ä¸åŒçš„è¯­ä¹‰ã€‚ä¾‹å¦‚ï¼ŒåŸºäºæ•°æ®è®°å½•çš„å®é™…å†…å®¹(å¦‚åµŒå…¥çš„æ—¶é—´æˆ³å­—æ®µ)æ£€ç´¢æˆ–è®¡ç®—æ—¶é—´æˆ³ï¼Œä»¥æä¾›äº‹ä»¶æ—¶é—´è¯­ä¹‰ï¼Œè€Œè¿”å›å½“å‰wall-clock timeåˆ™ä¸ºstream timeæä¾›å¤„ç†æ—¶é—´è¯­ä¹‰ã€‚å› æ­¤ï¼Œå¼€å‘äººå‘˜å¯ä»¥æ ¹æ®å…¶ä¸šåŠ¡éœ€æ±‚å¼ºåˆ¶æ‰§è¡Œä¸åŒçš„æ—¶é—´æ¦‚å¿µã€‚</p>
<p>æœ€åï¼Œå½“Kafka Streamsåº”ç”¨ç¨‹åºå‘Kafkaå†™å…¥è®°å½•æ—¶ï¼Œå®ƒä¹Ÿä¼šä¸ºè¿™äº›æ–°è®°å½•åˆ†é…æ—¶é—´æˆ³ã€‚æ—¶é—´æˆ³çš„åˆ†é…æ–¹å¼å–å†³äºä¸Šä¸‹æ–‡:</p>
<ol>
<li>å½“é€šè¿‡å¤„ç†æŸäº›è¾“å…¥è®°å½•ç”Ÿæˆæ–°çš„è¾“å‡ºè®°å½•æ—¶ï¼Œä¾‹å¦‚åœ¨process()å‡½æ•°è°ƒç”¨ä¸­è§¦å‘çš„context.forward()ï¼Œè¾“å‡ºè®°å½•æ—¶é—´æˆ³ç›´æ¥ç»§æ‰¿è‡ªè¾“å…¥è®°å½•æ—¶é—´æˆ³ã€‚</li>
<li>å½“é€šè¿‡å‘¨æœŸæ€§å‡½æ•°(å¦‚Punctuator<span class="tag">#punctuate</span>())ç”Ÿæˆæ–°çš„è¾“å‡ºè®°å½•æ—¶ï¼Œè¾“å‡ºè®°å½•æ—¶é—´æˆ³è¢«å®šä¹‰ä¸ºæµä»»åŠ¡çš„å½“å‰å†…éƒ¨æ—¶é—´(é€šè¿‡context.timestamp()è·å¾—)ã€‚</li>
<li>å¯¹äºèšåˆæ“ä½œï¼Œç»“æœæ›´æ–°è®°å½•çš„æ—¶é—´æˆ³å°†æ˜¯æ‰€æœ‰è´¡çŒ®åˆ°ç»“æœçš„è¾“å…¥è®°å½•çš„æœ€å¤§æ—¶é—´æˆ³ã€‚<br>ä¹Ÿå¯ä»¥åœ¨Processor APIä¸­é€šè¿‡åœ¨è°ƒç”¨<code>&lt;span class=&quot;tag&quot;&gt;#forward&lt;/span&gt;()</code>æ—¶æ˜¾å¼åœ°ä¸ºè¾“å‡ºè®°å½•åˆ†é…æ—¶é—´æˆ³æ¥æ”¹å˜é»˜è®¤è¡Œä¸ºã€‚</li>
</ol>
<p>å¯¹äºèšåˆå’Œè¿æ¥æ“ä½œ,æ—¶é—´æˆ³çš„è®¡ç®—éµå¾ªä»¥ä¸‹è§„åˆ™:</p>
<ol>
<li>å¯¹äºå…·æœ‰å·¦å³è¾“å…¥è®°å½•çš„è¿æ¥æ“ä½œ(stream-stream, table-table)ï¼Œè¾“å‡ºè®°å½•çš„æ—¶é—´æˆ³è¢«åˆ†é…ä¸ºmax(left.ts, right.ts)ã€‚</li>
<li>å¯¹äºstream-tableè¿æ¥ï¼Œè¾“å‡ºè®°å½•è¢«åˆ†é…æ¥è‡ªæµè®°å½•çš„æ—¶é—´æˆ³ã€‚</li>
<li>å¯¹äºèšåˆæ“ä½œï¼ŒKafka Streamsè¿˜ä¼šè®¡ç®—æ‰€æœ‰è®°å½•çš„æœ€å¤§æ—¶é—´æˆ³ï¼ŒæŒ‰é”®è®¡ç®—ï¼Œå¯ä»¥æ˜¯å…¨å±€çš„(å¯¹äºéçª—å£åŒ–æ“ä½œ)æˆ–æ¯ä¸ªçª—å£çš„ã€‚</li>
<li>å¯¹äºæ— çŠ¶æ€æ“ä½œï¼Œè¾“å…¥è®°å½•æ—¶é—´æˆ³è¢«ç›´æ¥ä¼ é€’ã€‚å¯¹äºflatMapåŠå…¶å…„å¼Ÿæ“ä½œ(å‘å‡ºå¤šä¸ªè®°å½•)ï¼Œæ‰€æœ‰è¾“å‡ºè®°å½•éƒ½ç»§æ‰¿è‡ªç›¸åº”è¾“å…¥è®°å½•çš„æ—¶é—´æˆ³ã€‚</li>
</ol>
<h2>2.7. çª—å£</h2>
<p>kafka Streamsçª—å£é»˜è®¤æ˜¯é”®æ§çª—å£ï¼ˆæ¯ä¸ªkeyæœ‰ç‹¬ç«‹çª—å£ç»´æŠ¤ï¼‰ã€‚åœ¨Kafka Streamsä¸­ï¼Œæ—¶é—´çª—å£æ“ä½œé€šå¸¸æ˜¯åœ¨åˆ†ç»„ï¼ˆgroupedï¼‰æˆ–è€…å·²åˆ†ç»„ï¼ˆkeyedï¼‰çš„æµä¸Šè¿›è¡Œçš„ï¼Œæ¯ä¸ªä¸åŒçš„ key éƒ½æœ‰å…¶ç‹¬ç«‹çš„æ—¶é—´çª—å£é›†åˆã€‚è¿™æ„å‘³ç€ç›¸åŒkeyçš„æ¶ˆæ¯ä¼šè¢«èšåˆåˆ°åŒä¸€ä¸ªçª—å£ä¸­ï¼Œè€Œä¸åŒkeyçš„æ¶ˆæ¯åˆ™åˆ†åˆ«è¿›å…¥å„è‡ªçš„çª—å£ã€‚<br>å¥½å¤„:</p>
<ul>
<li>è¿™ç§è®¾è®¡å…è®¸å¹¶è¡Œå¤„ç†ä¸åŒ key çš„æ•°æ®ã€‚</li>
<li>å¯ä»¥ç‹¬ç«‹åœ°å¯¹æ¯ä¸ª key è¿›è¡Œèšåˆã€è®¡æ•°æˆ–å…¶ä»–çª—å£æ“ä½œã€‚<br>å‡è®¾æ‚¨åœ¨å¤„ç†ç”¨æˆ·ç‚¹å‡»æ•°æ®ï¼Œkey æ˜¯ç”¨æˆ· IDã€‚æ¯ä¸ªç”¨æˆ·ï¼ˆæ¯ä¸ª keyï¼‰éƒ½ä¼šæœ‰è‡ªå·±çš„ä¸€ç»„æ—¶é—´çª—å£ï¼Œç”¨äºç»Ÿè®¡è¯¥ç”¨æˆ·åœ¨ä¸åŒæ—¶é—´æ®µçš„ç‚¹å‡»æ¬¡æ•°ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸€äº›æ–¹æ¡ˆå¯ä»¥å®ç°éé”®æ§çª—å£ï¼ˆå…¨å±€çª—å£ï¼‰ï¼Œä¾‹å¦‚ï¼š</li>
</ul>
<pre><code class="language-java">KStream&lt;String, Long&gt; input = ...;

KTable&lt;Windowed&lt;String&gt;, Long&gt; windowedCounts = input
    .selectKey((k, v) -&gt; &quot;global&quot;)  // å°†æ‰€æœ‰æ¶ˆæ¯åˆ†é…åˆ°åŒä¸€ä¸ª key
    .groupByKey()
    .windowedBy(TimeWindows.of(Duration.ofMinutes(5)))
    .count();
</code></pre>
<p>kafka streamsçš„DSLæä¾›äº†å¤šç§[æ—¶é—´çª—å£](<a href="https://kafka.apache.org/31/documentation/streams/developer-guide/dsl-api">https://kafka.apache.org/31/documentation/streams/developer-guide/dsl-api</a><span class="tag">#sliding-time-windows</span>)</p>
<table>
<thead>
<tr>
<th>çª—å£ç±»å‹</th>
<th>è¡¨ç°</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>Hopping time window</td>
<td>åŸºäºæ—¶é—´</td>
<td>å¤§å°å›ºå®šã€é‡å çš„çª—å£</td>
</tr>
<tr>
<td>Tumbling time window</td>
<td>åŸºäºæ—¶é—´</td>
<td>å¤§å°å›ºå®šã€ä¸é‡å çš„çª—å£</td>
</tr>
<tr>
<td>Sliding time window</td>
<td>åŸºäºæ—¶é—´</td>
<td>å¤§å°å›ºå®šï¼Œé‡å çš„çª—å£ï¼Œä»…ç”¨äºjoinè®¡ç®—çš„çª—å£</td>
</tr>
<tr>
<td>Session window</td>
<td>åŸºäºsession</td>
<td>å¤§å°ä¸å›ºå®šã€ä¸é‡å çš„ã€åŸºäºæ•°æ®é©±åŠ¨çš„çª—å£</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3>2.7.1. hopping time window</h3>
<p>å®šä¹‰ä¸€ä¸ªå¤§å°ä¸º5åˆ†é’Ÿã€é—´éš”ä¸º1åˆ†é’Ÿçš„Hopping time windowã€‚kafkaçª—å£é‡‡ç”¨å·¦é—­å³å¼€åŸåˆ™ï¼Œå³çª—å£æ˜¯<code>[0,5),[5,10),[10,15)....</code></p>
<pre><code class="language-java">// A hopping time window with a size of 5 minutes and an advance interval of 1 minute.  
Duration windowSize = Duration.ofMinutes(5);  
Duration advance = Duration.ofMinutes(1);  
TimeWindows.ofSizeWithNoGrace(windowSize).advanceBy(advance);
</code></pre>
<p><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian/202406262317017.png" alt="image.png"></p>
<h3>2.7.2. Tumbling time window</h3>
<p>Tumbling time windowæ˜¯hopping time windowçš„ä¸€ç§ç‰¹ä¾‹ï¼Œå³windowså’Œintervalä¸€æ ·å¤§ã€‚è¿™ç§çª—å£ç›¸äº’ä¹‹é—´ä¸ä¼šé‡å ï¼Œå¯ä»¥ä¿è¯ä¸€ä¸ªè®°å½•åªä¼šå±äºä¸€ä¸ªçª—å£ã€‚kafkaçª—å£é‡‡ç”¨å·¦é—­å³å¼€åŸåˆ™ï¼Œå®šä¹‰ä¸€ä¸ªå¤§å°ä¸º5åˆ†é’Ÿçš„Tumbling time windowï¼Œ<code>[0,5),[5,10),[10,15)....</code></p>
<pre><code class="language-java">// A tumbling time window with a size of 5 minutes (and, by definition, an implicit  
// advance interval of 5 minutes), and grace period of 1 minute.  
Duration windowSize = Duration.ofMinutes(5);  
Duration gracePeriod = Duration.ofMinutes(1);  
TimeWindows.ofSizeAndGrace(windowSize, gracePeriod);  
  
// The above is equivalent to the following code:  
TimeWindows.ofSizeAndGrace(windowSize, gracePeriod).advanceBy(windowSize);
</code></pre>
<p><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian/202406262304468.png" alt="image.png"><br>The grace period to admit out-of-order events to a window. Must be non-negative. æ˜¯ä¸€ä¸ªçª—å£åœ¨å…¶åŸå®šç»“æŸæ—¶é—´åï¼Œé¢å¤–ç­‰å¾…è¿Ÿåˆ°æ•°æ®çš„æ—¶é—´æ®µã€‚å®ƒå…è®¸åœ¨çª—å£ç»“æŸåçš„ä¸€æ®µæ—¶é—´å†…ç»§ç»­æ¥å—å’Œå¤„ç†è¿Ÿåˆ°çš„æ•°æ®ï¼Œè€Œä¸ä¼šç«‹å³å…³é—­çª—å£ã€‚</p>
<p>ä»¥ä¸‹ä»£ç ï¼Œæ¯éš”10ç§’å¯¹å½“å‰çª—å£å†…çš„å•è¯æ•°é‡è¿›è¡Œè®¡æ•°ã€‚</p>
<pre><code class="language-java">public static void main(String[] args) throws InterruptedException {  
    Properties properties = new Properties();  
    properties.put(StreamsConfig.APPLICATION_ID_CONFIG, &quot;wordcount-app&quot;);  
    properties.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9092&quot;);  
    properties.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());  
    properties.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());  
  
    StreamsBuilder builder = new StreamsBuilder();  
    builder.stream(&quot;text-lines-topic&quot;, Consumed.with(Serdes.String(), Serdes.String()))  
            .map((key, value) -&gt; new KeyValue&lt;&gt;(key, value.replace(&quot;\&quot;&quot;, &quot;&quot;)))  
            .flatMapValues((key, textLine) -&gt; Arrays.asList(textLine.toLowerCase().split(&quot;\\W+&quot;)))  
            .groupBy((key, word) -&gt; word)  
            .windowedBy(TimeWindows.ofSizeAndGrace(Duration.ofSeconds(10), Duration.ofSeconds(2)))  
            .count()  
            .toStream()  
            .map((key, value) -&gt; new KeyValue&lt;&gt;(key.key(), value))  
            .to(&quot;streams-wordcount-output&quot;, Produced.with(Serdes.String(), Serdes.Long()));  
  
    KafkaStreams kafkaStreams = new KafkaStreams(builder.build(), properties);  
    kafkaStreams.setUncaughtExceptionHandler((Thread thread, Throwable throwable) -&gt; {  
        System.err.println(&quot;Uncaught exception in thread &quot; + thread + &quot;: &quot; + throwable);  
        throwable.printStackTrace();  
    });  
  
    kafkaStreams.setStateListener((newState, oldState) -&gt; {  
        System.out.println(&quot;State changed from &quot; + oldState + &quot; to &quot; + newState);  
    });  
  
    kafkaStreams.start();  
}
</code></pre>
<h3>2.7.3. slide time window</h3>
<h1>3. dockerå®‰è£…kafkaæµ‹è¯•</h1>
<p><a href="https://kafka.apache.org/31/documentation/streams/quickstart">Apache Kafka</a></p>
<pre><code class="language-shell"># zookeeper
docker run -d --name zookeeper -p 2181:2181 -t wurstmeister/zookeeper
# kafka, docker inspectæŸ¥çœ‹zookeeperåœ°å€å¹¶é…ç½®
docker run -d --name kafka -p 9092:9092 -e KAFKA_BROKER_ID=0 -e KAFKA_ZOOKEEPER_CONNECT=172.17.0.2:2181 -e KAFKA_ADVERTISED_LISTENERS=PLAINTEXT://localhost:9092 -e KAFKA_LISTENERS=PLAINTEXT://0.0.0.0:9092 wurstmeister/kafka
</code></pre>
<p>è¿›å…¥kafkaå®¹å™¨åï¼Œåˆ›å»ºtopic</p>
<pre><code class="language-shell">/opt/kafka_2.13-2.8.1/bin/kafka-topics.sh --bootstrap-server localhost:9092 --create --topic text-lines-topic --partitions 1 --replication-factor 1
</code></pre>
<p>è¿è¡Œä»¥ä¸‹ä»£ç ï¼Œè¿›è¡Œæµå¼è®¡ç®—ï¼Œå•è¯ç»Ÿè®¡</p>
<pre><code class="language-java">public class App {  
    public static void main(String[] args) {  
        Properties properties = new Properties();  
        properties.put(StreamsConfig.APPLICATION_ID_CONFIG, &quot;wordcount-app&quot;);  
        properties.put(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, &quot;localhost:9092&quot;);  
        properties.put(StreamsConfig.DEFAULT_KEY_SERDE_CLASS_CONFIG, Serdes.String().getClass());  
        properties.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());  
  
        StreamsBuilder builder = new StreamsBuilder();  
        builder  
                // ä½¿ç”¨topic text-lines-topicä½œä¸ºè¾“å…¥æº  
                .&lt;String, String&gt;stream(&quot;text-lines-topic&quot;)  
                // å°†æ¯ä¸ªå°æ—¶è½¬æ¢ä¸ºå•è¯åˆ—è¡¨  
                    .flatMapValues(textLine -&gt; Arrays.asList(textLine.toLowerCase().split(&quot;\\W+&quot;)))  
                // æŒ‰ç…§å•è¯åˆ†ç»„  
                .groupBy((key, word) -&gt; word)  
                // 1. å¯¹æ¯ä¸ªå•è¯è®¡æ•°  
                // 2. å°†KTableæŒä¹…åŒ–åˆ°ä¸€ä¸ªåä¸º&quot;counts-store&quot;çš„çŠ¶æ€å­˜å‚¨ä¸­(é»˜è®¤ä½¿ç”¨RocksDB)  
                .count(Materialized.as(&quot;counts-store&quot;))  
                // å°†æŠ€æœ¯ç»“æœè¾“å‡ºåˆ°topic streams-wordcount-outputä¸­  
                .toStream().to(&quot;streams-wordcount-output&quot;, Produced.with(Serdes.String(), Serdes.Long()));  
  
        Topology topology = builder.build();  
        KafkaStreams streams = new KafkaStreams(topology, properties); 
        streams.start();  
    }  
}
</code></pre>
<p>ç”Ÿäº§æ¶ˆæ¯</p>
<pre><code class="language-shell">/opt/kafka_2.13-2.8.1/bin/kafka-console-producer.sh --bootstrap-server localhost:9092 --topic text-lines-topic
&gt;good good study
&gt;day day up
&gt;good good study
&gt;day day up
&gt;good good study
&gt;day day up
&gt;good good study
&gt;day day up up
</code></pre>
<p>æ¶ˆè´¹è€…</p>
<pre><code class="language-shell">/opt/kafka_2.13-2.8.1/bin/kafka-console-consumer.sh --bootstrap-server localhost:9092 --topic streams-wordcount-output --from-beginning --formatter kafka.tools.DefaultMessageFormatter --property print.key=true --property print.value=true --property key.deserializer=org.apache.kafka.common.serialization.StringDeserializer --property value.deserializer=org.apache.kafka.common.serialization.LongDeserializer
# è¾“å‡º
good	6
study	3
day	6
up	3
good	8
study	4
day	8
up	5
</code></pre>
<blockquote>
<p>è¾“å‡ºæ˜¯ä¸€ä¸ªè¿ç»­çš„ï¼Œä¸æ–­è¢«æ›´æ–°çš„æµ</p>
</blockquote>
<p>å°†åº”ç”¨é‡å¯åï¼Œproducerç”Ÿäº§æ–°æ¶ˆæ¯<code>good good study</code>ï¼Œä¼šå‘ç°ä¸‹æ¸¸topicä¸­è®¡æ•°ä¼šæ›´æ–°</p>
<pre><code>good    10
study	5
</code></pre>
<pre><code class="language-shell">/opt/kafka_2.13-2.8.1/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
# è¾“å‡º
/opt/kafka_2.13-2.8.1/bin/kafka-topics.sh --bootstrap-server localhost:9092 --list
__consumer_offsets
streams-wordcount-output
text-lines-topic
wordcount-app-KSTREAM-AGGREGATE-STATE-STORE-0000000004-changelog
wordcount-app-KSTREAM-AGGREGATE-STATE-STORE-0000000004-repartition
wordcount-app-counts-store-changelog
wordcount-app-counts-store-repartition
</code></pre>
}
    </section>
</article>
            </div>
        </main>
        <footer class="page-footer">
            <div class="container">
                <p>&copy; 2026 Shinerio's Blog. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Theme switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.getElementById('theme-body');

            // Check for saved theme preference or respect OS preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            // Set initial theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
                body.setAttribute('data-theme', 'dark');
            } else {
                body.removeAttribute('data-theme'); // light theme
            }

            // Toggle theme function
            function toggleTheme() {
                if (body.getAttribute('data-theme') === 'dark') {
                    body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Add event listener to theme toggle button
            themeToggle.addEventListener('click', toggleTheme);

            // Listen for OS theme changes
            prefersDarkScheme.addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        body.setAttribute('data-theme', 'dark');
                    } else {
                        body.removeAttribute('data-theme');
                    }
                }
            });

            // Search functionality
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchResults = document.getElementById('search-results');
            const searchSuggestions = document.getElementById('search-suggestions');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');

            if (searchInput && searchButton) {
                let searchData = null;

                // Load search data
                async function loadSearchData() {
                    try {
                        const response = await fetch('./assets/js/search-data.json');
                        if (response.ok) {
                            searchData = await response.json();
                        } else {
                            console.error('Failed to load search data:', response.status);
                        }
                    } catch (error) {
                        console.error('Error loading search data:', error);
                    }
                }

                // Initialize search data
                loadSearchData();

                // Debounce function to limit search calls
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // Get selected search type
                function getSelectedSearchType() {
                    const selectedRadio = document.querySelector('input[name="search-type"]:checked');
                    return selectedRadio ? selectedRadio.value : 'all';
                }

                // Perform search
                function performSearch(query) {
                    if (!searchData || !query.trim()) {
                        searchResults.innerHTML = '';
                        searchSuggestions.innerHTML = '';
                        return;
                    }

                    const queryTerms = query.toLowerCase().split(/\s+/).filter(term => term.length > 0);
                    const searchType = getSelectedSearchType();

                    if (queryTerms.length === 0) {
                        searchResults.innerHTML = '';
                        return;
                    }

                    const results = [];

                    // Search through articles
                    searchData.articles.forEach(article => {
                        let score = 0;
                        let snippet = '';

                        // Get content based on search type
                        const lowerTitle = article.title.toLowerCase();
                        const lowerContent = article.content.toLowerCase();
                        const lowerTags = article.tags.join(' ').toLowerCase();

                        queryTerms.forEach(term => {
                            switch(searchType) {
                                case 'title':
                                    // Only title matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    break;
                                case 'content':
                                    // Only content matches count (fixed to exclude title matches)
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    break;
                                case 'all':
                                default:
                                    // Both title and content matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    // Tag matches get medium-high score
                                    if (lowerTags.includes(term)) {
                                        score += 5;
                                    }
                                    break;
                            }
                        });

                        if (score > 0) {
                            // Generate snippet based on search type
                            let content = '';

                            if (searchType === 'title') {
                                // For title-only search, show title content
                                content = article.title.substring(0, 200);
                            } else if (searchType === 'content') {
                                // For content-only search, show content excerpt
                                content = article.content.substring(0, 200);
                            } else {
                                // For all search, show content with title as context
                                content = article.content.substring(0, 200);
                            }

                            // Find first occurrence of query term in content for snippet
                            queryTerms.forEach(term => {
                                let searchIn = content.toLowerCase();
                                if (searchType === 'title') {
                                    searchIn = lowerTitle;
                                } else if (searchType === 'content') {
                                    searchIn = lowerContent;
                                }

                                const index = searchIn.indexOf(term);
                                if (index !== -1) {
                                    // Expand snippet around the match
                                    let start, end;
                                    if (searchType === 'title') {
                                        start = Math.max(0, index - 15);
                                        end = Math.min(content.length, index + term.length + 35);
                                    } else {
                                        start = Math.max(0, index - 30);
                                        end = Math.min(content.length, index + term.length + 70);
                                    }

                                    content = (start > 0 ? '...' : '') +
                                              content.substring(start, end) +
                                              (end < (searchType === 'title' ? article.title.length : article.content.length) ? '...' : '');

                                    // Highlight the term in the snippet
                                    const searchContent = searchType === 'title' ? article.title : article.content;
                                    const adjustedIndex = searchType === 'title' ?
                                        Math.min(index, article.title.length - 1) :
                                        Math.min(index, article.content.length - 1);

                                    content = content.replace(
                                        new RegExp(`(${escapeRegExp(term)})`, 'gi'),
                                        '<mark>$1</mark>'
                                    );
                                }
                            });

                            results.push({
                                article: article,
                                score: score,
                                snippet: content
                            });
                        }
                    });

                    // Sort results by score
                    results.sort((a, b) => b.score - a.score);

                    // Display results
                    displaySearchResults(results);
                }

                // Display search results
                function displaySearchResults(results) {
                    if (results.length === 0) {
                        searchResults.innerHTML = '<p class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>';
                        return;
                    }

                    const resultsHTML = results.map(result => `
                        <div class="search-result-item">
                            <h3 class="search-result-title">
                                <a href="./${result.article.slug}.html">${highlightQueryTerms(result.article.title, document.querySelector('#search-input').value)}</a>
                            </h3>
                            <div class="search-result-meta">
                                ${result.article.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                            </div>
                            <p class="search-result-excerpt">${result.snippet}</p>
                        </div>
                    `).join('');

                    searchResults.innerHTML = resultsHTML;
                }

                // Highlight query terms in text
                function highlightQueryTerms(text, query) {
                    if (!query.trim()) return text;

                    const queryTerms = query.split(/\s+/).filter(term => term.length > 0);
                    let highlightedText = text;

                    queryTerms.forEach(term => {
                        const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');
                    });

                    return highlightedText;
                }

                // Escape special regex characters
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Event listener for search button
                searchButton.addEventListener('click', function() {
                    const query = searchInput.value;
                    performSearch(query);
                });

                // Event listener for Enter key
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        const query = searchInput.value;
                        performSearch(query);
                    }
                });

                // Add debounced input handler for live search (optional)
                const debouncedSearch = debounce(function() {
                    const query = searchInput.value;
                    performSearch(query);
                }, 300);

                searchInput.addEventListener('input', debouncedSearch);

                // Add event listeners for search type radios
                searchTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const query = searchInput.value;
                        if (query.trim()) {
                            performSearch(query);
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>