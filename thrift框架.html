<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thriftåè®® - Shinerio's Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="article-page" id="theme-body">
    <div class="page-wrapper">
        <header class="page-header">
            <div class="container">
                <nav class="page-nav">
                    <div class="nav-links">
                        <a href="index.html" class="nav-link ">Home</a>
                        <a href="articles.html" class="nav-link ">Articles</a>
                        <a href="search.html" class="nav-link ">Search</a>
                    </div>
                    <div class="theme-toggle-container">
                        <button id="theme-toggle" aria-label="Toggle dark mode" class="theme-toggle-btn">
                            <span class="sun-icon">â˜€ï¸</span>
                            <span class="moon-icon">ğŸŒ™</span>
                        </button>
                    </div>
                </nav>
            </div>
        </header>
        <main class="page-main">
            <div class="container">
                <article>
    <header>
        <h1>Thriftåè®®</h1>
        <time datetime="2023-01-25T00:00:00.000Z">2023å¹´1æœˆ25æ—¥</time>
        <div class="tags">
            
            <span class="tag">protocol</span>
            
            <span class="tag">network</span>
            
        </div>
    </header>
    <section class="content">
        {<p><code>Thrift</code>æ˜¯ä¸€ç§è½»é‡åŒ–ã€è¯­è¨€æ— å…³çš„RPCæ¡†æ¶ã€‚ä¸»è¦åŒ…å«ä¸‰å¤§éƒ¨åˆ†ï¼šä»£ç ç”Ÿæˆã€åºåˆ—åŒ–æ¡†æ¶ã€RPCæ¡†æ¶ã€‚</p>
<p><img src="https://github.com/apache/thrift/raw/master/doc/images/thrift-layers.png" alt=""></p>
<!--more-->

<h1>Thriftç½‘ç»œåè®®æ ˆ</h1>
<p><code>Thrfit</code>é‡‡ç”¨çš„æ˜¯<code>C/S</code>æ¨¡å‹ï¼Œç½‘ç»œåè®®æ ˆä»ä¸‹åˆ°ä¸Šåˆ†åˆ«ä¸ºï¼š<code>Transport layer</code>ã€<code>Protocol layer</code>ã€<code>Processor layer</code>ã€<code>Server layer</code>ã€‚</p>
<pre><code>  +-------------------------------------------+
  | Server                                    |
  | (single-threaded, event-driven etc)       |
  +-------------------------------------------+
  | Processor                                 |
  | (compiler generated)                      |
  +-------------------------------------------+
  | Protocol                                  |
  | (JSON, compact etc)                       |
  +-------------------------------------------+
  | Transport                                 |
  | (raw TCP, HTTP etc)                       |
  +-------------------------------------------+
</code></pre>
<h2>Transport</h2>
<p><code>Thrift</code> ä¼ è¾“å±‚ä¸ºç½‘ç»œ<code>write/read</code>æä¾›äº†ä¸€ä¸ªç®€å•çš„æŠ½è±¡ï¼Œå®šä¹‰äº†å…·ä½“çš„ç½‘ç»œä¼ è¾“åè®®ã€‚å…¶æœ¬è´¨æ˜¯ä¸€ä¸ªæä¾›äº†é€šè¿‡å„ç§åè®®è¿›è¡Œé€šä¿¡çš„æ¡†æ¶ï¼Œæ”¯æŒåŒ…æ‹¬<code>HTTP</code>å’Œ<code>TCP</code>ç­‰ã€‚è¿™ä½¿<code>Thrift</code>èƒ½å¤Ÿå°†åº•å±‚ä¼ è¾“ä¸ç³»ç»Ÿçš„å…¶ä½™éƒ¨åˆ†è§£è€¦ï¼ˆä¾‹å¦‚ï¼Œåºåˆ—åŒ–/ååºåˆ—åŒ–ï¼‰ã€‚ä¼ è¾“å±‚æ¥å£æš´éœ²çš„ä¸€äº›æ–¹æ³•åŒ…æ‹¬ï¼š<code>openã€closeã€readã€writeã€flush</code>ç­‰</p>
<p>ä¼ è¾“å±‚åˆ†ä¸º<code>TTransport</code>ï¼ˆå®¢æˆ·ç«¯ï¼‰å’Œ<code>TServerTransport</code>ï¼ˆæœåŠ¡ç«¯ï¼‰ä¸¤ç±»ï¼Œé…åˆè£…é¥°å™¨æ¨¡å¼ï¼Œé€šè¿‡èŠ‚ç‚¹æµå’ŒåŒ…è£…æµçš„æ¦‚å¿µæ¥åŒºåˆ†å„ç§<code>Transport</code>å®ç°ã€‚</p>
<pre><code class="language-mermaid">classDiagram
class Closeable
&lt;&lt;interface&gt;&gt; Closeable
class TTransport {
    +open()
    +close()
    +read()
    +write()
    +flush()
}
&lt;&lt;abstract&gt;&gt; TTransport
TTransport..|&gt;Closeable
class TNonblockingTransport
&lt;&lt;abstract&gt;&gt; TNonblockingTransport
class TNonblockingSocket
TTransport&lt;|--TNonblockingTransport
TNonblockingTransport&lt;|--TNonblockingSocket
class TFileTransport
TTransport&lt;|--TFileTransport
class TFramedTransport
TTransport&lt;|--TFramedTransport
class TIOStreamTransport
TTransport&lt;|--TIOStreamTransport
class TZlibTransport
TIOStreamTransport&lt;|--TZlibTransport
class TSocket
TIOStreamTransport&lt;|--TSocket
class TServerTransport {
    +open()
    +close()
    +listen()
    +accept()
}
&lt;&lt;abstract&gt;&gt; TServerTransport
TServerTransport..|&gt;Closeable
class TNonblockingServerTransport
TServerTransport&lt;|--TNonblockingServerTransport
class TNonblockingServerSocket
TNonblockingServerTransport&lt;|--TNonblockingServerSocket
class TServerSocket
TServerTransport&lt;|--TServerSocket
</code></pre>
<h3>å®¢æˆ·ç«¯ä¼ è¾“å±‚ï¼ˆTTransportï¼‰</h3>
<ul>
<li><code>TIOStreamTransport</code>: æ˜¯æœ€å¸¸ç”¨çš„åŸºäºé˜»å¡å¼<code>I/O</code>æ¨¡å‹çš„ä¼ è¾“å±‚å®ç°ï¼Œé€šè¿‡ä¸€ä¸ªè¾“å…¥æµå’Œä¸€ä¸ªè¾“å‡ºæµå®ç°äº†æ‰€æœ‰çš„ä¼ è¾“æ“ä½œï¼›å®Œç¾çš„å…¼å®¹Javaçš„å„ç§I/Oæµæ“ä½œï¼›æ˜¯<code>TSocket</code>å’Œ<code>TZlibTransport</code>åŸºç±»ã€‚</li>
<li><code>TSocket</code>: é€šè¿‡<code>Socket</code>å®ç°<code>TTransport</code>ï¼Œé˜»å¡å¼ï¼Œä¾§é‡å»ºç«‹è¿æ¥ï¼›</li>
<li><code>TZlibTransport</code>: åŸºäº<code>InflaterInputStream</code>å’Œ<code>DeflaterOutputStream(java.util.zip)</code>å®ç°å¯¹è¾“å…¥è¾“å‡ºæµçš„å‹ç¼©ï¼Œé€šè¿‡è°ƒç”¨ä¸‹ä¸€å±‚çš„<code>TTransport</code>å®ç°è¯»å†™æ“ä½œï¼Œæ˜¯ä¸€ä¸ªè£…é¥°å™¨æ¨¡å¼</li>
<li><code>TNonblockingSocket</code>: é€šè¿‡<code>NIO</code>åŒ…ä¸­çš„<code>SocketChannel</code>å®ç°éé˜»å¡ä¼ è¾“ï¼ŒæœåŠ¡äºå¼‚æ­¥å®¢æˆ·ç«¯å®ç°</li>
<li><code>TFramedTransport</code>: åˆ©ç”¨<code>NIO</code>åŒ…çš„<code>TByteBuffer</code>è¯»å†™ç¼“å­˜ï¼Œä»¥æ ˆå¸§ä¸ºä¼ è¾“å•ä½çš„<code>TTransport</code>è£…é¥°å™¨å®ç°ï¼›å¸§å¤´éƒ¨ç”¨4ä¸ªå¡«å……å­—èŠ‚æ¥å­˜å‚¨æ•°æ®æµé•¿åº¦ï¼Œä¿éšœæ•°æ®çš„å®Œæ•´æ€§ï¼›</li>
<li><code>TFileTransport</code>: ç”¨äºå°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼ŒJAVAä»…æ”¯æŒreadæ“ä½œï¼Œä¸æ”¯æŒwriteï¼›</li>
</ul>
<h3>æœåŠ¡ç«¯ä¼ è¾“å±‚ï¼ˆTServerTransportï¼‰</h3>
<ul>
<li><code>TServerSocket</code>: æœåŠ¡ç«¯é˜»å¡å¼ä¼ è¾“å±‚ï¼ŒåŸºäº<code>ServerSocket</code>å®ç°ï¼›</li>
<li><code>TNonblockingServerSocket</code>ï¼šæœåŠ¡ç«¯éé˜»å¡å¼ä¼ è¾“å±‚ï¼ŒåŸºäº<code>NIO</code>çš„<code>ServerSocketChannel</code>å®ç°ï¼›</li>
</ul>
<h2>Protocol</h2>
<p><code>Protocol</code>å®šä¹‰äº†ä¸€ç§å°†å†…å­˜æ•°æ®ç»“æ„æ˜ å°„ä¸ºæœ‰çº¿æ ¼å¼çš„æœºåˆ¶ã€‚æ¢å¥è¯è¯´ï¼Œ<code>protocol</code>å®šä¹‰äº†æŒ‡å®šæ•°æ®ç±»å‹å¦‚ä½•ä½¿ç”¨åº•å±‚<code>transport</code>æ¥ç¼–è§£ç ã€‚å› æ­¤ï¼Œ<code>protocol</code>å®ç°ç®¡ç†ç¼–ç æ–¹æ¡ˆå¹¶è´Ÿè´£ï¼ˆåï¼‰åºåˆ—åŒ–ã€‚å¸¸ç”¨çš„<code>protocol</code>æœ‰<code>JSONã€XMLã€PLAIN TEXTã€COMPACT BINARY</code>ç­‰ã€‚</p>
<ul>
<li><code>TBinaryProtocol</code>: äºŒè¿›åˆ¶ç¼–ç æ ¼å¼çš„æ•°æ®ä¼ è¾“åè®®ï¼›</li>
<li><code>TCompactProtocol</code>: é«˜æ•ˆç‡å¯†é›†çš„å‹ç¼©äºŒè¿›åˆ¶çš„æ•°æ®ä¼ è¾“åè®®ï¼›</li>
<li><code>TJSONProtocol</code>: ä½¿ç”¨JSONç¼–ç æ ¼å¼ä¼ è¾“åè®®ï¼ŒæŠ“åŒ…æ ¼å¼å¯è§ï¼›</li>
<li><code>TSimpleJSONProtocol</code>: ç®€å•çš„JSONæ ¼å¼æ•°æ®ä¼ è¾“åè®®ï¼›ä»…æ”¯æŒå†™å…¥ï¼Œç”¨äºè„šæœ¬è¯­è¨€è¾“å‡ºï¼Œä¸€èˆ¬ä¸ä½¿ç”¨è¿™ç§</li>
<li><code>TDebugProtocol</code>: ä½¿ç”¨æ˜“æ‡‚å¯è¯»çš„æ–‡æœ¬æ ¼å¼è¿›è¡Œä¼ è¾“ï¼Œä¾¿äºdebugè°ƒè¯•</li>
</ul>
<p><code>Thrift</code>ä¸­å…³äº<code>protocol</code>çš„æ¥å£æœ‰ï¼š</p>
<pre><code class="language-cpp">writeMessageBegin(name, type, seq)
writeMessageEnd()
writeStructBegin(name)
writeStructEnd()
writeFieldBegin(name, type, id)
writeFieldEnd()
writeFieldStop()
writeMapBegin(ktype, vtype, size)
writeMapEnd()
writeListBegin(etype, size)
writeListEnd()
writeSetBegin(etype, size)
writeSetEnd()
writeBool(bool)
writeByte(byte)
writeI16(i16)
writeI32(i32)
writeI64(i64)
writeDouble(double)
writeString(string)

name, type, seq = readMessageBegin()
                  readMessageEnd()
name = readStructBegin()
       readStructEnd()
name, type, id = readFieldBegin()
                 readFieldEnd()
k, v, size = readMapBegin()
             readMapEnd()
etype, size = readListBegin()
              readListEnd()
etype, size = readSetBegin()
              readSetEnd()
bool = readBool()
byte = readByte()
i16 = readI16()
i32 = readI32()
i64 = readI64()
double = readDouble()
string = readString()
</code></pre>
<h2>Processor</h2>
<p><code>Processor</code>å°è£…äº†ä»<code>input</code>è¯»å–æ•°æ®å’Œå†™å…¥æ•°æ®åˆ°<code>output</code>çš„èƒ½åŠ›ã€‚è¾“å…¥å’Œè¾“å‡ºæµé€šè¿‡<code>Protocol</code>å¯¹è±¡è¡¨ç¤ºï¼Œ<code>Thrift</code>é€šè¿‡ä½¿ç”¨<code>IDLæè¿°æ–‡ä»¶</code>æ¥è‡ªåŠ¨ç”Ÿæˆ<code>Processor</code>ã€‚<code>Processor</code>æ¥å£éå¸¸ç®€å•ï¼š</p>
<pre><code class="language-java">interface TProcessor {
    bool process(TProtocol in, TProtocol out) throws TException
}
</code></pre>
<pre><code class="language-mermaid">classDiagram
class TProcessor {
+process(TProtocol in, TProtocol out)
}
&lt;&lt;interface&gt;&gt; TProcessor
class TBaseProcessor
&lt;&lt;abstract&gt;&gt; TBaseProcessor
TBaseProcessor..|&gt;TProcessor
class TMultiplexedProcessor
TMultiplexedProcessor..|&gt;TProcessor
class Processor
Processor..|&gt;TProcessor
TBaseProcessor&lt;|--Processor
</code></pre>
<pre><code class="language-java">//åªæœ‰åœ¨å®šä¹‰Serverç«¯çš„æ—¶å€™ç”¨åˆ°ï¼Œå®¢æˆ·ç«¯ä¸éœ€è¦å…³å¿ƒï¼›ç¤ºä¾‹ä»£ç ï¼šÂ 
//PlayerServiceImplæ˜¯PlayerService.Ifaceçš„å®ç°ï¼›Â 
privateÂ PlayerServiceImplÂ playerServiceÂ =Â newÂ PlayerServiceImpl();Â 
//Serverå®šä¹‰
PlayerService.Processor&lt;PlayerService.Iface&gt; processor =Â newÂ PlayerService.Processor&lt;&gt;(playerService);
TServerTransportÂ transportÂ =Â newÂ TServerSocket(3041);Â 
TServerÂ serverÂ =Â newÂ TSimpleServer(newTServer.Args(transport).processor(processor);
System.out.println(&quot;Starting the simple server...&quot;); 
server.serve();
</code></pre>
<h3>TMultiplexedProcessor</h3>
<p>ä¸Šè¿°ç¤ºä¾‹ä¸­ä¸€ä¸ªServeråªç»‘å®šä¸€ä¸ªServiceï¼Œå®é™…é¡¹ç›®ä¸­å¾€å¾€æœ‰å¤§é‡çš„æ¥å£æœåŠ¡ï¼Œå¦‚æœæŠŠæ‰€æœ‰æ¥å£æ–¹æ³•å†™åœ¨ä¸€ä¸ªServiceæ¥å£æ–‡ä»¶ä¸­ï¼Œä¸è®ºæ˜¯ä»£ç çš„ç»“æ„ä¼˜åŒ–ã€å¯è¯»æ€§è¿˜æ˜¯åç»­ç»´æŠ¤éƒ½å¸¦æ¥å¾ˆå¤šéšæ‚£å’Œä¸ä¾¿ã€‚ å¹¸å¥½ï¼Œ<code>Thrift</code>æä¾›äº†<code>TMultiplexedProcessor</code>å’Œ<code>TMultiplexedProtocol</code>ç±»æ¥å¸®åŠ©å¼€å‘è€…æ‹†åˆ†å’Œç»„è£…ä¸šåŠ¡æ¥å£æœåŠ¡ã€‚</p>
<p>æœåŠ¡ç«¯ä½¿ç”¨<code>TMultiplexedProcessor</code>ç±»æ³¨å†Œå¤šä¸ªæ¥å£çš„æœåŠ¡å®ç°ç±»</p>
<pre><code class="language-java">TMultiplexedProcessorÂ multiplexedProcessorÂ =Â newÂ TMultiplexedProcessor();
multiplexedProcessor.registerProcessor(ServiceEnum.PLAYER.serviceName,Â newPlayerService.Processor&lt;PlayerService.Iface&gt;(newÂ PlayerServiceImpl())); multiplexedProcessor.registerProcessor(ServiceEnum.GUILD.serviceName,Â newGuildService.Processor&lt;GuildService.Iface&gt;(newÂ GuildServiceImpl()));
</code></pre>
<p>å®¢æˆ·ç«¯ä½¿ç”¨<code>TMultiplexedProtocol</code>ç±»æ¥åˆ›å»º<code>Client</code>å®ä¾‹ï¼Œå¸®åŠ©åŒºåˆ†è°ƒç”¨å…·ä½“çš„æœåŠ¡æ¥å£</p>
<pre><code class="language-java">TProtocolÂ protocolÂ =Â newÂ TBinaryProtocol(transport);
PlayerService.ClientÂ playerServiceÂ =Â newÂ PlayerService.Client(newÂ TMultiplexedProtocol(protocol, ServiceEnum.PLAYER.serviceName));
GuildService.ClientÂ playerServiceÂ =Â newGuildService.Client(Â newÂ TMultiplexedProtocol(protocol, ServiceEnum.GUILD.serviceName));
</code></pre>
<h2>Server</h2>
<p><code>server</code>å°†ä¸Šé¢æ‰€æœ‰çš„ç‰¹æ€§æ•´åˆåœ¨ä¸€èµ·å½¢æˆæœ€ç»ˆçš„æœåŠ¡ï¼š</p>
<ul>
<li>åˆ›å»º<code>transport</code>å®ä¾‹ï¼Œå»ºç«‹è¿æ¥é€šé“</li>
<li>ä¸º<code>transport</code>åˆ›å»ºè¾“å…¥è¾“å‡ºåè®®<code>protocol</code></li>
<li>åŸºäºè¾“å…¥è¾“å‡ºåè®®åˆ›å»º<code>processor</code></li>
<li>ç­‰å¾…æ–°å»ºè¿æ¥å¹¶è½¬äº¤ç»™<code>processor</code></li>
</ul>
<pre><code class="language-mermaid">classDiagram
class TServer
class TSimpleServer
TSimpleServer--|&gt;TServer
class TThreadPoolServer
TThreadPoolServer--|&gt;TServer
class AbstractNonblockingServer
&lt;&lt;abstract&gt;&gt; AbstractNonblockingServer
AbstractNonblockingServer--|&gt;TServer
class TNonblockingServer
TNonblockingServer--|&gt;AbstractNonblockingServer
class THsHaServer
THsHaServer--|&gt;AbstractNonblockingServer
class TThreadedSelectorServer
TThreadedSelectorServer--|&gt;AbstractNonblockingServer
</code></pre>
<h3>TSimpleServer</h3>
<ul>
<li>è¯¥æ¨¡å¼ä¸‹åªæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¥å—è¯·æ±‚å’Œå¤„ç†æ•°æ®éƒ½åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­</li>
<li>ç®€å•çš„é˜»å¡<code>I/O</code>æ¨¡å¼ï¼Œä¸€æ¬¡åªèƒ½å¤„ç†ä¸€ä¸ªè¯·æ±‚ï¼Œå¤šä¸ªå®¢æˆ·ç«¯è¯·æ±‚è¢«ä¸²è¡Œå¤„ç†</li>
</ul>
<h3>TThreadPoolServer</h3>
<ul>
<li>è¯¥æ¨¡å¼æ˜¯å¯¹<code>TSimpleServer</code>æ¨¡å¼çš„ä¼˜åŒ–ï¼ŒåŒæ ·æ˜¯åŸºäºé˜»å¡<code>I/O</code>å®ç°ï¼Œæ¯æ¬¡åªèƒ½ç›‘å¬ä¸€ä¸ªè¯·æ±‚è¿æ¥</li>
<li>é‡‡ç”¨çº¿ç¨‹æ± æŠ€æœ¯ï¼Œè¯·æ±‚åˆ°è¾¾åï¼Œäº¤ç»™<code>worker</code>çº¿ç¨‹æ¥å¤„ç†ï¼Œå¤šçº¿ç¨‹å¹¶è¡Œå¤„ç†äº†<code>I/O</code>çš„è¯»å†™ã€‚</li>
<li>å•ä¸ªè¯·æ±‚çš„å¤„ç†ä¸ä¼šå½±å“æœåŠ¡ç«¯æ•´ä½“çš„æ€§èƒ½ï¼Œä½†æ˜¯è¿æ¥æ± çš„è§„æ¨¡å†³å®šäº†è¯¥æ¨¡å¼çš„å·¥ä½œèƒ½åŠ›ï¼›</li>
</ul>
<h3>TNonblockingServer</h3>
<ul>
<li>è¯¥æ¨¡å¼åŒæ ·åªæœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œç›¸è¾ƒäº<code>TSimpleServer</code>æ¨¡å¼çš„ä¸åŒï¼Œè¯¥æ¨¡å¼é‡‡ç”¨<code>I/O</code>å¤šè·¯å¤ç”¨ï¼›</li>
<li>åŸºäº<code>I/O</code>å¤šè·¯å¤ç”¨å®ç°ï¼Œéé˜»å¡<code>I/O</code>ï¼Œä½¿ç”¨<code>selector</code>å¯ä»¥åŒæ—¶ç›‘å¬å¤šä¸ªåˆ°è¾¾çš„è¿æ¥è¯·æ±‚ï¼›</li>
<li>è™½ç„¶åŒæ—¶ç›‘å¬å¤šä¸ªè¯·æ±‚ï¼Œä½†æ˜¯è¯·æ±‚çš„å¤„ç†è¿˜æ˜¯ä¸²è¡Œï¼Œæ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ä¼˜åŠ¿ï¼Œä¸”æŸä¸ªè¯·æ±‚å¤„ç†è¢«é˜»å¡ä¼šç›´æ¥å½±å“åç»­è¯·æ±‚çš„å¤„ç†</li>
<li>è¯¥æ¨¡å¼ä¸‹å¿…é¡»ä½¿ç”¨<code>TFramedTransport</code></li>
</ul>
<h3>THsHaServer</h3>
<ul>
<li>è¯¥æ¨¡å¼å¯ä»¥ç†è§£ä¸ºå¯¹<code>TNonblockingServer</code>çš„ä¼˜åŒ–ï¼ŒåŸºäº<code>I/O</code>å¤šè·¯å¤ç”¨å®ç°ï¼Œéé˜»å¡<code>I/O</code>ï¼Œé‡‡ç”¨<code>Half-sync/Half-async</code>çš„å·¥ä½œæ¨¡å¼</li>
<li><code>Half-aysnc</code>æ˜¯åœ¨å¤„ç†<code>I/O</code>äº‹ä»¶ä¸Š (accept/read/write)ï¼Œ<code>Half-sync</code>ç”¨äº<code>handler</code> å¯¹<code>rpc</code>çš„åŒæ­¥å¤„ç†ä¸Šã€‚</li>
<li><code>THsHaServer</code> åœ¨å®Œæˆæ•°æ®è¯»å–ä¹‹åï¼Œå°†ä¸šåŠ¡å¤„ç†è¿‡ç¨‹äº¤ç”±ä¸€ä¸ªçº¿ç¨‹æ± æ¥å®Œæˆï¼Œä¸»çº¿ç¨‹ç›´æ¥è¿”å›è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯æ“ä½œï¼Œæ•ˆç‡å¤§å¤§æå‡ï¼Œä½†æ˜¯ä¸»çº¿ç¨‹éœ€è¦å®Œæˆæ‰€æœ‰<code>socket</code>çš„ç›‘å¬ä»¥åŠæ•°æ®è¯»å†™ï¼Œå½“è¯·æ±‚ä¹¦è¾ƒå¤§ä¸”å‘é€æ•°æ®é‡è¾ƒå¤šï¼Œç›‘å¬çš„<code>socket</code>è¯·æ±‚ä¸èƒ½è¢«åŠæ—¶å¤„ç†ã€‚</li>
<li>è¯¥æ¨¡å¼å¿…é¡»ä½¿ç”¨<code>TFramedTransport</code></li>
</ul>
<h3>TThreadedSelectorServer</h3>
<p><code>THsHaServer</code>ç¼ºç‚¹æ˜¯ä¸»çº¿ç¨‹ä»ç„¶éœ€è¦å®Œæˆæ‰€æœ‰<code>socket</code>çš„<code>listen</code>å’Œ<code>accept</code>ã€æ•°æ®è¯»å–å’Œæ•°æ®å†™å…¥æ“ä½œ(read/write)ã€‚å½“å¹¶å‘è¯·æ±‚æ•°è¾ƒå¤§æ—¶ï¼Œä¸”å‘é€æ•°æ®é‡è¾ƒå¤šæ—¶ï¼Œè´Ÿè´£ç›‘å¬çš„ä¸»çº¿ç¨‹å°±åªæœ‰ä¸€ä¸ªã€‚ç›‘å¬socketä¸Šæ–°è¿æ¥è¯·æ±‚ä¸èƒ½è¢«åŠæ—¶æ¥å—ã€‚ <code>TThreadedSelectorServer</code>æ˜¯å¯¹<code>THsHaServer</code>çš„ä¸€ç§æ‰©å……ä¸å®Œå–„ï¼Œå®ƒå°†<code>selector</code>ä¸­çš„è¯»å†™<code>I/O</code>äº‹ä»¶ä»ä¸»çº¿ç¨‹ä¸­åˆ†ç¦»å‡ºæ¥ã€‚äº¤ç»™äº†å¤šä¸ªä¸“é—¨è´Ÿè´£è¯»å†™<code>I/O</code>äº‹ä»¶çš„<code>SelectorThread</code>ï¼ŒåŒæ—¶å¼•å…¥<code>worker</code>å·¥ä½œçº¿ç¨‹æ± ï¼Œè´Ÿè´£ä¸šåŠ¡å¤„ç†ã€‚å®ƒä¹Ÿæ˜¯ç§<code>Half-Sync/Half-Async</code>çš„æœåŠ¡æ¨¡å‹ã€‚</p>
<ul>
<li>è¯¥æ¨¡å¼æ˜¯ç›®å‰<code>Thrift</code>æä¾›çš„æœ€é«˜çº§ã€æœ€å¤æ‚ä¹Ÿæ˜¯æœ€é«˜æ•ˆçš„å·¥ä½œæ¨¡å¼</li>
<li>ä¸€ä¸ª<code>AcceptThread</code>çº¿ç¨‹åŸºäº<code>I/O</code>å¤šè·¯å¤ç”¨ï¼Œä¸“é—¨åŒæ—¶ç›‘å¬å¹¶å¤„ç†å¤šä¸ªåˆ°è¾¾çš„æ–°è¿æ¥ï¼›å¹¶æŠŠå»ºç«‹çš„æ–°è¿æ¥è½¬äº¤ç»™<code>Selector</code>çº¿ç¨‹æ± æ¥è¿›ä¸€æ­¥å¤„ç†</li>
<li>ä¸€ä¸ª<code>Selector</code>çº¿ç¨‹æ± å¯¹è±¡ï¼ŒåŒæ—¶ç»´æŠ¤å¤šä¸ª<code>Selector</code>æ¥ä¸ºæ–°è¿æ¥æœåŠ¡ï¼Œå…¶ä»–å‡ ç§éé˜»å¡<code>I/O</code>å®ç°çš„æ¨¡å¼éƒ½åªæœ‰ä¸€ä¸ªSelectorå·¥ä½œ</li>
<li>ä¸€ä¸ªè´Ÿè½½å‡è¡¡å™¨<code>SelectorThreadLoadBalancer</code>å¯¹è±¡ï¼Œè´Ÿè´£å†³ç­–å¹¶è½¬å‘æ–°è¿æ¥åˆ°å…·ä½“çš„æŸä¸ª<code>Selector</code></li>
<li>ä¸€ä¸ª<code>ExecutorService</code>å·¥ä½œçº¿ç¨‹æ± å¯¹è±¡ï¼Œå…¶ä¸­çš„<code>woker thead</code>å®Œæˆæ¯ä¸ªè¯·æ±‚å¯¹åº”çš„é€»è¾‘å¤„ç†</li>
</ul>
<h1>IDL(Interface Description Language)</h1>
<p><code>Thrift</code>é‡‡ç”¨<code>IDL</code>ï¼ˆInterface Definition Languageï¼‰æ¥å®šä¹‰é€šç”¨çš„æœåŠ¡æ¥å£ï¼Œç„¶åé€šè¿‡<code>Thrift</code>æä¾›çš„ç¼–è¯‘å™¨ï¼Œå¯ä»¥å°†æœåŠ¡æ¥å£ç¼–è¯‘æˆä¸åŒè¯­è¨€ç¼–å†™çš„ä»£ç ï¼Œé€šè¿‡è¿™ä¸ªæ–¹å¼æ¥å®ç°è·¨è¯­è¨€çš„åŠŸèƒ½ã€‚</p>
<h2>æ³¨é‡Š</h2>
<p>Thriftæ”¯æŒ<code>shell</code>é£æ ¼ã€<code>C/C++/Java</code>é£æ ¼çš„æ³¨é‡Šã€‚ç¤ºä¾‹ï¼š</p>
<pre><code class="language-cpp"># shellé£æ ¼æ³¨é‡Š.
// C++/Java å•è¡Œæ³¨é‡Š

/*
 * å¤šè¡Œæ³¨é‡Š
 * ç±»ä¼¼C/C++/Java
 */
</code></pre>
<h2>Description</h2>
<p>Thriftæ–‡ä»¶çš„æè¿°è·Ÿä¸€èˆ¬è¯­è¨€ä¸€æ ·åœ¨æ–‡ä»¶é¡¶éƒ¨é€šè¿‡æ³¨é‡Šæ¥è¡¨è¿°æœåŠ¡çš„å†…å®¹ç­‰ä¿¡æ¯ã€‚</p>
<h2>Document</h2>
<p><code>Thrift</code>æ–‡æ¡£éƒ¨åˆ†åŒ…æ‹¬<code>0</code>ä¸ªæˆ–è€…å¤šä¸ª<code>Header</code>ï¼Œç„¶ååŒ…æ‹¬<code>0</code>ä¸ªæˆ–å¤šä¸ª<code>Definition</code>ã€‚</p>
<h3>HEADER</h3>
<p><code>HEADER</code>å¯ä»¥æ˜¯<code>Thrift include</code>ã€<code>C++ include</code>æˆ–<code>namespace</code>å£°æ˜ã€‚</p>
<h4>Thrift header</h4>
<p><code>Thrift include</code>å¯ä»¥å°†æ‰€æœ‰å£°æ˜åŒ…å«çš„<code>Thriftæ–‡æ¡£</code>éƒ½åŒ…å«åˆ°å½“å‰<code>Thrift</code>ä¸­ã€‚åœ¨çœŸæ­£çš„ä¸šåŠ¡å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¸å¯èƒ½æŠŠæ‰€æœ‰çš„æœåŠ¡éƒ½å®šä¹‰åˆ°ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼Œé€šå¸¸ä¼šæ ¹æ®ä¸šåŠ¡æ¨¡å—è¿›è¡Œæ‹†åˆ†ï¼Œç„¶åå°†è¿™äº›æœåŠ¡<code>include</code>åˆ°ä¸€ä¸ªå…¥å£æ–‡ä»¶ä¸­ï¼Œç„¶ååœ¨æœ€ç»ˆæœåŠ¡å‘å¸ƒä¸Šçº¿çš„æ—¶å€™ï¼Œ<code>thrift</code>ç¼–è¯‘å™¨åªéœ€è¦ç¼–è¯‘å…¥å£æ–‡ä»¶ï¼Œå°±èƒ½å°†æ‰€æœ‰å¼•å…¥çš„æ–‡ä»¶éƒ½ç”Ÿæˆå¯¹åº”çš„ä»£ç ã€‚</p>
<pre><code class="language-idl">inlucde &quot;module_a.thrift&quot; 
include &quot;module_b.thrift&quot;
</code></pre>
<h4>C++ inlcude</h4>
<p>ç”¨æ¥ä¸ºå½“å‰çš„<code>thrift</code>æ–‡ä»¶ç”Ÿæˆçš„ä»£ç ä¸­æ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„<code>C++</code> å¼•å…¥å£°æ˜</p>
<pre><code class="language-idl">cpp_include &quot;string&quot;
</code></pre>
<h4>Namespace</h4>
<p>è¯­æ³•ï¼š<code>namespace NamespaceScope æ ‡è¯†ç¬¦</code><br>Â <code>Namespace</code>Â ç”¨æ¥å£°æ˜ä½¿ç”¨å“ªç§è¯­è¨€æ¥å¤„ç†å½“å‰Â <code>thrift</code>æ–‡ä»¶ä¸­å®šä¹‰çš„å„ç§ç±»å‹ï¼Œ<code>NamespaceScope</code>å°±æ˜¯å„ç§è¯­è¨€çš„æ ‡è¯†ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šä¸ºé€šé…ç¬¦<code>*</code>æ ‡è¯†ï¼Œæ ‡è¯†<code>thrift</code>æ–‡ä»¶ä¸­çš„å®šä¹‰é€‚ç”¨äºæ‰€æœ‰çš„è¯­è¨€ã€‚é™¤æ­¤ä¹‹å¤– Namespace è¿˜æœ‰ä¸€ä¸ªä½œç”¨å°±æ˜¯é¿å…ä¸åŒ<code>Identifier</code>å®šä¹‰çš„å‘½åå†²çªã€‚å¦‚ä¸‹ç¤ºä¾‹ä¸­<code>Namespace</code>å£°æ˜è¯­å¥ï¼Œæ ‡è¯†å½“å‰çš„<code>thrift</code>æ–‡ä»¶é€‚ç”¨äº<code>java</code>ï¼Œ<code>NamespaceScope</code>åé¢ç´§è·Ÿç€çš„<code>Identifier</code>åœ¨ä¸åŒè¯­è¨€ä¸­ä¼šæœ‰ä¸ä¸€æ ·çš„è¡¨ç°ã€‚
Â </p>
<pre><code class="language-idl">namespace java cc.shinerio.test
</code></pre>
<h3>Definition</h3>
<p><code>thrift</code>æ”¯æŒçš„æ•°æ®ç±»å‹åŒ…æ‹¬åŸºæœ¬ç±»å‹ã€ç»“æ„ä½“ç±»å‹ã€å®¹å™¨ç±»å‹ã€å¼‚å¸¸ç±»å‹å’ŒæœåŠ¡ç±»å‹ã€‚</p>
<h4>åŸºæœ¬ç±»å‹(Special Types)</h4>
<ul>
<li>bool: å¸ƒå°”å€¼</li>
<li>byte: 8ä½æœ‰ç¬¦å·æ•´æ•°</li>
<li>i16: 16ä½æœ‰ç¬¦å·æ•´æ•°</li>
<li>i32: 32ä½æœ‰ç¬¦å·æ•´æ•°</li>
<li>i64: 64ä½æœ‰ç¬¦å·æ•´æ•°</li>
<li>double: 64ä½æµ®ç‚¹æ•°</li>
<li>string: UTF-8ç¼–ç çš„å­—ç¬¦ä¸²</li>
<li>binary: äºŒè¿›åˆ¶ä¸²</li>
</ul>
<pre><code class="language-idl"># int ç±»å‹å¸¸é‡
i8 count =Â 100Â 
# doubule ç±»å‹Â 
doubleÂ money =Â &#39;13.14&#39;Â  
# ä½¿ç”¨ç§‘å­¦è®¡æ•°æ³•è¡¨ç¤º0.000012
doubleÂ rate =Â 1.2e-5Â  
# è¡¨ç¤º 350000000
doubleÂ salary =Â 3.5e8Â  
string testStr = &#39;hello thrift&#39;
</code></pre>
<h4>Const</h4>
<p>Constç”¨æ¥å£°æ˜ä¸€ä¸ªå¸¸é‡ï¼Œè¯­æ³•ä¸ºï¼š</p>
<pre><code class="language-idl">const FieldType Identifier = ConstValue [ListSeparator]
</code></pre>
<p>ListSeparator<code>è¿™ä¸ªåˆ†éš”ç¬¦å°±å¥½æ¯”</code>Java<code>ä¸­ä¸€å¥è¯ç»“æŸåçš„</code>;<code>ï¼Œåœ¨</code>IDL<code>ä¸­åˆ†éš”ç¬¦å¯ä»¥æ˜¯</code>,<code>æˆ–è€…</code>;`ã€‚å¤§éƒ¨åˆ†æƒ…å†µä¸‹å¯ä»¥å¿½ç•¥ä¸å†™ã€‚</p>
<pre><code class="language-idl">constÂ i8 count =Â 100Â  
const string strConst = &#39;hello thrift&#39;
const list&lt;string&gt; names = [ &#39;tom&#39;, &#39;jack&#39;, &#39;peter&#39; ]
</code></pre>
<h4>å®¹å™¨ç±»å‹(Containers)</h4>
<ul>
<li>list: æœ‰åºå…ƒç´ åˆ—è¡¨</li>
<li>set: æ— åºæ— é‡å¤å…ƒç´ é›†åˆ</li>
<li>map: æœ‰åºçš„key/valueé›†åˆ</li>
</ul>
<pre><code class="language-idl">struct Grade {  
1: i32 id,  
2: string name,  
3: list%3Ci32%3E scores
}
</code></pre>
<h4>Typedef</h4>
<p><code>Thrift</code>æ”¯æŒ<code>C/C++</code>é£æ ¼çš„è‡ªå®šä¹‰ç±»å‹ï¼Œè¯­æ³•<code>typedef åŸç±»å‹ è‡ªå®šä¹‰ç±»å‹</code></p>
<pre><code class="language-idl">typedef i32 integer32 
</code></pre>
<h4>Enum</h4>
<p><code>Thrift</code>æšä¸¾ç±»å‹çš„å€¼åªæ”¯æŒ<code>int32</code>ï¼Œç¬¬ä¸€ä¸ªå…ƒç´ å¦‚æœæ²¡æœ‰ç»™å€¼é‚£ä¹ˆé»˜è®¤æ˜¯<code>0</code>ï¼Œä¹‹åçš„å…ƒç´ å¦‚æœæ²¡æœ‰ç»™å€¼ï¼Œåˆ™æ˜¯åœ¨å‰ä¸€ä¸ªå…ƒç´ åŸºç¡€ä¸ŠåŠ <code>1</code>ï¼Œè¯­æ³•:</p>
<pre><code class="language-idl">enum identifier {  
    key1 = value1,
    key2 = value2,
}
</code></pre>
<p>å¦‚ï¼š</p>
<pre><code class="language-rust">enum Season
{
  SPRINT = 1,
  SUMMER, //å€¼æ˜¯2
  AUTUMN,  //å€¼æ˜¯3
  WINTER = 5
}
</code></pre>
<h4>Struct</h4>
<p><code>thrift</code>å®šä¹‰ä¸­ä¸€ä¸ª<code>struct</code>ç­‰ä»·äº<code>OOP</code>ç¼–ç¨‹ä¸­çš„<code>class</code>ï¼Œä¸å…·å¤‡ç»§æ‰¿èƒ½åŠ›ï¼Œä½†æ˜¯å¯ä»¥åµŒå¥—ã€‚<code>thrift</code>ç»“æ„ä½“ä¸­çš„å˜é‡è¿˜å¯ä»¥å­˜åœ¨é»˜è®¤å€¼ï¼Œç›´æ¥å†™åœ¨<code>IDL</code>æ–‡ä»¶ä¸­ã€‚<code>struct</code>çš„æ¯ä¸ªå…ƒç´ åŒ…æ‹¬ä¸€ä¸ªå”¯ä¸€çš„æ•°å­—æ ‡è¯†ã€ä¸€ä¸ªæ•°æ®ç±»å‹ã€ä¸€ä¸ªåç§°å’Œä¸€ä¸ªå¯é€‰çš„é»˜è®¤å€¼ã€‚è¯­æ³•å¦‚ä¸‹ï¼š</p>
<pre><code class="language-idl">struct identifier {  
Field ID: Field Req? type identifier (= value)?  
}
</code></pre>
<p><code>Filed Req</code>æ˜¯ä¸€ä¸ªå¯é€‰å€¼ï¼ŒåŒ…æ‹¬requiredå’Œoptionalï¼Œå¦‚æœä¸¤è€…éƒ½æ²¡å£°æ˜ï¼Œåˆ™æ˜¯requirednessï¼Œä¸‰è€…ä½œç”¨å¦‚ä¸‹ï¼š</p>
<ol>
<li><code>required</code>ä»£è¡¨å­—æ®µåœ¨è¾“å…¥å’Œè¾“å‡ºçš„æ—¶å€™å¿…é€‰ï¼Œ<code>required</code>å­—æ®µä¸€èˆ¬ä¸èƒ½éšç€ç‰ˆæœ¬åˆ é™¤ï¼Œå¦åˆ™ä¼šå¸¦æ¥ä¸å…¼å®¹é—®é¢˜</li>
<li><code>optional</code>ä»£è¡¨å­—æ®µæ˜¯å¯é€‰çš„ï¼Œå½“å­—æ®µæœ‰å€¼æ—¶ä¼šè¢«åºåˆ—åŒ–å’Œåºåˆ—åŒ–ï¼Œå¦åˆ™æ˜¯ç©ºå€¼ã€‚</li>
<li><code>requiredness</code>æ˜¯ä¸€ç§ä¸­é—´çŠ¶æ€ï¼Œä¸€èˆ¬ä»£è¡¨è¿™ä¸ªæ•°æ®è¾“å‡ºæ˜¯å¿…é€‰çš„ï¼Œè¾“å…¥æ˜¯å¯é€‰çš„ï¼Œè¿™æ˜¯ä¸€ç§éå¸¸å¥½çš„å…¼å®¹æ–¹å¼ã€‚</li>
</ol>
<p>ç¤ºä¾‹ï¼š</p>
<pre><code class="language-idl">struct UserProfile {  
1: i32 uid = 1,  
2: string name = &quot;User1&quot;,  
3: required string password,
4: optional string metadata
}
</code></pre>
<h4>Union</h4>
<p>ç±»ä¼¼äº<code>C++</code>çš„<code>union</code>ï¼Œæˆå‘˜é»˜è®¤å…¨éƒ¨æ˜¯<code>optional</code>ç±»å‹ï¼Œåªä¼šä¼ è¾“å¤šä¸ªå­—æ®µä¸­çš„ä¸€ä¸ªã€‚</p>
<pre><code class="language-idl">union UserInfo {
1: string phone, 
2: string email
}
</code></pre>
<h4>å¼‚å¸¸ç±»å‹(Exceptions)</h4>
<p>å¼‚å¸¸åœ¨åŠŸèƒ½ä¸Šç­‰åŒäº<code>Structs</code>ï¼Œä¸åŒä¹‹å¤„åœ¨äºå…¶ä¼šåœ¨æ¯ç§ç›®æ ‡ç¼–ç¨‹è¯­è¨€ä¸­é€‰æ‹©åˆé€‚çš„å¼‚å¸¸åŸºç±»ç»§æ‰¿ï¼Œä»¥ä¾¿ä¸ä»»ä½•ç»™å®šè¯­è¨€ä¸­çš„æœ¬åœ°å¼‚å¸¸å¤„ç†æ— ç¼é›†æˆã€‚</p>
<pre><code class="language-idl">exception MyExcepption {
  1: i32 errorCode,
  2: string msg
}
</code></pre>
<h4>æœåŠ¡ç±»å‹</h4>
<p>æœåŠ¡ç”±ä¸€ç»„å‘½åå‡½æ•°ç»„æˆï¼Œæ¯ä¸ªå‡½æ•°åŒ…å«ä¸€ä¸ªå‚æ•°åˆ—è¡¨å’Œä¸€ä¸ªè¿”å›å€¼ç±»å‹ã€‚ æœåŠ¡çš„å®šä¹‰åœ¨è¯­ä¹‰ä¸Šç­‰åŒäºåœ¨<code>OOP</code>ä¸­å®šä¹‰æ¥å£ï¼ˆæˆ–<code>abstract</code>ç±»ï¼‰ã€‚<code>Thrift</code>ç¼–è¯‘å™¨ç”Ÿæˆå®ç°è¯¥æ¥å£æ‰€æœ‰å‡½æ•°çš„å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨å‡½æ•°å—ã€‚</p>
<p>è¯·æ³¨æ„ï¼Œé™¤äº†æ‰€æœ‰å…¶ä»–å·²å®šä¹‰çš„<code>Thrift</code> ç±»å‹ä¹‹å¤–ï¼Œ<code>void</code>ä¹Ÿæ˜¯å‡½æ•°è¿”å›çš„æœ‰æ•ˆç±»å‹ã€‚ æ­¤å¤–ï¼Œå¯ä»¥å°†<code>oneway</code> ä¿®é¥°ç¬¦å…³é”®å­—æ·»åŠ åˆ°<code>void</code> å‡½æ•°ï¼Œæ­¤æ—¶ç”Ÿæˆçš„ä»£ç å°†ä¸ç­‰å¾…å“åº”ã€‚æ˜¾ç„¶è¿™ç§æ–¹å¼å¯ä»¥æå‡å®¢æˆ·ç«¯çš„æ€§èƒ½ï¼Œé€‚ç”¨äºå®¢æˆ·ç«¯å¹¶ä¸å…³é”®æœåŠ¡ç«¯æ‰§è¡Œç»“æœçš„æƒ…å†µã€‚ä½†æ˜¯è¯·æ³¨æ„ï¼Œ<code>void</code> è¿”å›å€¼çš„æ„ä¹‰åœ¨äºæœåŠ¡ç«¯å°†å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªå“åº”ï¼Œä»¥ä¿è¯æ“ä½œå·²åœ¨æœåŠ¡å™¨ç«¯å®Œæˆã€‚ ä½¿ç”¨<code>oneway</code>è°ƒç”¨ï¼Œå®¢æˆ·ç«¯åªèƒ½ä¿è¯è¯·æ±‚åœ¨ä¼ è¾“å±‚ä¼ è¾“æˆåŠŸã€‚ æœåŠ¡å™¨å¯èƒ½ä¼šå¹¶è¡Œæˆ–ä¹±åºæ‰§è¡ŒåŒä¸€å®¢æˆ·ç«¯çš„<code>oneway</code>æ–¹æ³•è°ƒç”¨ã€‚</p>
<pre><code class="language-idl">service MyService {
  void test1();
  oneway void test2();
}
</code></pre>
}
    </section>
</article>
            </div>
        </main>
        <footer class="page-footer">
            <div class="container">
                <p>&copy; 2026 Shinerio's Blog. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Theme switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.getElementById('theme-body');

            // Check for saved theme preference or respect OS preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            // Set initial theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
                body.setAttribute('data-theme', 'dark');
            } else {
                body.removeAttribute('data-theme'); // light theme
            }

            // Toggle theme function
            function toggleTheme() {
                if (body.getAttribute('data-theme') === 'dark') {
                    body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Add event listener to theme toggle button
            themeToggle.addEventListener('click', toggleTheme);

            // Listen for OS theme changes
            prefersDarkScheme.addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        body.setAttribute('data-theme', 'dark');
                    } else {
                        body.removeAttribute('data-theme');
                    }
                }
            });

            // Search functionality
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchResults = document.getElementById('search-results');
            const searchSuggestions = document.getElementById('search-suggestions');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');

            if (searchInput && searchButton) {
                let searchData = null;

                // Load search data
                async function loadSearchData() {
                    try {
                        const response = await fetch('./assets/js/search-data.json');
                        if (response.ok) {
                            searchData = await response.json();
                        } else {
                            console.error('Failed to load search data:', response.status);
                        }
                    } catch (error) {
                        console.error('Error loading search data:', error);
                    }
                }

                // Initialize search data
                loadSearchData();

                // Debounce function to limit search calls
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // Get selected search type
                function getSelectedSearchType() {
                    const selectedRadio = document.querySelector('input[name="search-type"]:checked');
                    return selectedRadio ? selectedRadio.value : 'all';
                }

                // Perform search
                function performSearch(query) {
                    if (!searchData || !query.trim()) {
                        searchResults.innerHTML = '';
                        searchSuggestions.innerHTML = '';
                        return;
                    }

                    const queryTerms = query.toLowerCase().split(/\s+/).filter(term => term.length > 0);
                    const searchType = getSelectedSearchType();

                    if (queryTerms.length === 0) {
                        searchResults.innerHTML = '';
                        return;
                    }

                    const results = [];

                    // Search through articles
                    searchData.articles.forEach(article => {
                        let score = 0;
                        let snippet = '';

                        // Get content based on search type
                        const lowerTitle = article.title.toLowerCase();
                        const lowerContent = article.content.toLowerCase();
                        const lowerTags = article.tags.join(' ').toLowerCase();

                        queryTerms.forEach(term => {
                            switch(searchType) {
                                case 'title':
                                    // Only title matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    break;
                                case 'content':
                                    // Only content matches count (fixed to exclude title matches)
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    break;
                                case 'all':
                                default:
                                    // Both title and content matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    // Tag matches get medium-high score
                                    if (lowerTags.includes(term)) {
                                        score += 5;
                                    }
                                    break;
                            }
                        });

                        if (score > 0) {
                            // Generate snippet based on search type
                            let content = '';

                            if (searchType === 'title') {
                                // For title-only search, show title content
                                content = article.title.substring(0, 200);
                            } else if (searchType === 'content') {
                                // For content-only search, show content excerpt
                                content = article.content.substring(0, 200);
                            } else {
                                // For all search, show content with title as context
                                content = article.content.substring(0, 200);
                            }

                            // Find first occurrence of query term in content for snippet
                            queryTerms.forEach(term => {
                                let searchIn = content.toLowerCase();
                                if (searchType === 'title') {
                                    searchIn = lowerTitle;
                                } else if (searchType === 'content') {
                                    searchIn = lowerContent;
                                }

                                const index = searchIn.indexOf(term);
                                if (index !== -1) {
                                    // Expand snippet around the match
                                    let start, end;
                                    if (searchType === 'title') {
                                        start = Math.max(0, index - 15);
                                        end = Math.min(content.length, index + term.length + 35);
                                    } else {
                                        start = Math.max(0, index - 30);
                                        end = Math.min(content.length, index + term.length + 70);
                                    }

                                    content = (start > 0 ? '...' : '') +
                                              content.substring(start, end) +
                                              (end < (searchType === 'title' ? article.title.length : article.content.length) ? '...' : '');

                                    // Highlight the term in the snippet
                                    const searchContent = searchType === 'title' ? article.title : article.content;
                                    const adjustedIndex = searchType === 'title' ?
                                        Math.min(index, article.title.length - 1) :
                                        Math.min(index, article.content.length - 1);

                                    content = content.replace(
                                        new RegExp(`(${escapeRegExp(term)})`, 'gi'),
                                        '<mark>$1</mark>'
                                    );
                                }
                            });

                            results.push({
                                article: article,
                                score: score,
                                snippet: content
                            });
                        }
                    });

                    // Sort results by score
                    results.sort((a, b) => b.score - a.score);

                    // Display results
                    displaySearchResults(results);
                }

                // Display search results
                function displaySearchResults(results) {
                    if (results.length === 0) {
                        searchResults.innerHTML = '<p class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>';
                        return;
                    }

                    const resultsHTML = results.map(result => `
                        <div class="search-result-item">
                            <h3 class="search-result-title">
                                <a href="./${result.article.slug}.html">${highlightQueryTerms(result.article.title, document.querySelector('#search-input').value)}</a>
                            </h3>
                            <div class="search-result-meta">
                                ${result.article.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                            </div>
                            <p class="search-result-excerpt">${result.snippet}</p>
                        </div>
                    `).join('');

                    searchResults.innerHTML = resultsHTML;
                }

                // Highlight query terms in text
                function highlightQueryTerms(text, query) {
                    if (!query.trim()) return text;

                    const queryTerms = query.split(/\s+/).filter(term => term.length > 0);
                    let highlightedText = text;

                    queryTerms.forEach(term => {
                        const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');
                    });

                    return highlightedText;
                }

                // Escape special regex characters
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Event listener for search button
                searchButton.addEventListener('click', function() {
                    const query = searchInput.value;
                    performSearch(query);
                });

                // Event listener for Enter key
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        const query = searchInput.value;
                        performSearch(query);
                    }
                });

                // Add debounced input handler for live search (optional)
                const debouncedSearch = debounce(function() {
                    const query = searchInput.value;
                    performSearch(query);
                }, 300);

                searchInput.addEventListener('input', debouncedSearch);

                // Add event listeners for search type radios
                searchTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const query = searchInput.value;
                        if (query.trim()) {
                            performSearch(query);
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>