<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è™šæ‹Ÿçº¿ç¨‹ - Shinerio's Blog</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Fira+Code:wght@300;400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="./assets/css/style.css">
</head>
<body class="article-page" id="theme-body">
    <div class="page-wrapper">
        <header class="page-header">
            <div class="container">
                <nav class="page-nav">
                    <div class="nav-links">
                        <a href="index.html" class="nav-link ">Home</a>
                        <a href="articles.html" class="nav-link ">Articles</a>
                        <a href="search.html" class="nav-link ">Search</a>
                    </div>
                    <div class="theme-toggle-container">
                        <button id="theme-toggle" aria-label="Toggle dark mode" class="theme-toggle-btn">
                            <span class="sun-icon">â˜€ï¸</span>
                            <span class="moon-icon">ğŸŒ™</span>
                        </button>
                    </div>
                </nav>
            </div>
        </header>
        <main class="page-main">
            <div class="container">
                <article>
    <header>
        <h1>è™šæ‹Ÿçº¿ç¨‹</h1>
        <time datetime="2026-01-03T13:04:29.159Z">2026å¹´1æœˆ3æ—¥</time>
        <div class="tags">
            
        </div>
    </header>
    <section class="content">
        {<h1>1. æ¦‚å¿µ</h1>
<h2>1.1. å¹³å°çº¿ç¨‹</h2>
<p>æˆ‘ä»¬å¸¸ç”¨çš„Javaçº¿ç¨‹ä¸ç³»ç»Ÿå†…æ ¸çº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œç³»ç»Ÿå†…æ ¸çš„çº¿ç¨‹è°ƒåº¦ç¨‹åºè´Ÿè´£è°ƒåº¦ Javaçº¿ç¨‹ã€‚ä¸ºäº†å¢åŠ åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œæˆ‘ä»¬ä¼šå¢åŠ è¶Šæ¥è¶Šå¤šçš„Javaçº¿ç¨‹ï¼Œè€Œç”±äºå¤šç§å› ç´ ï¼Œå¹³å°çº¿ç¨‹çš„æ•°é‡å—åˆ°äº†å¾ˆå¤§çš„çº¦æŸã€‚</p>
<ul>
<li>èµ„æºæœ‰é™å¯¼è‡´ç³»ç»Ÿçº¿ç¨‹æ€»é‡æœ‰é™ï¼Œè¿›è€Œå¯¼è‡´ä¸ç³»ç»Ÿçº¿ç¨‹ä¸€ä¸€å¯¹åº”çš„å¹³å°çº¿ç¨‹æœ‰é™ã€‚</li>
<li>å¹³å°çº¿ç¨‹çš„è°ƒåº¦ä¾èµ–äºç³»ç»Ÿçš„çº¿ç¨‹è°ƒåº¦ç¨‹åºï¼Œå½“å¹³å°çº¿ç¨‹åˆ›å»ºè¿‡å¤šï¼Œä¼šæ¶ˆè€—å¤§é‡èµ„æºç”¨äºå¤„ç†çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li>
<li>æ¯ä¸ªå¹³å°çº¿ç¨‹éƒ½ä¼šå¼€è¾Ÿä¸€å—ç§æœ‰çš„æ ˆç©ºé—´ï¼Œå¤§é‡å¹³å°çº¿ç¨‹ä¼šå æ®å¤§é‡å†…å­˜ï¼Œæ¯ä¸ªå¹³å°çº¿ç¨‹éœ€è¦å ç”¨çº¦1MBå·¦å³çš„å†…å­˜ã€‚<br>è¿™äº›é™åˆ¶å¯¼è‡´å¼€å‘è€…ä¸èƒ½æå¤§é‡åœ°åˆ›å»ºå¹³å°çº¿ç¨‹ï¼Œä¸ºäº†æ»¡è¶³æ€§èƒ½éœ€è¦ï¼Œéœ€è¦å¼•å…¥æ± åŒ–æŠ€æœ¯ã€æ·»åŠ ä»»åŠ¡é˜Ÿåˆ—æ„å»ºæ¶ˆè´¹è€…-ç”Ÿäº§è€…æ¨¡å¼ç­‰æ–¹æ¡ˆå»è®©å¹³å°çº¿ç¨‹é€‚é…å¤šå˜çš„ç°å®åœºæ™¯ã€‚<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian202506132252117.png" alt="image.png"></li>
</ul>
<h2>1.2. è™šæ‹Ÿçº¿ç¨‹</h2>
<p>è™šæ‹Ÿçº¿ç¨‹ï¼ˆVirtual Threadï¼‰æ˜¯JDKè€Œä¸æ˜¯OSå®ç°çš„è½»é‡çº§çº¿ç¨‹(Lightweight Processï¼ŒLWPï¼‰ï¼Œç”±JVMè°ƒåº¦ã€‚è®¸å¤šè™šæ‹Ÿçº¿ç¨‹å…±äº«åŒä¸€ä¸ªæ“ä½œç³»ç»Ÿçº¿ç¨‹ï¼Œè™šæ‹Ÿçº¿ç¨‹çš„æ•°é‡å¯ä»¥è¿œå¤§äºæ“ä½œç³»ç»Ÿçº¿ç¨‹çš„æ•°é‡ã€‚</p>
<ul>
<li>å¯ä»¥å¤§é‡åˆ›å»ºï¼Œä¾‹å¦‚åä¸‡çº§åˆ«ã€ç™¾ä¸‡çº§åˆ«ï¼Œè€Œä¸ä¼šå æ®å¤§é‡å†…å­˜</li>
<li>ç”±<code>JVM</code>è¿›è¡Œè°ƒåº¦å’ŒçŠ¶æ€åˆ‡æ¢ï¼Œå¹¶ä¸”ä¸ç³»ç»Ÿçº¿ç¨‹&quot;æ¾ç»‘&quot;</li>
<li>ç”¨æ³•ä¸åŸæ¥å¹³å°çº¿ç¨‹å·®ä¸å¤šï¼Œæˆ–è€…è¯´å°½é‡å…¼å®¹å¹³å°çº¿ç¨‹ç°å­˜çš„<code>API</code><br>JVM è°ƒåº¦ç¨‹åºé€šè¿‡å¹³å°çº¿ç¨‹ï¼ˆè½½ä½“çº¿ç¨‹ï¼‰æ¥ç®¡ç†è™šæ‹Ÿçº¿ç¨‹ï¼Œä¸€ä¸ªå¹³å°çº¿ç¨‹å¯ä»¥åœ¨ä¸åŒçš„æ—¶é—´æ‰§è¡Œä¸åŒçš„è™šæ‹Ÿçº¿ç¨‹ï¼ˆå¤šä¸ªè™šæ‹Ÿçº¿ç¨‹æŒ‚è½½åœ¨ä¸€ä¸ªå¹³å°çº¿ç¨‹ä¸Šï¼‰ï¼Œå½“è™šæ‹Ÿçº¿ç¨‹è¢«é˜»å¡æˆ–ç­‰å¾…æ—¶ï¼Œå¹³å°çº¿ç¨‹å¯ä»¥åˆ‡æ¢åˆ°æ‰§è¡Œå¦ä¸€ä¸ªè™šæ‹Ÿçº¿ç¨‹ã€‚<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian%E5%B9%B3%E5%8F%B0%E7%BA%BF%E7%A8%8B.png" alt="image.png"><br>ç›¸æ¯”è¾ƒäºå¹³å°çº¿ç¨‹æ¥è¯´ï¼Œè™šæ‹Ÿçº¿ç¨‹æ˜¯å»‰ä»·ä¸”è½»é‡çº§çš„ï¼Œä½¿ç”¨å®Œåç«‹å³è¢«é”€æ¯ï¼Œå› æ­¤å®ƒä»¬ä¸éœ€è¦è¢«é‡ç”¨æˆ–æ± åŒ–ï¼Œæ¯ä¸ªä»»åŠ¡å¯ä»¥æœ‰è‡ªå·±ä¸“å±çš„è™šæ‹Ÿçº¿ç¨‹æ¥è¿è¡Œã€‚è™šæ‹Ÿçº¿ç¨‹æš‚åœå’Œæ¢å¤æ¥å®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ï¼Œé¿å…äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„é¢å¤–è€—è´¹ï¼Œå…¼é¡¾äº†å¤šçº¿ç¨‹çš„ä¼˜ç‚¹ï¼Œç®€åŒ–äº†é«˜å¹¶å‘ç¨‹åºçš„å¤æ‚ï¼Œå¯ä»¥æœ‰æ•ˆå‡å°‘ç¼–å†™ã€ç»´æŠ¤å’Œè§‚å¯Ÿé«˜ååé‡å¹¶å‘åº”ç”¨ç¨‹åºçš„å·¥ä½œé‡ã€‚</li>
</ul>
<h1>2. è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦</h1>
<p>åŸºäºæ“ä½œç³»ç»Ÿçº¿ç¨‹å®ç°çš„å¹³å°çº¿ç¨‹ï¼ŒJDKä¾èµ–äºæ“ä½œç³»ç»Ÿä¸­çš„çº¿ç¨‹è°ƒåº¦ç¨‹åºæ¥è¿›è¡Œè°ƒåº¦ã€‚è€Œå¯¹äºè™šæ‹Ÿçº¿ç¨‹ï¼ŒJDKæœ‰è‡ªå·±çš„è°ƒåº¦å™¨ã€‚JDKçš„è°ƒåº¦å™¨æ²¡æœ‰ç›´æ¥å°†è™šæ‹Ÿçº¿ç¨‹åˆ†é…ç»™ç³»ç»Ÿçº¿ç¨‹ï¼Œè€Œæ˜¯å°†è™šæ‹Ÿçº¿ç¨‹åˆ†é…ç»™å¹³å°çº¿ç¨‹ï¼ˆç±»ä¼¼äºgoè¯­è¨€ä¸­G-M-Pæ¨¡å‹ï¼Œè™šæ‹Ÿçº¿ç¨‹å’Œå¹³å°çº¿ç¨‹æ˜¯M:Nè°ƒåº¦ï¼‰ã€‚JDK çš„è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦å™¨æ˜¯ä¸€ä¸ªåœ¨FIFOæ¨¡å¼ä¸‹è¿è¡Œçš„ç±»ä¼¼<code>ForkJoinPool</code>çš„çº¿ç¨‹æ± ã€‚è°ƒåº¦å™¨çš„å¹¶è¡Œæ•°é‡å–å†³äºè°ƒåº¦å™¨è™šæ‹Ÿçº¿ç¨‹çš„å¹³å°çº¿ç¨‹æ•°é‡ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯CPUå¯ç”¨æ ¸å¿ƒæ•°é‡ï¼Œä½†å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå±æ€§<code>jdk.virtualThreadScheduler.parallelism</code>è¿›è¡Œè°ƒæ•´ã€‚<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian202506141253036.png" alt="image.png"></p>
<p>JDK çš„è™šæ‹Ÿçº¿ç¨‹è°ƒåº¦å™¨æ˜¯ä¸€ä¸ªåœ¨ FIFO æ¨¡å¼ä¸‹è¿è¡Œçš„ç±»ä¼¼<code>ForkJoinPool</code>çš„çº¿ç¨‹æ± ã€‚è°ƒåº¦å™¨çš„å¹¶è¡Œæ•°é‡å–å†³äºè°ƒåº¦å™¨è™šæ‹Ÿçº¿ç¨‹çš„å¹³å°çº¿ç¨‹æ•°é‡ã€‚é»˜è®¤æƒ…å†µä¸‹æ˜¯ CPU å¯ç”¨æ ¸å¿ƒæ•°é‡ï¼Œä½†å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå±æ€§<code>jdk.virtualThreadScheduler.parallelism</code>è¿›è¡Œè°ƒæ•´ã€‚æ³¨æ„ï¼Œè¿™é‡Œçš„<code>ForkJoinPool</code>ä¸<code>ForkJoinPool.commonPool()</code>ä¸åŒï¼Œ<code>ForkJoinPool.commonPool()</code>ç”¨äºå®ç°å¹¶è¡Œæµï¼Œå¹¶åœ¨ LIFO æ¨¡å¼ä¸‹è¿è¡Œã€‚</p>
<p><code>ForkJoinPool</code>å’Œ<code>ExecutorService</code>çš„å·¥ä½œæ–¹å¼ä¸åŒï¼Œ<code>ExecutorService</code>æœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—æ¥å­˜å‚¨å®ƒçš„ä»»åŠ¡ï¼Œå…¶ä¸­çš„çº¿ç¨‹å°†æ¥æ”¶å¹¶å¤„ç†è¿™äº›ä»»åŠ¡ã€‚è€Œ<code>ForkJoinPool</code>çš„æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå½“ä¸€ä¸ªç”±çº¿ç¨‹è¿è¡Œçš„ä»»åŠ¡ç”Ÿæˆå¦ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œè¯¥ä»»åŠ¡è¢«æ·»åŠ åˆ°è¯¥çº¿ç¨‹çš„ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå½“æˆ‘ä»¬è¿è¡Œ<code>Parallel Stream</code>ï¼Œä¸€ä¸ªå¤§ä»»åŠ¡åˆ’åˆ†æˆä¸¤ä¸ªå°ä»»åŠ¡æ—¶å°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p>
<p>ä¸ºäº†é˜²æ­¢<strong>çº¿ç¨‹é¥¥é¥¿</strong>é—®é¢˜ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹çš„ç­‰å¾…é˜Ÿåˆ—ä¸­æ²¡æœ‰æ›´å¤šçš„ä»»åŠ¡æ—¶ï¼Œ<code>ForkJoinPool</code>è¿˜å®ç°äº†å¦ä¸€ç§æ¨¡å¼ï¼Œç§°ä¸º<strong>ä»»åŠ¡çªƒå–</strong>ï¼Œ ä¹Ÿå°±æ˜¯è¯´ï¼šé¥¥é¥¿çº¿ç¨‹å¯ä»¥ä»å¦ä¸€ä¸ªçº¿ç¨‹çš„ç­‰å¾…é˜Ÿåˆ—ä¸­çªƒå–ä¸€äº›ä»»åŠ¡ã€‚è¿™å’Œ Go G-M-P æ¨¡å‹ä¸­ work stealing æœºåˆ¶æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚<br><img src="https://shinerio.oss-cn-beijing.aliyuncs.com/obsidian202506141250621.png" alt="image.png"></p>
<h1>3. è™šæ‹Ÿçº¿ç¨‹æ‰§è¡Œ</h1>
<p>å½“è™šæ‹Ÿçº¿ç¨‹æ‰§è¡ŒI/Oæˆ–JDKä¸­çš„å…¶ä»–é˜»æ­¢æ“ä½œï¼ˆå¦‚<code>BlockingQueue.take()</code>æ—¶ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¼šä»å¹³å°çº¿ç¨‹ä¸Šå¸è½½ã€‚å½“é˜»å¡æ“ä½œå‡†å¤‡å®Œæˆæ—¶ï¼ˆä¾‹å¦‚ï¼Œç½‘ç»œ IO å·²æ”¶åˆ°å­—èŠ‚æ•°æ®ï¼‰ï¼Œè°ƒåº¦ç¨‹åºå°†è™šæ‹Ÿçº¿ç¨‹æŒ‚è½½åˆ°å¹³å°çº¿ç¨‹ä¸Šä»¥æ¢å¤æ‰§è¡Œã€‚</p>
<p>JDKä¸­çš„ç»å¤§å¤šæ•°é˜»å¡æ“ä½œä¼šå°†è™šæ‹Ÿçº¿ç¨‹ä»å¹³å°çº¿ç¨‹ä¸Šå¸è½½ï¼Œä½¿å¹³å°çº¿ç¨‹èƒ½å¤Ÿæ‰§è¡Œå…¶ä»–å·¥ä½œä»»åŠ¡ã€‚ä½†æ˜¯ï¼ŒJDKä¸­çš„å°‘æ•°é˜»å¡æ“ä½œä¸ä¼šå¸è½½è™šæ‹Ÿçº¿ç¨‹ï¼Œå› æ­¤ä¼šé˜»å¡å¹³å°çº¿ç¨‹ã€‚å› ä¸ºæ“ä½œç³»ç»Ÿçº§åˆ«ï¼ˆä¾‹å¦‚è®¸å¤šæ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼‰æˆ– JDKçº§åˆ«ï¼ˆä¾‹å¦‚<code>Object.wait()</code>ï¼‰çš„é™åˆ¶ã€‚è¿™äº›é˜»å¡æ“ä½œé˜»å¡å¹³å°çº¿ç¨‹æ—¶ï¼Œå°†é€šè¿‡æš‚æ—¶å¢åŠ å¹³å°çº¿ç¨‹çš„æ•°é‡æ¥è¡¥å¿å…¶ä»–å¹³å°çº¿ç¨‹é˜»å¡çš„æŸå¤±ã€‚å› æ­¤ï¼Œè°ƒåº¦å™¨çš„<code>ForkJoinPool</code>ä¸­çš„å¹³å°çº¿ç¨‹æ•°é‡å¯èƒ½ä¼šæš‚æ—¶è¶…è¿‡CPUå¯ç”¨æ ¸å¿ƒæ•°é‡ã€‚è°ƒåº¦å™¨å¯ç”¨çš„å¹³å°çº¿ç¨‹çš„æœ€å¤§æ•°é‡å¯ä»¥ä½¿ç”¨ç³»ç»Ÿå±æ€§<code>jdk.virtualThreadScheduler.maxPoolSize</code>è¿›è¡Œè°ƒæ•´ã€‚è¿™ä¸ªé˜»å¡è¡¥å¿æœºåˆ¶ä¸Go G-M-Pæ¨¡å‹ä¸­hand offæœºåˆ¶æœ‰å¼‚æ›²åŒå·¥ä¹‹å¦™ã€‚</p>
<p>åœ¨ä»¥ä¸‹ä¸¤ç§æƒ…å†µä¸‹ï¼Œè™šæ‹Ÿçº¿ç¨‹ä¼šè¢«å›ºå®šåˆ°è¿è¡Œå®ƒçš„å¹³å°çº¿ç¨‹ï¼Œåœ¨é˜»å¡æ“ä½œæœŸé—´æ— æ³•å¸è½½è™šæ‹Ÿçº¿ç¨‹ï¼š</p>
<ol>
<li>å½“åœ¨<code>synchronized</code>å—æˆ–æ–¹æ³•ä¸­æ‰§è¡Œä»£ç æ—¶ã€‚</li>
<li>å½“æ‰§è¡Œ<code>native</code>æ–¹æ³•æˆ–foreign functionæ—¶ã€‚<br>è™šæ‹Ÿçº¿ç¨‹è¢«å›ºå®šä¸ä¼šå½±å“ç¨‹åºè¿è¡Œçš„æ­£ç¡®æ€§ï¼Œä½†å®ƒå¯èƒ½ä¼šå½±å“ç³»ç»Ÿçš„å¹¶å‘åº¦å’Œååé‡ã€‚å¦‚æœè™šæ‹Ÿçº¿ç¨‹<strong>åœ¨è¢«å›ºå®šæ—¶</strong>æ‰§è¡ŒI/Oæˆ–<code>BlockingQueue.take()</code>Â ç­‰é˜»å¡æ“ä½œï¼Œåˆ™è´Ÿè´£è¿è¡Œå®ƒçš„å¹³å°çº¿ç¨‹åœ¨æ“ä½œæœŸé—´ä¼šè¢«é˜»å¡ã€‚å¦‚æœè™šæ‹Ÿçº¿ç¨‹<strong>æ²¡æœ‰è¢«å›ºå®š</strong>ï¼Œé‚£ä¼šæ‰§è¡ŒI/Oç­‰é˜»å¡æ“ä½œæ—¶ä¼šä»å¹³å°çº¿ç¨‹ä¸Šå¸è½½ã€‚</li>
</ol>
<h1>4. ä¼˜ç¼ºç‚¹</h1>
<h2>4.1. ä¼˜ç‚¹</h2>
<ul>
<li><strong>éå¸¸è½»é‡çº§</strong>ï¼šå¯ä»¥åœ¨å•ä¸ªçº¿ç¨‹ä¸­åˆ›å»ºæˆç™¾ä¸Šåƒä¸ªè™šæ‹Ÿçº¿ç¨‹è€Œä¸ä¼šå¯¼è‡´è¿‡å¤šçš„çº¿ç¨‹åˆ›å»ºå’Œä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚</li>
<li><strong>ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹</strong>ï¼š è™šæ‹Ÿçº¿ç¨‹å¯ä»¥ç®€åŒ–å¼‚æ­¥ç¼–ç¨‹ï¼Œä½¿ä»£ç æ›´æ˜“äºç†è§£å’Œç»´æŠ¤ã€‚å®ƒå¯ä»¥å°†å¼‚æ­¥ä»£ç ç¼–å†™å¾—æ›´åƒåŒæ­¥ä»£ç ï¼Œé¿å…äº†å›è°ƒåœ°ç‹±ï¼ˆCallback Hellï¼‰ã€‚</li>
<li><strong>å‡å°‘èµ„æºå¼€é”€</strong>ï¼š ç”±äºè™šæ‹Ÿçº¿ç¨‹æ˜¯ç”± JVM å®ç°çš„ï¼Œå®ƒèƒ½å¤Ÿæ›´é«˜æ•ˆåœ°åˆ©ç”¨åº•å±‚èµ„æºï¼Œä¾‹å¦‚ CPU å’Œå†…å­˜ã€‚è™šæ‹Ÿçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢æ¯”å¹³å°çº¿ç¨‹æ›´è½»é‡ï¼Œå› æ­¤èƒ½å¤Ÿæ›´å¥½åœ°æ”¯æŒé«˜å¹¶å‘åœºæ™¯ã€‚</li>
</ul>
<h2>4.2. ç¼ºç‚¹</h2>
<ul>
<li><strong>ä¸é€‚ç”¨äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡</strong>ï¼š è™šæ‹Ÿçº¿ç¨‹é€‚ç”¨äºI/Oå¯†é›†å‹ä»»åŠ¡ï¼Œä½†ä¸é€‚ç”¨äºè®¡ç®—å¯†é›†å‹ä»»åŠ¡ï¼Œå› ä¸ºå¯†é›†å‹è®¡ç®—å§‹ç»ˆéœ€è¦CPUèµ„æºä½œä¸ºæ”¯æŒã€‚</li>
<li><strong>ä¸æŸäº›ç¬¬ä¸‰æ–¹åº“ä¸å…¼å®¹</strong>ï¼š è™½ç„¶è™šæ‹Ÿçº¿ç¨‹è®¾è®¡æ—¶è€ƒè™‘äº†ä¸ç°æœ‰ä»£ç çš„å…¼å®¹æ€§ï¼Œä½†æŸäº›ä¾èµ–å¹³å°çº¿ç¨‹ç‰¹æ€§çš„ç¬¬ä¸‰æ–¹åº“å¯èƒ½ä¸å®Œå…¨å…¼å®¹è™šæ‹Ÿçº¿ç¨‹ã€‚</li>
</ul>
<h1>5. åˆ›å»ºè™šæ‹Ÿçº¿ç¨‹</h1>
<pre><code class="language-java">Thread thread1 = Thread.ofVirtual().start(() -&gt; {  
    try {  
        TimeUnit.SECONDS.sleep(1);  
    } catch (InterruptedException ignored) {  
    }  
    System.out.println(&quot;Virtual Thread 1 is running&quot;);  
});  
  
Thread thread2 = Thread.startVirtualThread(() -&gt; {  
    try {  
        TimeUnit.SECONDS.sleep(2);  
    } catch (InterruptedException ignored) {  
    }  
    System.out.println(&quot;Virtual Thread 2 is running&quot;);  
});  
  
try (var virtualThreadPerTaskExecutor = Executors.newVirtualThreadPerTaskExecutor()) {  
    virtualThreadPerTaskExecutor.submit(() -&gt; {  
        try {  
            TimeUnit.SECONDS.sleep(3);  
        } catch (InterruptedException ignored) {  
        }  
        System.out.println(&quot;Virtual Thread 3 is running&quot;);  
    });  
}  
  
ThreadFactory factory = Thread.ofVirtual().factory();  
Thread thread4 = factory.newThread(() -&gt; {  
    try {  
        TimeUnit.SECONDS.sleep(4);  
    } catch (InterruptedException ignored) {  
    }  
    System.out.println(&quot;Virtual Thread 4 is running&quot;);  
});  
thread4.start();  
  
thread1.join();  
thread2.join();  
thread4.join();
</code></pre>
<h1>6. è™šæ‹Ÿçº¿ç¨‹å¸è½½å®éªŒ</h1>
<h2>6.1. sleepå¸è½½</h2>
<pre><code class="language-java">var threads = IntStream.range(0, 5).mapToObj(index -&gt; Thread.ofVirtual().unstarted(() -&gt; {  
    System.out.println(Thread.currentThread());  
    try {  
        Thread.sleep(10);  
    } catch (InterruptedException e) {  
        throw new RuntimeException(e);  
    }  
    System.out.println(Thread.currentThread());  
})).toList();  
  
threads.forEach(Thread::start);  
for (Thread thread : threads) {  
    thread.join();  
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°è™šæ‹Ÿçº¿ç¨‹åœ¨sleepå‰åéƒ½åˆ‡æ¢äº†å®é™…å·¥ä½œçš„å¹³å°çº¿ç¨‹</p>
<pre><code class="language-text">VirtualThread[&lt;span class=&quot;tag&quot;&gt;#32&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-1
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#34&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-3
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#33&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-2
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#35&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-4
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#36&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-5
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#34&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-4
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#35&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-8
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#32&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-1
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#36&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-7
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#33&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-7
</code></pre>
<p>è™šæ‹Ÿçº¿ç¨‹ sleep æ—¶çœŸæ­£è°ƒç”¨çš„æ–¹æ³•æ˜¯Â <code>Continuation.yield</code>ï¼Œä¼šå°†å½“å‰è™šæ‹Ÿçº¿ç¨‹çš„å †æ ˆç”±å¹³å°çº¿ç¨‹çš„å †æ ˆè½¬ç§»åˆ°Javaå †å†…å­˜ï¼Œç„¶åå°†å…¶ä»–å°±ç»ªè™šæ‹Ÿçº¿ç¨‹çš„å †æ ˆç”±Javaå †ä¸­æ‹·è´åˆ°å½“å‰å¹³å°çº¿ç¨‹çš„å †æ ˆä¸­ç»§ç»­æ‰§è¡Œã€‚</p>
<blockquote>
<p>[!note]<br>æ‰§è¡Œ IO æˆ–<code>BlockingQueue.take()</code>Â ç­‰é˜»å¡æ“ä½œæ—¶ä¼šè·Ÿ sleep ä¸€æ ·å¯¼è‡´è™šæ‹Ÿçº¿ç¨‹åˆ‡æ¢ã€‚è™šæ‹Ÿçº¿ç¨‹çš„åˆ‡æ¢ä¹Ÿæ˜¯ä¸€ä¸ªç›¸å¯¹è€—æ—¶çš„æ“ä½œï¼Œä½†æ˜¯ä¸å¹³å°çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸æ¯”ï¼Œè¿˜æ˜¯è½»é‡å¾ˆå¤šçš„</p>
</blockquote>
<p>åœ¨synchronizedä»£ç å—ä¸­è¿è¡Œçš„è™šæ‹Ÿçº¿ç¨‹ä¸ä¼šå‘ç”Ÿå¸è½½</p>
<pre><code class="language-java">var threads = IntStream.range(0, 5).mapToObj(index -&gt; Thread.ofVirtual().unstarted(() -&gt; {  
    synchronized (JDK21FeatureTest.class) {  
        System.out.println(Thread.currentThread());  
        try {  
            Thread.sleep(10);  
        } catch (InterruptedException e) {  
            throw new RuntimeException(e);  
        }  
        System.out.println(Thread.currentThread());  
    }  
})).toList();  
  
threads.forEach(Thread::start);  
for (Thread thread : threads) {  
    thread.join();  
}
</code></pre>
<p>æ‰§è¡Œç»“æœ</p>
<pre><code class="language-text">VirtualThread[&lt;span class=&quot;tag&quot;&gt;#35&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-3
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#35&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-3
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#37&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-5
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#37&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-5
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#36&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-4
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#36&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-4
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#34&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-2
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#34&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-2
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#33&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-1
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#33&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-1
</code></pre>
<p><code>synchronized</code>ä»£ç å—å€ŸåŠ©å†…ç½®é”ï¼ˆç›‘è§†å™¨é”ï¼‰æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚å½“ä¸€ä¸ªçº¿ç¨‹è¿›å…¥<code>synchronized</code>ä»£ç å—æ—¶ï¼Œå®ƒä¼šè·å–å¯¹åº”çš„é”ï¼Œè¦æ˜¯é”è¢«å…¶ä»–çº¿ç¨‹å ç”¨ï¼Œè¯¥çº¿ç¨‹å°±ä¼šè¢«<strong>é˜»å¡</strong>ã€‚è¿™ç§é˜»å¡æ˜¯ç”±æ“ä½œç³»ç»Ÿå†…æ ¸æ¥å¤„ç†çš„ï¼Œä¼šä½¿çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°é”è¢«é‡Šæ”¾ã€‚å¯ä»¥&lt;font color=&quot;<span class="tag">#ff0000</span>&quot;&gt;ä½¿ç”¨ReentrantLockæ›¿ä»£</font>ã€‚</p>
<h2>6.2. IOå¸è½½</h2>
<pre><code class="language-java">var threads = IntStream.range(0, 5).mapToObj(index -&gt; Thread.ofVirtual().unstarted(() -&gt; {  
    System.out.println(Thread.currentThread());  
    try {  
        HttpRequest request = HttpRequest.newBuilder()  
                .uri(URI.create(&quot;https://localhost:5000/account&quot;))  
                .GET()  
                .build();  
        MTLSHttpClientTest.getHttpClient().send(request, HttpResponse.BodyHandlers.ofString());  
    } catch (Exception ignored) {  
    }  
    System.out.println(Thread.currentThread());  
})).toList();  
  
threads.forEach(Thread::start);  
for (Thread thread : threads) {  
    thread.join();  
}
</code></pre>
<p>æ‰§è¡Œç»“æœ</p>
<pre><code class="language-text">VirtualThread[&lt;span class=&quot;tag&quot;&gt;#35&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-2
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#34&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-1
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#36&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-3
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#37&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-4
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#38&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-4
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#37&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-2
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#34&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-3
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#38&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-2
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#36&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-10
VirtualThread[&lt;span class=&quot;tag&quot;&gt;#35&lt;/span&gt;]/runnable@ForkJoinPool-1-worker-11
</code></pre>
<h1>7. æ€§èƒ½æµ‹è¯•</h1>
<h2>7.1. IOå¯†é›†å‹</h2>
<p>åº”ç”¨ç¨‹åºç¬¦åˆä¸‹é¢ä¸¤ç‚¹ç‰¹å¾ï¼Œä½¿ç”¨è™šæ‹Ÿçº¿ç¨‹å¯ä»¥æ˜¾è‘—æé«˜ç¨‹åºååé‡ï¼š</p>
<ul>
<li>ç¨‹åºå¹¶å‘ä»»åŠ¡æ•°é‡å¾ˆé«˜ã€‚</li>
<li>IOå¯†é›†å‹ã€å·¥ä½œè´Ÿè½½ä¸å— CPU çº¦æŸã€‚<br>è™šæ‹Ÿçº¿ç¨‹æœ‰åŠ©äºæé«˜æœåŠ¡ç«¯åº”ç”¨ç¨‹åºçš„ååé‡ï¼Œå› ä¸ºæ­¤ç±»åº”ç”¨ç¨‹åºå¤§éƒ¨åˆ†éƒ½æ˜¯CRUDä¸šåŠ¡ï¼Œä¸”æœ‰å¤§é‡å¹¶å‘ï¼Œè€Œä¸”è¿™äº›ä»»åŠ¡é€šå¸¸ä¼šæœ‰å¤§é‡çš„IOç­‰å¾…ã€‚</li>
</ul>
<pre><code class="language-java">@Test  
public void testPerformance() {  
    AtomicInteger threadNum = new AtomicInteger(0);  
    // å¼€å¯çº¿ç¨‹ ç»Ÿè®¡å¹³å°çº¿ç¨‹æ•°  
    ScheduledExecutorService scheduledExecutorService = Executors.newScheduledThreadPool(1);  
    scheduledExecutorService.scheduleAtFixedRate(() -&gt; {  
        ThreadMXBean threadBean = ManagementFactory.getThreadMXBean();  
        ThreadInfo[] threadInfo = threadBean.dumpAllThreads(false, false);  
        if (threadInfo.length &gt; threadNum.get()) {  
            threadNum.set(threadInfo.length);  
        }  
    }, 10, 10, TimeUnit.MILLISECONDS);  
  
    long start = System.currentTimeMillis();  
    // é™åˆ¶è™šæ‹Ÿçº¿ç¨‹ä½¿ç”¨çš„å¹³å°çº¿ç¨‹æ•°é‡
    // System.setProperty(&quot;jdk.virtualThreadScheduler.parallelism&quot;, &quot;4&quot;);
    // è™šæ‹Ÿçº¿ç¨‹  
    // ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();  
    // ä½¿ç”¨å¹³å°çº¿ç¨‹  
    ExecutorService executor =  Executors.newFixedThreadPool(1000);  
    for (int i = 0; i &lt; 10000; i++) {  
        executor.submit(() -&gt; {  
            try {  
                // çº¿ç¨‹ç¡çœ  0.5 sï¼Œæ¨¡æ‹Ÿä¸šåŠ¡å¤„ç†  
                TimeUnit.MILLISECONDS.sleep(500);  
            } catch (InterruptedException ignored) {  
            }  
        });  
    }  
    executor.close();  
    System.out.printf(&quot;totalMillisï¼š%dms\tmax platform thread/os thread num: %d\n&quot;, System.currentTimeMillis() - start, threadNum.get());  
}
</code></pre>
<p>è™šæ‹Ÿçº¿ç¨‹æµ‹è¯•ç»“æœ</p>
<ul>
<li>ä¸åŒå¹³å°çº¿ç¨‹æ•°é‡å¯¹ç»“æœå½±å“ä¸å¤§</li>
</ul>
<pre><code class="language-txt"># é™åˆ¶è™šæ‹Ÿçº¿ç¨‹ä½¿ç”¨çš„å¹³å°çº¿ç¨‹æ•°é‡
# System.setProperty(&quot;jdk.virtualThreadScheduler.parallelism&quot;, &quot;4&quot;);  
# ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();
totalMillisï¼š850ms	max platform thread/os thread num: 19

totalMillisï¼š980ms	max platform thread/os thread num: 27
</code></pre>
<p>å¹³å°çº¿ç¨‹æµ‹è¯•ç»“æœ</p>
<pre><code class="language-txt">totalMillisï¼š25362ms   max platform thread/os thread num: 214

totalMillisï¼š5247ms    max platform thread/os thread num: 1014

totalMillisï¼š2895ms    max platform thread/os thread num: 2014

totalMillisï¼š8038ms      max platform thread/os thread num: 9895
</code></pre>
<h2>7.2. è®¡ç®—å¯†é›†å‹</h2>
<p>å°†ä¸Šè¿°ä»£ç æ›¿æ¢æˆcpuå¯†é›†å‹çš„æŒ‡æ•°è¿ç®—ï¼Œå¯ä»¥å‘ç°è®¡ç®—å¯†é›†å‹ä»»åŠ¡ä½¿ç”¨å’ŒCPUæ ¸å¿ƒæ•°2å€å·¦å³çš„å¹³å°çº¿ç¨‹æ•°ä¼šæœ‰æ›´å¥½çš„æ•ˆæœã€‚å¦‚æœæˆ‘ä»¬é™åˆ¶è™šæ‹Ÿçº¿ç¨‹ä½¿ç”¨çš„å¹³å°çº¿ç¨‹æ•°é‡ï¼Œä¼šçœ‹åˆ°ä»»åŠ¡å¤„ç†æ—¶é—´å¤§å¤§å¢åŠ ï¼Œè¯´æ˜è®¡ç®—å¯†é›†å‹ä»»åŠ¡è¿˜æ˜¯ä¾èµ–åº•å±‚å¹³å°çº¿ç¨‹ã€‚</p>
<blockquote>
<p>å¦‚æœå¹³å°çº¿ç¨‹æ•°å¢åŠ ï¼Œå¯èƒ½ä¼šåŠ å‰§çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œåè€Œé€‚å¾—å…¶åã€‚</p>
</blockquote>
<pre><code class="language-java">for (int i = 0; i &lt; 10000; i++) {  
    executor.submit(() -&gt; {  
        Random random = new Random();  
        for (int j = 0; j &lt; 100000; j++) {  
            // æ¨¡æ‹Ÿä¸€äº›å·¥ä½œ  
            Math.pow(random.nextInt(100), random.nextInt(10));  
        }  
    });  
}
</code></pre>
<p>è™šæ‹Ÿçº¿ç¨‹æµ‹è¯•ç»“æœ</p>
<ul>
<li>ä¸åŒå¹³å°çº¿ç¨‹æ•°é‡å¯¹æµ‹è¯•ç»“æœå½±å“å¾ˆå¤§</li>
</ul>
<pre><code class="language-text"># é™åˆ¶è™šæ‹Ÿçº¿ç¨‹ä½¿ç”¨çš„å¹³å°çº¿ç¨‹æ•°é‡
# System.setProperty(&quot;jdk.virtualThreadScheduler.parallelism&quot;, &quot;4&quot;);  
# ExecutorService executor = Executors.newVirtualThreadPerTaskExecutor();
totalMillisï¼š23099ms	max platform thread/os thread num: 19

totalMillisï¼š3657ms	max platform thread/os thread num: 26
</code></pre>
<p>å¹³å°çº¿ç¨‹æµ‹è¯•ç»“æœ</p>
<pre><code class="language-text"># ExecutorService executor = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors());
totalMillisï¼š3703ms	max platform thread/os thread num: 26

# ExecutorService executor = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors() * 2);
totalMillisï¼š3147ms	max platform thread/os thread num: 38

totalMillisï¼š3138ms	max platform thread/os thread num: 1014

totalMillisï¼š9340ms	max platform thread/os thread num: 9404
</code></pre>
<h1>8. ref</h1>
<p><a href="https://zhuanlan.zhihu.com/p/669327999">https://zhuanlan.zhihu.com/p/669327999</a><br><a href="https://www.zhihu.com/question/536743167">https://www.zhihu.com/question/536743167</a><br><a href="https://javaguide.cn/java/new-features/java19.html">https://javaguide.cn/java/new-features/java19.html</a></p>
}
    </section>
</article>
            </div>
        </main>
        <footer class="page-footer">
            <div class="container">
                <p>&copy; 2026 Shinerio's Blog. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <script>
        // Theme switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const themeToggle = document.getElementById('theme-toggle');
            const body = document.getElementById('theme-body');

            // Check for saved theme preference or respect OS preference
            const savedTheme = localStorage.getItem('theme');
            const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');

            // Set initial theme
            if (savedTheme === 'dark' || (!savedTheme && prefersDarkScheme.matches)) {
                body.setAttribute('data-theme', 'dark');
            } else {
                body.removeAttribute('data-theme'); // light theme
            }

            // Toggle theme function
            function toggleTheme() {
                if (body.getAttribute('data-theme') === 'dark') {
                    body.removeAttribute('data-theme');
                    localStorage.setItem('theme', 'light');
                } else {
                    body.setAttribute('data-theme', 'dark');
                    localStorage.setItem('theme', 'dark');
                }
            }

            // Add event listener to theme toggle button
            themeToggle.addEventListener('click', toggleTheme);

            // Listen for OS theme changes
            prefersDarkScheme.addEventListener('change', function(e) {
                if (!localStorage.getItem('theme')) {
                    if (e.matches) {
                        body.setAttribute('data-theme', 'dark');
                    } else {
                        body.removeAttribute('data-theme');
                    }
                }
            });

            // Search functionality
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const searchResults = document.getElementById('search-results');
            const searchSuggestions = document.getElementById('search-suggestions');
            const searchTypeRadios = document.querySelectorAll('input[name="search-type"]');

            if (searchInput && searchButton) {
                let searchData = null;

                // Load search data
                async function loadSearchData() {
                    try {
                        const response = await fetch('./assets/js/search-data.json');
                        if (response.ok) {
                            searchData = await response.json();
                        } else {
                            console.error('Failed to load search data:', response.status);
                        }
                    } catch (error) {
                        console.error('Error loading search data:', error);
                    }
                }

                // Initialize search data
                loadSearchData();

                // Debounce function to limit search calls
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }

                // Get selected search type
                function getSelectedSearchType() {
                    const selectedRadio = document.querySelector('input[name="search-type"]:checked');
                    return selectedRadio ? selectedRadio.value : 'all';
                }

                // Perform search
                function performSearch(query) {
                    if (!searchData || !query.trim()) {
                        searchResults.innerHTML = '';
                        searchSuggestions.innerHTML = '';
                        return;
                    }

                    const queryTerms = query.toLowerCase().split(/\s+/).filter(term => term.length > 0);
                    const searchType = getSelectedSearchType();

                    if (queryTerms.length === 0) {
                        searchResults.innerHTML = '';
                        return;
                    }

                    const results = [];

                    // Search through articles
                    searchData.articles.forEach(article => {
                        let score = 0;
                        let snippet = '';

                        // Get content based on search type
                        const lowerTitle = article.title.toLowerCase();
                        const lowerContent = article.content.toLowerCase();
                        const lowerTags = article.tags.join(' ').toLowerCase();

                        queryTerms.forEach(term => {
                            switch(searchType) {
                                case 'title':
                                    // Only title matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    break;
                                case 'content':
                                    // Only content matches count (fixed to exclude title matches)
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    break;
                                case 'all':
                                default:
                                    // Both title and content matches count
                                    if (lowerTitle.includes(term)) {
                                        score += 10;
                                    }
                                    if (lowerContent.includes(term)) {
                                        score += 1;
                                    }
                                    // Tag matches get medium-high score
                                    if (lowerTags.includes(term)) {
                                        score += 5;
                                    }
                                    break;
                            }
                        });

                        if (score > 0) {
                            // Generate snippet based on search type
                            let content = '';

                            if (searchType === 'title') {
                                // For title-only search, show title content
                                content = article.title.substring(0, 200);
                            } else if (searchType === 'content') {
                                // For content-only search, show content excerpt
                                content = article.content.substring(0, 200);
                            } else {
                                // For all search, show content with title as context
                                content = article.content.substring(0, 200);
                            }

                            // Find first occurrence of query term in content for snippet
                            queryTerms.forEach(term => {
                                let searchIn = content.toLowerCase();
                                if (searchType === 'title') {
                                    searchIn = lowerTitle;
                                } else if (searchType === 'content') {
                                    searchIn = lowerContent;
                                }

                                const index = searchIn.indexOf(term);
                                if (index !== -1) {
                                    // Expand snippet around the match
                                    let start, end;
                                    if (searchType === 'title') {
                                        start = Math.max(0, index - 15);
                                        end = Math.min(content.length, index + term.length + 35);
                                    } else {
                                        start = Math.max(0, index - 30);
                                        end = Math.min(content.length, index + term.length + 70);
                                    }

                                    content = (start > 0 ? '...' : '') +
                                              content.substring(start, end) +
                                              (end < (searchType === 'title' ? article.title.length : article.content.length) ? '...' : '');

                                    // Highlight the term in the snippet
                                    const searchContent = searchType === 'title' ? article.title : article.content;
                                    const adjustedIndex = searchType === 'title' ?
                                        Math.min(index, article.title.length - 1) :
                                        Math.min(index, article.content.length - 1);

                                    content = content.replace(
                                        new RegExp(`(${escapeRegExp(term)})`, 'gi'),
                                        '<mark>$1</mark>'
                                    );
                                }
                            });

                            results.push({
                                article: article,
                                score: score,
                                snippet: content
                            });
                        }
                    });

                    // Sort results by score
                    results.sort((a, b) => b.score - a.score);

                    // Display results
                    displaySearchResults(results);
                }

                // Display search results
                function displaySearchResults(results) {
                    if (results.length === 0) {
                        searchResults.innerHTML = '<p class="no-results">æœªæ‰¾åˆ°åŒ¹é…çš„æ–‡ç« </p>';
                        return;
                    }

                    const resultsHTML = results.map(result => `
                        <div class="search-result-item">
                            <h3 class="search-result-title">
                                <a href="./${result.article.slug}.html">${highlightQueryTerms(result.article.title, document.querySelector('#search-input').value)}</a>
                            </h3>
                            <div class="search-result-meta">
                                ${result.article.tags.map(tag => `<span class="tag">#${tag}</span>`).join('')}
                            </div>
                            <p class="search-result-excerpt">${result.snippet}</p>
                        </div>
                    `).join('');

                    searchResults.innerHTML = resultsHTML;
                }

                // Highlight query terms in text
                function highlightQueryTerms(text, query) {
                    if (!query.trim()) return text;

                    const queryTerms = query.split(/\s+/).filter(term => term.length > 0);
                    let highlightedText = text;

                    queryTerms.forEach(term => {
                        const regex = new RegExp(`(${escapeRegExp(term)})`, 'gi');
                        highlightedText = highlightedText.replace(regex, '<mark>$1</mark>');
                    });

                    return highlightedText;
                }

                // Escape special regex characters
                function escapeRegExp(string) {
                    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                }

                // Event listener for search button
                searchButton.addEventListener('click', function() {
                    const query = searchInput.value;
                    performSearch(query);
                });

                // Event listener for Enter key
                searchInput.addEventListener('keypress', function(event) {
                    if (event.key === 'Enter') {
                        const query = searchInput.value;
                        performSearch(query);
                    }
                });

                // Add debounced input handler for live search (optional)
                const debouncedSearch = debounce(function() {
                    const query = searchInput.value;
                    performSearch(query);
                }, 300);

                searchInput.addEventListener('input', debouncedSearch);

                // Add event listeners for search type radios
                searchTypeRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const query = searchInput.value;
                        if (query.trim()) {
                            performSearch(query);
                        }
                    });
                });
            }
        });
    </script>
</body>
</html>